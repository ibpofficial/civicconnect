<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicConnect Pro - Advanced</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ANIMATE.CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1e293b; 
            overflow: hidden;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Leaflet Custom */
        .leaflet-container { 
            z-index: 1; 
            font-family: inherit;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .leaflet-popup-content-wrapper { 
            border-radius: 16px; 
            padding: 0; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content { 
            margin: 0; 
            width: 300px !important; 
        }
        
        /* Marker */
        .marker-pin {
            width: 36px; 
            height: 36px; 
            border-radius: 50% 50% 50% 0;
            position: absolute; 
            transform: rotate(-45deg);
            left: 50%; 
            top: 50%; 
            margin: -20px 0 0 -20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        
        .marker-pin::after {
            content: ''; 
            width: 20px; 
            height: 20px; 
            margin: 8px 0 0 8px;
            background: #fff; 
            position: absolute; 
            border-radius: 50%;
        }
        
        .marker-icon { 
            position: absolute; 
            font-size: 14px; 
            left:0; 
            right:0; 
            margin: 10px auto; 
            text-align: center; 
            transform: rotate(45deg); 
            z-index: 10; 
            color: white; 
            font-weight: bold;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-fade-in { 
            animation: fadeIn 0.4s ease-out; 
        }
        
        .animate-slide-up { 
            animation: slideUp 0.4s ease-out; 
        }
        
        .animate-pulse { 
            animation: pulse 2s infinite; 
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Loader dots */
        .loader-dots { 
            display: inline-flex; 
            gap: 6px; 
        }
        
        .loader-dots div { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: currentColor; 
            animation: bounce 1.4s infinite ease-in-out both; 
        }
        
        .loader-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loader-dots div:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce { 
            0%, 80%, 100% { transform: scale(0); } 
            40% { transform: scale(1); } 
        }
        
        /* Custom scrollbar */
        .scroll-smooth::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .scroll-smooth::-webkit-scrollbar-track { 
            background: rgba(241, 245, 249, 0.5); 
            border-radius: 10px;
        }
        
        .scroll-smooth::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border-radius: 10px; 
        }
        
        .scroll-smooth::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); 
        }
        
        /* Safe area for mobile */
        .pb-safe { 
            padding-bottom: env(safe-area-inset-bottom, 0); 
        }
        
        /* Online indicator */
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(255, 65, 108, 0.3);
        }
        
        /* Chat bubble */
        .chat-bubble {
            max-width: 75%;
            border-radius: 20px;
            padding: 12px 16px;
            margin: 6px 0;
            position: relative;
            word-wrap: break-word;
        }
        
        .chat-bubble.sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .chat-bubble.received {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1e293b;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            width: fit-content;
            border-bottom-left-radius: 5px;
            align-items: center;
        }
        
        .typing-indicator span {
            width: 7px;
            height: 7px;
            background: #64748b;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing { 
            0%, 80%, 100% { transform: scale(0); } 
            40% { transform: scale(1); } 
        }
        
        /* Gradient backgrounds */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }
        
        .gradient-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        /* Shimmer loading */
        .shimmer {
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.4) 50%, 
                rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Floating action button */
        .fab {
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        /* Report card */
        .report-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        }
        
        .report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .report-card:hover::before {
            opacity: 1;
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Like button animation */
        .like-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .like-button.active {
            color: #ef4444;
            transform: scale(1.2);
        }
        
        .like-button:hover:not(.active) {
            color: #ef4444;
            transform: scale(1.1);
        }
        
        /* Comment button animation */
        .comment-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .comment-button:hover {
            color: #3b82f6;
            transform: scale(1.1);
        }
        
        /* Delete button animation */
        .delete-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .delete-button:hover {
            color: #ef4444;
            transform: scale(1.1);
        }
        
        /* Message button animation */
        .message-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .message-button:hover {
            color: #8b5cf6;
            transform: scale(1.1);
        }
        
        /* Navigation hover effects */
        .nav-item {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-gradient);
            transition: width 0.3s ease;
        }
        
        .nav-item:hover::after {
            width: 100%;
        }
        
        /* Input focus effects */
        .input-focus {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .input-focus:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        /* Button hover effects */
        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-hover::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-hover:hover::before {
            width: 300px;
            height: 300px;
        }
        
        /* Avatar pulse */
        .avatar-pulse {
            position: relative;
        }
        
        .avatar-pulse::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 2px solid transparent;
            background: linear-gradient(135deg, #667eea, #764ba2) border-box;
            -webkit-mask: 
                linear-gradient(#fff 0 0) padding-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: pulse 2s infinite;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
    </style>
</head>
<body class="h-screen flex flex-col relative overflow-hidden">
    <!-- Animated background elements -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
        <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 1s;"></div>
        <div class="absolute top-3/4 left-3/4 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 2s;"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="authScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
        <div class="max-w-md w-full p-8 text-center animate__animated animate__fadeInUp">
            <div class="w-20 h-20 gradient-primary rounded-2xl mx-auto flex items-center justify-center text-white text-3xl shadow-2xl mb-6 animate__animated animate__pulse animate__infinite">
                <i class="fas fa-city"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2 animate__animated animate__fadeIn">CivicConnect Pro</h1>
            <p class="text-slate-300 mb-8 text-lg animate__animated animate__fadeIn animate__delay-1s">Smart City Reporting Platform</p>
            
            <div class="space-y-6 animate__animated animate__fadeInUp animate__delay-1s">
                <div class="relative">
                    <input type="text" id="loginName" class="w-full px-6 py-4 rounded-2xl bg-white/10 backdrop-blur-sm border border-white/20 text-white placeholder-slate-300 focus:ring-2 focus:ring-purple-500 outline-none transition-all duration-300 input-focus" placeholder="Enter your name...">
                    <i class="fas fa-user absolute right-4 top-4 text-slate-300"></i>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setRole('citizen')" id="btnCit" class="py-4 bg-white/10 backdrop-blur-sm text-white font-bold rounded-2xl border border-white/20 transition-all duration-300 btn-hover group">
                        <i class="fas fa-user-friends mr-2 group-hover:scale-110 transition-transform"></i> Citizen
                    </button>
                    <button onclick="setRole('authority')" id="btnAuth" class="py-4 bg-white/10 backdrop-blur-sm text-white font-bold rounded-2xl border border-white/20 transition-all duration-300 btn-hover group">
                        <i class="fas fa-shield-alt mr-2 group-hover:scale-110 transition-transform"></i> Authority
                    </button>
                </div>
                <button onclick="handleLogin()" class="w-full py-4 gradient-primary text-white font-bold rounded-2xl shadow-2xl shadow-purple-500/30 transition-all duration-300 transform hover:scale-[1.02] active:scale-95 btn-hover group">
                    <span class="group-hover:tracking-wider transition-all">Enter Platform</span>
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </button>
            </div>
            <p class="text-xs text-slate-400 mt-8 animate__animated animate__fadeIn animate__delay-2s">Config: chatok-38a07 (Firebase)</p>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div id="appLayout" class="hidden flex-1 flex overflow-hidden">
        <!-- Sidebar (Desktop) -->
        <aside class="hidden lg:flex w-72 glass border-r border-slate-200/50 flex-col z-20">
            <div class="h-20 flex items-center px-6 border-b border-slate-100/50">
                <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-white text-xl mr-3">
                    <i class="fas fa-city"></i>
                </div>
                <div>
                    <span class="font-bold text-xl tracking-tight gradient-text">CivicConnect</span>
                    <div class="text-xs text-slate-500">Smart City Platform</div>
                </div>
            </div>
            <nav class="p-6 space-y-2 flex-1">
                <button onclick="switchView('dashboard')" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl bg-gradient-to-r from-blue-50 to-purple-50 text-blue-600 font-semibold nav-item transition-all duration-300 group" id="nav-dashboard">
                    <i class="fas fa-chart-pie w-5 text-center text-lg group-hover:scale-110 transition-transform"></i>
                    <span>Dashboard</span>
                    <i class="fas fa-chevron-right ml-auto text-blue-300 text-sm group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button onclick="switchView('map')" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-600 hover:bg-slate-50/50 font-semibold nav-item transition-all duration-300 group" id="nav-map">
                    <i class="fas fa-map w-5 text-center text-lg group-hover:scale-110 transition-transform"></i>
                    <span>Live Map</span>
                    <i class="fas fa-chevron-right ml-auto text-slate-300 text-sm group-hover:translate-x-1 transition-transform opacity-0 group-hover:opacity-100"></i>
                </button>
                <button onclick="switchView('feed')" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-600 hover:bg-slate-50/50 font-semibold nav-item transition-all duration-300 group" id="nav-feed">
                    <i class="fas fa-stream w-5 text-center text-lg group-hover:scale-110 transition-transform"></i>
                    <span>Reports Feed</span>
                    <i class="fas fa-chevron-right ml-auto text-slate-300 text-sm group-hover:translate-x-1 transition-transform opacity-0 group-hover:opacity-100"></i>
                </button>
                <button onclick="switchView('leaderboard')" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-600 hover:bg-slate-50/50 font-semibold nav-item transition-all duration-300 group" id="nav-leaderboard">
                    <i class="fas fa-trophy w-5 text-center text-lg group-hover:scale-110 transition-transform"></i>
                    <span>Leaderboard</span>
                    <i class="fas fa-chevron-right ml-auto text-slate-300 text-sm group-hover:translate-x-1 transition-transform opacity-0 group-hover:opacity-100"></i>
                </button>
                <button onclick="switchView('community')" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-600 hover:bg-slate-50/50 font-semibold nav-item transition-all duration-300 group relative" id="nav-community">
                    <i class="fas fa-users w-5 text-center text-lg group-hover:scale-110 transition-transform"></i>
                    <span>Community</span>
                    <i class="fas fa-chevron-right ml-auto text-slate-300 text-sm group-hover:translate-x-1 transition-transform opacity-0 group-hover:opacity-100"></i>
                    <span id="communityNotification" class="notification-badge hidden"></span>
                </button>
                <button onclick="switchView('profile')" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-600 hover:bg-slate-50/50 font-semibold nav-item transition-all duration-300 group" id="nav-profile">
                    <i class="fas fa-user w-5 text-center text-lg group-hover:scale-110 transition-transform"></i>
                    <span>Profile</span>
                    <i class="fas fa-chevron-right ml-auto text-slate-300 text-sm group-hover:translate-x-1 transition-transform opacity-0 group-hover:opacity-100"></i>
                </button>
            </nav>
            <div class="p-6 border-t border-slate-100/50">
                <div class="flex items-center gap-4 relative">
                    <div class="relative avatar-pulse">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-lg" id="userAvatar">U</div>
                        <div id="userOnlineStatus" class="online-indicator"></div>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-bold text-slate-800" id="userName">User</div>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                            <span id="userRole">Citizen</span>
                            <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                            <span class="text-green-500 font-semibold">Online</span>
                        </div>
                    </div>
                    <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-all duration-300 group">
                        <i class="fas fa-moon group-hover:rotate-45 transition-transform"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 flex flex-col relative overflow-hidden mb-16 lg:mb-0">
            <header class="h-20 glass border-b border-slate-200/50 flex items-center justify-between px-6 lg:px-8 z-20 sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden w-12 h-12 rounded-xl glass border border-slate-200/50 flex items-center justify-center text-slate-600 hover:bg-slate-50/50 transition-all duration-300 group">
                        <i class="fas fa-bars group-hover:scale-110 transition-transform"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800" id="pageTitle">Dashboard</h2>
                        <p class="text-sm text-slate-500" id="pageSubtitle">Welcome back! Here's what's happening.</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Notifications -->
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="w-12 h-12 rounded-xl glass border border-slate-200/50 flex items-center justify-center text-slate-600 hover:bg-slate-50/50 transition-all duration-300 group relative">
                            <i class="fas fa-bell text-lg group-hover:animate__animated animate__swing"></i>
                            <span id="notificationCount" class="notification-badge hidden">0</span>
                        </button>
                        <div id="notificationPanel" class="absolute right-0 top-16 w-96 glass rounded-2xl shadow-2xl border border-slate-200/50 hidden z-50 max-h-96 overflow-y-auto animate__animated animate__fadeInDown">
                            <div class="p-5 border-b border-slate-100/50 flex items-center justify-between">
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg">Notifications</h3>
                                    <p class="text-xs text-slate-500">Recent updates</p>
                                </div>
                                <button onclick="markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">
                                    Mark all read
                                </button>
                            </div>
                            <div id="notificationList" class="p-2">
                                <!-- Notifications will appear here -->
                            </div>
                            <button onclick="clearNotifications()" class="w-full p-4 text-center text-sm text-slate-500 hover:bg-slate-50/50 border-t border-slate-100/50 transition-all duration-300">
                                <i class="fas fa-trash mr-2"></i>Clear All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Stats for Authorities -->
                    <div id="quickStats" class="hidden lg:flex items-center gap-6">
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">CRITICAL</div>
                            <div class="text-xl font-black text-red-600" id="quickCritical">0</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">IN PROGRESS</div>
                            <div class="text-xl font-black text-yellow-600" id="quickProgress">0</div>
                        </div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="hidden lg:block relative">
                        <input type="text" id="globalSearch" placeholder="Search reports, users..." 
                               class="w-64 pl-12 pr-4 py-3 bg-white/50 backdrop-blur-sm rounded-2xl border border-slate-200/50 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300 input-focus">
                        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    </div>
                    
                    <!-- New Report Button -->
                    <button onclick="openModal()" class="gradient-primary text-white px-6 py-3 rounded-2xl font-bold shadow-2xl shadow-purple-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95 btn-hover flex items-center gap-3 group">
                        <i class="fas fa-plus group-hover:rotate-90 transition-transform"></i>
                        <span class="hidden sm:inline">New Report</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 lg:p-8 scroll-smooth" id="mainScroll">
                <!-- Progress Bar -->
                <div id="loadingBar" class="fixed top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-purple-500 z-50" style="transform: translateX(-100%);"></div>
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="view-section space-y-8 animate-fade-in">
                    <!-- Welcome Banner -->
                    <div class="glass rounded-3xl p-8 shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-full -translate-y-32 translate-x-32"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-slate-800 mb-2">Welcome back, <span id="welcomeName" class="gradient-text">User</span>! ðŸ‘‹</h1>
                                    <p class="text-slate-600 text-lg">Here's what's happening in your city today.</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-slate-400 uppercase tracking-wider">ACTIVE USERS</div>
                                    <div class="text-4xl font-black gradient-text" id="activeUsersCount">0</div>
                                </div>
                            </div>
                            <div class="mt-6 flex items-center gap-4">
                                <div class="flex items-center gap-2 text-slate-600">
                                    <i class="fas fa-clock text-blue-500"></i>
                                    <span id="currentTime">Loading...</span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-600">
                                    <i class="fas fa-map-marker-alt text-green-500"></i>
                                    <span>New York City</span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-600">
                                    <i class="fas fa-bolt text-yellow-500"></i>
                                    <span id="liveReports">0 live reports</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass p-6 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total</div>
                                    <div class="text-2xl font-black text-slate-800" id="statTotal">0</div>
                                </div>
                            </div>
                            <div class="text-sm font-semibold text-slate-600">Total Reports</div>
                            <div class="progress-bar mt-3">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                        </div>
                        
                        <div class="glass p-6 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-yellow-600 flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pending</div>
                                    <div class="text-2xl font-black text-yellow-600" id="statPending">0</div>
                                </div>
                            </div>
                            <div class="text-sm font-semibold text-slate-600">Awaiting Action</div>
                            <div class="progress-bar mt-3">
                                <div class="progress-fill" style="width: 40%"></div>
                            </div>
                        </div>
                        
                        <div class="glass p-6 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Resolved</div>
                                    <div class="text-2xl font-black text-green-600" id="statResolved">0</div>
                                </div>
                            </div>
                            <div class="text-sm font-semibold text-slate-600">Completed Issues</div>
                            <div class="progress-bar mt-3">
                                <div class="progress-fill" style="width: 60%"></div>
                            </div>
                        </div>
                        
                        <div class="glass p-6 rounded-3xl shadow-lg card-hover gradient-primary text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-bold text-white/80 uppercase tracking-wider">Your XP</div>
                                    <div class="text-2xl font-black" id="statXP">0</div>
                                </div>
                            </div>
                            <div class="text-sm font-semibold text-white/90">Experience Points</div>
                            <div class="progress-bar mt-3 bg-white/20">
                                <div class="progress-fill bg-white" style="width: 30%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass p-8 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                    <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                                    Activity Trend
                                </h3>
                                <div class="flex gap-2">
                                    <button onclick="updateChartRange('week')" class="text-xs px-3 py-1.5 rounded-lg bg-blue-50 text-blue-600 font-semibold">Week</button>
                                    <button onclick="updateChartRange('month')" class="text-xs px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 font-semibold">Month</button>
                                    <button onclick="updateChartRange('year')" class="text-xs px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 font-semibold">Year</button>
                                </div>
                            </div>
                            <div class="h-72"><canvas id="mainChart"></canvas></div>
                        </div>
                        
                        <div class="glass p-8 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                    <i class="fas fa-chart-pie text-purple-500 text-2xl"></i>
                                    Issues by Category
                                </h3>
                                <div class="text-sm text-slate-500">
                                    <i class="fas fa-filter mr-2"></i>
                                    <span>Distribution</span>
                                </div>
                            </div>
                            <div class="h-72 relative">
                                <canvas id="pieChart"></canvas>
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                                    <div class="text-3xl font-black gradient-text" id="totalReportsChart">0</div>
                                    <div class="text-sm text-slate-500">Total Reports</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Activity & Mini Feed -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass p-8 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                    <i class="fas fa-bolt text-yellow-500 text-2xl"></i>
                                    Live Activity
                                    <span id="liveIndicator" class="w-3 h-3 bg-green-500 rounded-full animate-pulse ml-2"></span>
                                </h3>
                                <button onclick="refreshLiveActivity()" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-all duration-300 hover:rotate-180">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="liveActivity" class="space-y-4 max-h-80 overflow-y-auto">
                                <!-- Live activity items will appear here -->
                            </div>
                        </div>
                        
                        <div class="glass p-8 rounded-3xl shadow-lg card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                    <i class="fas fa-bell text-blue-500 text-2xl"></i>
                                    Recent Updates
                                </h3>
                                <button onclick="switchView('feed')" class="text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                    View All
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <div id="miniFeed" class="space-y-4">
                                <!-- Mini feed items will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MAP -->
                <div id="view-map" class="view-section hidden h-full flex flex-col rounded-3xl overflow-hidden shadow-2xl border border-slate-200/50 relative bg-gradient-to-br from-slate-50 to-blue-50 animate-fade-in" style="min-height: 600px;">
                    <div id="leafletMap" class="w-full h-full z-0 absolute inset-0"></div>
                    
                    <!-- Map Controls -->
                    <div class="absolute top-6 left-6 z-[400] flex flex-col gap-3">
                        <div class="glass rounded-2xl p-4 shadow-xl">
                            <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <i class="fas fa-filter text-blue-500"></i>
                                Filter Issues
                            </h4>
                            <div class="space-y-2">
                                <button onclick="filterMap('all')" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl bg-blue-50 text-blue-600 font-semibold hover:bg-blue-100 transition-all duration-300 group">
                                    <i class="fas fa-layer-group text-sm"></i>
                                    <span>All Issues</span>
                                    <span class="ml-auto text-xs bg-white px-2 py-1 rounded-lg" id="filterAllCount">0</span>
                                </button>
                                <button onclick="filterMap('Critical')" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl hover:bg-red-50 text-slate-600 hover:text-red-600 font-semibold transition-all duration-300 group">
                                    <i class="fas fa-skull-crossbones text-sm"></i>
                                    <span>Critical</span>
                                    <span class="ml-auto text-xs bg-white px-2 py-1 rounded-lg text-red-600" id="filterCriticalCount">0</span>
                                </button>
                                <button onclick="filterMap('High')" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl hover:bg-orange-50 text-slate-600 hover:text-orange-600 font-semibold transition-all duration-300 group">
                                    <i class="fas fa-exclamation-triangle text-sm"></i>
                                    <span>High Priority</span>
                                    <span class="ml-auto text-xs bg-white px-2 py-1 rounded-lg text-orange-600" id="filterHighCount">0</span>
                                </button>
                                <button onclick="filterMap('Pending')" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl hover:bg-yellow-50 text-slate-600 hover:text-yellow-600 font-semibold transition-all duration-300 group">
                                    <i class="fas fa-clock text-sm"></i>
                                    <span>Pending</span>
                                    <span class="ml-auto text-xs bg-white px-2 py-1 rounded-lg text-yellow-600" id="filterPendingCount">0</span>
                                </button>
                                <button onclick="filterMap('Resolved')" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl hover:bg-green-50 text-slate-600 hover:text-green-600 font-semibold transition-all duration-300 group">
                                    <i class="fas fa-check-circle text-sm"></i>
                                    <span>Resolved</span>
                                    <span class="ml-auto text-xs bg-white px-2 py-1 rounded-lg text-green-600" id="filterResolvedCount">0</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Online Users Panel -->
                        <div id="onlineUsersMap" class="glass rounded-2xl p-4 shadow-xl">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                    <i class="fas fa-user-friends text-green-500"></i>
                                    Online Now
                                </h4>
                                <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-lg" id="onlineCount">0</span>
                            </div>
                            <div id="onlineUsersList" class="flex gap-2">
                                <!-- Online users will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="absolute top-6 right-6 z-[400] flex flex-col gap-3">
                        <button onclick="state.mapMode='pick'; pickLocation();" class="glass px-5 py-3 rounded-2xl shadow-xl font-bold text-sm flex items-center gap-3 hover:scale-105 transition-all duration-300 group">
                            <i class="fas fa-map-marker-alt text-blue-500 group-hover:animate__animated animate__bounce"></i>
                            <span>Add Location</span>
                        </button>
                        <button onclick="centerMap()" class="glass px-5 py-3 rounded-2xl shadow-xl font-bold text-sm flex items-center gap-3 hover:scale-105 transition-all duration-300 group">
                            <i class="fas fa-crosshairs text-purple-500"></i>
                            <span>Center Map</span>
                        </button>
                        <button onclick="toggleMapLayers()" class="glass px-5 py-3 rounded-2xl shadow-xl font-bold text-sm flex items-center gap-3 hover:scale-105 transition-all duration-300 group">
                            <i class="fas fa-layer-group text-green-500"></i>
                            <span>Layers</span>
                        </button>
                    </div>
                    
                    <!-- Map Legend -->
                    <div class="absolute bottom-6 left-6 z-[400] glass rounded-2xl p-4 shadow-xl">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-key text-slate-500"></i>
                            Map Legend
                        </h4>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-red-500"></div>
                                <span class="text-xs text-slate-600">Critical</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-orange-500"></div>
                                <span class="text-xs text-slate-600">High</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                                <span class="text-xs text-slate-600">Normal</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-green-500"></div>
                                <span class="text-xs text-slate-600">Resolved</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Location -->
                    <div class="absolute bottom-6 right-6 z-[400] glass rounded-2xl p-4 shadow-xl">
                        <div class="text-sm font-bold text-slate-700 mb-1">Current View</div>
                        <div class="text-xs text-slate-500" id="mapCoordinates">40.7128Â° N, -74.0060Â° W</div>
                        <div class="text-xs text-slate-500">Zoom: <span id="mapZoom">13</span></div>
                    </div>
                </div>

                <!-- VIEW: FEED -->
                <div id="view-feed" class="view-section hidden max-w-6xl mx-auto space-y-8 pb-16 animate-fade-in">
                    <!-- Feed Header -->
                    <div class="glass rounded-3xl p-8 shadow-xl">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">Community Reports</h2>
                                <p class="text-slate-600">Browse and interact with city issues reported by citizens</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <input type="text" id="feedSearch" placeholder="Search reports..." 
                                           class="pl-12 pr-4 py-3 bg-white/50 backdrop-blur-sm rounded-2xl border border-slate-200/50 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300 input-focus w-64">
                                    <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                                </div>
                                <button onclick="refreshFeed()" class="w-12 h-12 rounded-2xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-all duration-300 hover:rotate-180">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-slate-50/50 rounded-2xl">
                            <div class="flex items-center gap-4">
                                <select onchange="filterFeed(this.value)" class="glass px-4 py-2.5 rounded-xl border border-slate-200/50 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300">
                                    <option value="all">All Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Resolved">Resolved</option>
                                </select>
                                <select onchange="sortFeed(this.value)" class="glass px-4 py-2.5 rounded-xl border border-slate-200/50 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="votes">Most Votes</option>
                                    <option value="comments">Most Comments</option>
                                    <option value="priority">Highest Priority</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 text-sm text-slate-600">
                                    <i class="fas fa-filter"></i>
                                    <span>Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> reports</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh(this.checked)">
                                    <label class="toggle-slider" for="autoRefresh"></label>
                                </div>
                                <label for="autoRefresh" class="text-sm text-slate-600 cursor-pointer">Auto-refresh</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports Feed -->
                    <div id="feedContainer" class="space-y-6">
                        <!-- Reports will be loaded here -->
                    </div>
                    
                    <!-- Loading More Indicator -->
                    <div id="loadMoreIndicator" class="hidden text-center py-8">
                        <div class="loader-dots text-blue-600 mb-4"><div></div><div></div><div></div></div>
                        <p class="text-sm text-slate-500">Loading more reports...</p>
                    </div>
                    
                    <!-- End of Feed Message -->
                    <div id="endOfFeed" class="hidden text-center py-12">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-2xl mx-auto mb-4">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">You're all caught up!</h3>
                        <p class="text-slate-600 mb-6">No more reports to show. Check back later for new updates.</p>
                        <button onclick="refreshFeed()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Feed
                        </button>
                    </div>
                </div>

                <!-- VIEW: LEADERBOARD -->
                <div id="view-leaderboard" class="view-section hidden max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <!-- Hero Banner -->
                    <div class="rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden gradient-primary">
                        <div class="relative z-10">
                            <h2 class="text-4xl font-black mb-3">Top Citizens</h2>
                            <p class="text-white/90 text-lg">Recognizing heroes keeping our city safe and clean.</p>
                        </div>
                        <div class="absolute -right-8 -bottom-8 text-9xl text-white/10">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="absolute -left-8 -top-8 text-9xl text-white/10">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                    
                    <!-- Leaderboard -->
                    <div class="glass rounded-3xl shadow-xl overflow-hidden">
                        <div class="p-6 border-b border-slate-100/50 flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-slate-800">Leaderboard</h3>
                                <p class="text-slate-500">Top contributors this month</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-sm text-slate-500">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <span>Points based on reports, votes & resolutions</span>
                                </div>
                                <select onchange="updateLeaderboardRange(this.value)" class="glass px-4 py-2 rounded-xl border border-slate-200/50 focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="month">This Month</option>
                                    <option value="week">This Week</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                        </div>
                        <div id="leaderboardList" class="divide-y divide-slate-100/50">
                            <!-- Leaderboard entries will appear here -->
                        </div>
                        
                        <!-- Your Position -->
                        <div id="yourPosition" class="hidden p-6 border-t border-slate-100/50 bg-gradient-to-r from-blue-50 to-purple-50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-xl font-bold">
                                        <span id="yourRank">-</span>
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-800">Your Position</div>
                                        <div class="text-sm text-slate-500" id="yourXP">0 XP Points</div>
                                    </div>
                                </div>
                                <button onclick="switchView('profile')" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                                    View Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: COMMUNITY -->
                <div id="view-community" class="view-section hidden max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <!-- Community Header -->
                    <div class="glass rounded-3xl p-8 shadow-xl">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">Community Hub</h2>
                                <p class="text-slate-600">Connect, collaborate, and make a difference together</p>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <div class="text-3xl font-black gradient-text" id="communityOnlineCount">0</div>
                                    <div class="text-sm text-slate-500">Online Now</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-black text-slate-800" id="communityTotalUsers">0</div>
                                    <div class="text-sm text-slate-500">Total Users</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="glass p-4 rounded-2xl text-center card-hover">
                                <div class="text-2xl font-black text-blue-600" id="communityReports">0</div>
                                <div class="text-xs text-slate-500 uppercase tracking-wider">Reports</div>
                            </div>
                            <div class="glass p-4 rounded-2xl text-center card-hover">
                                <div class="text-2xl font-black text-green-600" id="communityResolved">0</div>
                                <div class="text-xs text-slate-500 uppercase tracking-wider">Resolved</div>
                            </div>
                            <div class="glass p-4 rounded-2xl text-center card-hover">
                                <div class="text-2xl font-black text-purple-600" id="communityComments">0</div>
                                <div class="text-xs text-slate-500 uppercase tracking-wider">Comments</div>
                            </div>
                            <div class="glass p-4 rounded-2xl text-center card-hover">
                                <div class="text-2xl font-black text-yellow-600" id="communityVotes">0</div>
                                <div class="text-xs text-slate-500 uppercase tracking-wider">Votes</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Community Content -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Active Users -->
                        <div class="lg:col-span-1">
                            <div class="glass rounded-3xl p-6 shadow-xl card-hover">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                        <i class="fas fa-user-friends text-blue-500"></i>
                                        Active Users
                                    </h3>
                                    <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-lg" id="activeUsersCountBadge">0 online</span>
                                </div>
                                <div id="communityUsers" class="space-y-4 max-h-96 overflow-y-auto">
                                    <!-- Users will appear here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Rooms & Activity -->
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Chat Rooms -->
                            <div class="glass rounded-3xl p-6 shadow-xl card-hover">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                        <i class="fas fa-comments text-purple-500"></i>
                                        Chat Rooms
                                    </h3>
                                    <button onclick="openChatModal(null, 'global')" class="text-sm text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-2">
                                        <i class="fas fa-plus"></i>
                                        New Chat
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white cursor-pointer hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1" onclick="openChatModal(null, 'general')">
                                        <div class="flex items-center justify-between mb-3">
                                            <i class="fas fa-globe text-2xl"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full" id="generalChatCount">0</span>
                                        </div>
                                        <h5 class="font-bold text-lg mb-1">General Chat</h5>
                                        <p class="text-blue-100 text-sm">Discuss city issues openly</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white cursor-pointer hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1" onclick="openChatModal(null, 'resolved')">
                                        <div class="flex items-center justify-between mb-3">
                                            <i class="fas fa-check-circle text-2xl"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full" id="resolvedChatCount">0</span>
                                        </div>
                                        <h5 class="font-bold text-lg mb-1">Resolved Issues</h5>
                                        <p class="text-green-100 text-sm">Share success stories</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white cursor-pointer hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1" onclick="openChatModal(null, 'suggestions')">
                                        <div class="flex items-center justify-between mb-3">
                                            <i class="fas fa-lightbulb text-2xl"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full" id="suggestionsChatCount">0</span>
                                        </div>
                                        <h5 class="font-bold text-lg mb-1">Suggestions</h5>
                                        <p class="text-purple-100 text-sm">Improvement ideas</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl text-white cursor-pointer hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1" onclick="openChatModal(null, 'urgent')">
                                        <div class="flex items-center justify-between mb-3">
                                            <i class="fas fa-exclamation-triangle text-2xl"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full" id="urgentChatCount">0</span>
                                        </div>
                                        <h5 class="font-bold text-lg mb-1">Urgent Issues</h5>
                                        <p class="text-orange-100 text-sm">Critical matters only</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Community Activity -->
                            <div class="glass rounded-3xl p-6 shadow-xl card-hover">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                        <i class="fas fa-history text-yellow-500"></i>
                                        Recent Activity
                                    </h3>
                                    <button onclick="loadMoreActivity()" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">
                                        Load More
                                    </button>
                                </div>
                                <div id="communityActivity" class="space-y-4">
                                    <!-- Activity will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PROFILE -->
                <div id="view-profile" class="view-section hidden max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <!-- Profile Header -->
                    <div class="glass rounded-3xl shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-48 gradient-primary"></div>
                        <div class="relative z-10 p-8">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-6">
                                    <div class="relative">
                                        <div class="w-24 h-24 rounded-full bg-white p-2 shadow-2xl">
                                            <div class="w-full h-full rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-4xl font-bold text-white" id="profileAvatar">U</div>
                                        </div>
                                        <div id="profileOnlineStatus" class="online-indicator"></div>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-white mb-2" id="profileName">User Name</h2>
                                        <p class="text-white/80 text-sm font-medium uppercase tracking-wide" id="profileRole">Citizen</p>
                                        <div class="flex items-center gap-4 mt-4">
                                            <div class="flex items-center gap-2 text-white/90">
                                                <i class="fas fa-calendar-alt"></i>
                                                <span id="joinDate">Joined recently</span>
                                            </div>
                                            <div class="flex items-center gap-2 text-white/90">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span>New York City</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="editProfile()" class="glass px-6 py-3 rounded-2xl text-slate-700 font-bold hover:bg-white/90 transition-all duration-300 flex items-center gap-2">
                                    <i class="fas fa-edit"></i>
                                    Edit Profile
                                </button>
                            </div>
                            
                            <!-- Stats Cards -->
                            <div class="grid grid-cols-3 gap-6 mt-8">
                                <div class="glass p-6 rounded-2xl text-center card-hover">
                                    <div class="text-3xl font-black text-blue-600" id="profileReports">0</div>
                                    <div class="text-sm text-slate-600 font-semibold uppercase tracking-wider">Reports</div>
                                </div>
                                <div class="glass p-6 rounded-2xl text-center card-hover">
                                    <div class="text-3xl font-black text-yellow-600" id="profileXP">0</div>
                                    <div class="text-sm text-slate-600 font-semibold uppercase tracking-wider">XP Points</div>
                                </div>
                                <div class="glass p-6 rounded-2xl text-center card-hover">
                                    <div class="text-3xl font-black text-green-600" id="profileLevel">1</div>
                                    <div class="text-sm text-slate-600 font-semibold uppercase tracking-wider">Level</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Content -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- User Activity -->
                        <div class="glass p-8 rounded-3xl shadow-xl card-hover">
                            <h3 class="font-bold text-slate-800 text-xl mb-6 flex items-center gap-3">
                                <i class="fas fa-history text-blue-500"></i>
                                Recent Activity
                            </h3>
                            <div id="userActivity" class="space-y-4">
                                <!-- Activity items will be populated here -->
                            </div>
                            <button onclick="viewAllActivity()" class="w-full mt-6 p-3 text-center text-blue-600 hover:text-blue-700 font-semibold border-t border-slate-100/50">
                                View All Activity
                            </button>
                        </div>
                        
                        <!-- Badges Earned -->
                        <div class="glass p-8 rounded-3xl shadow-xl card-hover">
                            <h3 class="font-bold text-slate-800 text-xl mb-6 flex items-center gap-3">
                                <i class="fas fa-award text-yellow-500"></i>
                                Badges Earned
                            </h3>
                            <div id="userBadges" class="grid grid-cols-2 gap-4">
                                <!-- Badges will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports History -->
                    <div class="glass p-8 rounded-3xl shadow-xl card-hover">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                                <i class="fas fa-file-alt text-purple-500"></i>
                                Your Reports
                            </h3>
                            <div class="flex gap-2">
                                <button onclick="filterUserReports('all')" class="text-xs px-3 py-1.5 rounded-lg bg-blue-50 text-blue-600 font-semibold">All</button>
                                <button onclick="filterUserReports('pending')" class="text-xs px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 font-semibold">Pending</button>
                                <button onclick="filterUserReports('resolved')" class="text-xs px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 font-semibold">Resolved</button>
                            </div>
                        </div>
                        <div id="userReports" class="space-y-4">
                            <!-- User reports will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="lg:hidden fixed bottom-0 w-full glass border-t border-slate-200/50 flex justify-around p-2 z-30 pb-safe">
            <button onclick="switchView('dashboard')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item group" id="mob-dashboard">
                <i class="fas fa-chart-pie text-xl mb-1 group-hover:scale-110 transition-transform"></i>
                <span class="text-[10px] font-bold">Dash</span>
            </button>
            <button onclick="switchView('map')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item group" id="mob-map">
                <i class="fas fa-map text-xl mb-1 group-hover:scale-110 transition-transform"></i>
                <span class="text-[10px] font-bold">Map</span>
            </button>
            <button onclick="openModal()" class="flex flex-col items-center justify-center -mt-8">
                <div class="w-16 h-16 gradient-primary rounded-full flex items-center justify-center text-white shadow-2xl shadow-purple-500/30 fab">
                    <i class="fas fa-plus text-xl"></i>
                </div>
            </button>
            <button onclick="switchView('feed')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item group" id="mob-feed">
                <i class="fas fa-stream text-xl mb-1 group-hover:scale-110 transition-transform"></i>
                <span class="text-[10px] font-bold">Feed</span>
            </button>
            <button onclick="switchView('community')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item group relative" id="mob-community">
                <i class="fas fa-users text-xl mb-1 group-hover:scale-110 transition-transform"></i>
                <span class="text-[10px] font-bold">Community</span>
                <span id="mobCommunityNotification" class="notification-badge hidden"></span>
            </button>
        </nav>
    </div>

    <!-- REPORT MODAL (WIZARD) -->
    <div id="reportModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100/50 flex justify-between items-center glass sticky top-0 z-10">
                <div>
                    <h3 class="font-bold text-slate-800 text-xl">New Report</h3>
                    <p class="text-sm text-slate-500" id="stepIndicator">Step 1 of 4 â€¢ Select Category</p>
                </div>
                <button onclick="closeModal('reportModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all duration-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Step Progress Bar -->
                <div class="flex items-center justify-center mb-8">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">1</div>
                        <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-blue-300 mx-2"></div>
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">2</div>
                        <div class="w-24 h-1 bg-slate-200 mx-2"></div>
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-sm">3</div>
                        <div class="w-24 h-1 bg-slate-200 mx-2"></div>
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-sm">4</div>
                    </div>
                </div>
                
                <!-- Step 1: Category -->
                <div id="step-1" class="wizard-step">
                    <h4 class="text-lg font-bold text-slate-800 mb-6 text-center">What type of issue are you reporting?</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onclick="selectCategory('Infrastructure')" class="cat-btn p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 text-left group card-hover">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-road"></i>
                            </div>
                            <div class="font-bold text-slate-700 text-lg mb-2">Infrastructure</div>
                            <p class="text-sm text-slate-500">Roads, bridges, public buildings</p>
                        </button>
                        <button onclick="selectCategory('Sanitation')" class="cat-btn p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 text-left group card-hover">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-trash"></i>
                            </div>
                            <div class="font-bold text-slate-700 text-lg mb-2">Sanitation</div>
                            <p class="text-sm text-slate-500">Garbage, cleanliness, waste management</p>
                        </button>
                        <button onclick="selectCategory('Safety')" class="cat-btn p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 text-left group card-hover">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-white text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="font-bold text-slate-700 text-lg mb-2">Public Safety</div>
                            <p class="text-sm text-slate-500">Security, hazards, emergency</p>
                        </button>
                        <button onclick="selectCategory('Transport')" class="cat-btn p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 text-left group card-hover">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center text-white text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-bus"></i>
                            </div>
                            <div class="font-bold text-slate-700 text-lg mb-2">Transport</div>
                            <p class="text-sm text-slate-500">Traffic, public transport, parking</p>
                        </button>
                        <button onclick="selectCategory('Utilities')" class="cat-btn p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 text-left group card-hover">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-yellow-600 flex items-center justify-center text-white text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="font-bold text-slate-700 text-lg mb-2">Utilities</div>
                            <p class="text-sm text-slate-500">Water, electricity, internet</p>
                        </button>
                        <button onclick="selectCategory('Other')" class="cat-btn p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 text-left group card-hover">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-xl mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="font-bold text-slate-700 text-lg mb-2">Other</div>
                            <p class="text-sm text-slate-500">Any other issues</p>
                        </button>
                    </div>
                    <input type="hidden" id="selectedCategory">
                </div>

                <!-- Step 2: Details & Image -->
                <div id="step-2" class="wizard-step hidden">
                    <h4 class="text-lg font-bold text-slate-800 mb-6 text-center">Tell us more about the issue</h4>
                    <div class="space-y-6">
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-camera text-blue-500"></i>
                                Evidence Photo (Optional)
                            </label>
                            <div class="relative h-48 border-2 border-dashed border-slate-300 rounded-2xl bg-gradient-to-br from-slate-50 to-slate-100 hover:from-slate-100 hover:to-slate-200 transition-all duration-300 flex flex-col items-center justify-center cursor-pointer overflow-hidden group" 
                                 onclick="document.getElementById('inpImg').click()">
                                <input type="file" id="inpImg" accept="image/*" class="hidden" onchange="window.previewImage(this, 'imgPreview', 'uploadPlaceholder')">
                                <div id="uploadPlaceholder" class="text-center p-6">
                                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg mx-auto mb-4 text-blue-500 group-hover:scale-110 transition-transform">
                                        <i class="fas fa-camera text-2xl"></i>
                                    </div>
                                    <p class="text-sm text-slate-600 font-bold">Tap to upload photo</p>
                                    <p class="text-xs text-slate-500 mt-1">AI will analyze your image for better categorization</p>
                                </div>
                                <img id="imgPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                                <!-- AI Loading Overlay -->
                                <div id="aiLoader" class="absolute inset-0 bg-white/95 flex-col items-center justify-center hidden z-10">
                                    <div class="loader-dots text-blue-600 mb-4"><div></div><div></div><div></div></div>
                                    <span class="text-sm font-bold text-slate-700">AI Analyzing Image...</span>
                                    <p class="text-xs text-slate-500 mt-2">Detecting patterns and categorizing</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-align-left text-green-500"></i>
                                Description
                            </label>
                            <textarea id="inpDesc" rows="4" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300 input-focus" placeholder="Describe the issue in detail... Be specific about what needs to be fixed, when you noticed it, and any immediate concerns."></textarea>
                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <span>Be as detailed as possible for faster resolution</span>
                                <span id="descCharCount">0/1000</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Priority -->
                <div id="step-3" class="wizard-step hidden">
                    <h4 class="text-lg font-bold text-slate-800 mb-6 text-center">How urgent is this issue?</h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="setPriority('Low')" class="prio-btn flex flex-col items-center p-6 rounded-2xl border-2 border-slate-200 hover:border-green-500 hover:bg-green-50 transition-all duration-300 group card-hover" data-val="Low">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-green-100 to-green-50 flex items-center justify-center text-green-600 mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-check text-2xl"></i>
                                </div>
                                <div class="font-bold text-slate-700 text-lg mb-1">Low</div>
                                <p class="text-xs text-slate-500 text-center">Minor issue, no immediate threat</p>
                            </button>
                            <button onclick="setPriority('Normal')" class="prio-btn flex flex-col items-center p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 group card-hover" data-val="Normal">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-blue-100 to-blue-50 flex items-center justify-center text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-exclamation text-2xl"></i>
                                </div>
                                <div class="font-bold text-slate-700 text-lg mb-1">Normal</div>
                                <p class="text-xs text-slate-500 text-center">Standard priority issue</p>
                            </button>
                            <button onclick="setPriority('High')" class="prio-btn flex flex-col items-center p-6 rounded-2xl border-2 border-slate-200 hover:border-orange-500 hover:bg-orange-50 transition-all duration-300 group card-hover" data-val="High">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-orange-100 to-orange-50 flex items-center justify-center text-orange-600 mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                                </div>
                                <div class="font-bold text-slate-700 text-lg mb-1">High</div>
                                <p class="text-xs text-slate-500 text-center">Urgent attention needed</p>
                            </button>
                            <button onclick="setPriority('Critical')" class="prio-btn flex flex-col items-center p-6 rounded-2xl border-2 border-slate-200 hover:border-red-500 hover:bg-red-50 transition-all duration-300 group card-hover" data-val="Critical">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-red-100 to-red-50 flex items-center justify-center text-red-600 mb-4 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-skull-crossbones text-2xl"></i>
                                </div>
                                <div class="font-bold text-slate-700 text-lg mb-1">Critical</div>
                                <p class="text-xs text-slate-500 text-center">Emergency situation</p>
                            </button>
                        </div>
                        
                        <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-100 rounded-2xl p-4 mt-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-red-500 text-xl mt-1"></i>
                                <div>
                                    <div class="font-bold text-red-700 mb-1">Critical Issues</div>
                                    <p class="text-sm text-red-600">Use "Critical" only for emergencies requiring immediate action (e.g., structural damage, major safety hazards). Authorities will be notified instantly.</p>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="selectedPriority" value="Normal">
                    </div>
                </div>

                <!-- Step 4: Location & Review -->
                <div id="step-4" class="wizard-step hidden">
                    <h4 class="text-lg font-bold text-slate-800 mb-6 text-center">Finalize your report</h4>
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-100 rounded-2xl p-5">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-map-marker-alt text-blue-500 text-xl mt-1"></i>
                                <div>
                                    <div class="font-bold text-blue-700 mb-1">Location Accuracy</div>
                                    <p class="text-sm text-blue-600">Accurate location helps authorities find and resolve issues faster. Use the map to pinpoint the exact location.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-location-dot text-green-500"></i>
                                Location
                            </label>
                            <div class="flex gap-3">
                                <input id="inpLoc" type="text" class="flex-1 p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 outline-none text-slate-600" placeholder="Click 'Pick on Map' to select location..." readonly>
                                <button onclick="pickLocation()" class="px-6 gradient-primary text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                                    <i class="fas fa-map-marker-alt mr-2"></i> Pick on Map
                                </button>
                            </div>
                        </div>
                        
                        <!-- Review Summary -->
                        <div class="mt-8 p-6 bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl border border-slate-200">
                            <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-3">
                                <i class="fas fa-clipboard-check text-blue-500"></i>
                                Review Your Report
                            </h4>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl">
                                    <span class="text-slate-600">Category:</span>
                                    <span class="font-bold text-slate-800" id="reviewCategory">-</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl">
                                    <span class="text-slate-600">Priority:</span>
                                    <span class="font-bold" id="reviewPriority">-</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl">
                                    <span class="text-slate-600">Image:</span>
                                    <span class="font-bold text-slate-800" id="reviewImage">No image</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl">
                                    <span class="text-slate-600">Location:</span>
                                    <span class="font-bold text-slate-800" id="reviewLocation">Not selected</span>
                                </div>
                                <div class="mt-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-bolt text-green-500"></i>
                                        <div>
                                            <div class="font-bold text-green-700">Ready to Submit</div>
                                            <p class="text-sm text-green-600">Your report will be visible to authorities and other citizens immediately.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-slate-100/50 bg-slate-50/50 flex justify-between">
                <button onclick="prevStep()" id="btnBack" class="px-8 py-4 rounded-2xl font-bold text-slate-600 hover:bg-slate-200 transition-all duration-300 flex items-center gap-2 hidden">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </button>
                <button onclick="nextStep()" id="btnNext" class="px-10 py-4 gradient-primary text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105 ml-auto">
                    Next Step
                </button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="deleteModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
            <div class="p-6 border-b border-slate-100/50 flex justify-between items-center bg-white">
                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                    Delete Report
                </h3>
                <button onclick="closeModal('deleteModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all duration-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="text-center">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-red-100 to-red-50 flex items-center justify-center text-red-500 text-3xl mx-auto mb-4">
                        <i class="fas fa-trash"></i>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-2">Are you sure?</h4>
                    <p class="text-slate-600 mb-4">This action cannot be undone. The report will be permanently deleted from the database.</p>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center gap-3 p-3 bg-red-50 rounded-xl">
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                        <div class="text-sm text-red-600">All comments, votes, and associated data will be lost.</div>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-yellow-50 rounded-xl">
                        <i class="fas fa-users text-yellow-500"></i>
                        <div class="text-sm text-yellow-600">Other users will no longer be able to see this report.</div>
                    </div>
                </div>
                
                <input type="hidden" id="deleteReportId">
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal('deleteModal')" class="flex-1 px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-2xl font-bold transition-all duration-300">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" id="btnConfirmDelete" class="flex-1 px-6 py-3 gradient-danger text-white rounded-2xl font-bold shadow-lg shadow-red-500/30 transition-all duration-300 hover:scale-105">
                        Yes, Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- COMMENTS MODAL -->
    <div id="commentsModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100/50 flex justify-between items-center glass sticky top-0 z-10">
                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                    <i class="fas fa-comments text-blue-500"></i>
                    Comments
                </h3>
                <button onclick="closeModal('commentsModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all duration-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Comments will load here -->
                <div id="commentsList" class="space-y-4 mb-6"></div>
                
                <!-- Real-time typing indicator -->
                <div id="commentTypingIndicator" class="hidden mb-4">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span class="text-xs text-slate-500 ml-2">Someone is typing...</span>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100/50">
                <div class="flex gap-3">
                    <input type="text" id="newComment" class="flex-1 p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300 input-focus" placeholder="Add a comment..." 
                           oninput="showCommentTyping()">
                    <button onclick="postComment()" class="px-6 gradient-primary text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <input type="hidden" id="currentReportId">
        </div>
    </div>

    <!-- CHAT MODAL -->
    <div id="chatModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up flex flex-col h-[80vh]">
            <div class="p-6 border-b border-slate-100/50 flex justify-between items-center glass sticky top-0 z-10">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg" id="chatAvatar">C</div>
                        <div class="online-indicator"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg" id="chatTitle">Chat</h3>
                        <p class="text-sm text-slate-500 flex items-center gap-2">
                            <span id="chatSubtitle">Connected</span>
                            <span class="w-1 h-1 bg-green-500 rounded-full animate-pulse"></span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleChatTypingIndicator()" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all duration-300" title="Typing indicator">
                        <i class="fas fa-keyboard"></i>
                    </button>
                    <button onclick="closeModal('chatModal')" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all duration-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto scroll-smooth" id="chatMessages">
                <!-- Chat messages will appear here -->
            </div>
            <div class="p-6 border-t border-slate-100/50">
                <div class="flex gap-3">
                    <input type="text" id="chatInput" class="flex-1 p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all duration-300 input-focus" placeholder="Type your message..." 
                           onkeypress="if(event.key==='Enter') sendChatMessage()"
                           oninput="showChatTyping()">
                    <button onclick="sendChatMessage()" class="px-6 gradient-primary text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div id="typingIndicator" class="hidden mt-4">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span class="text-xs text-slate-500 ml-2" id="typingUser">Someone is typing...</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="chatTargetId">
            <input type="hidden" id="chatRoomType">
        </div>
    </div>

    <!-- RESOLUTION PROOF MODAL -->
    <div id="resolveModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
            <div class="p-6 border-b border-slate-100/50 flex justify-between items-center bg-white">
                <h3 class="font-bold text-slate-800 text-xl flex items-center gap-3">
                    <i class="fas fa-check-circle text-green-500"></i>
                    Resolve Issue
                </h3>
                <button onclick="closeModal('resolveModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all duration-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 uppercase tracking-wider">Update Status</label>
                    <select id="statusSelect" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 focus:ring-2 focus:ring-green-500 outline-none transition-all duration-300">
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-camera text-blue-500"></i>
                        Proof Photo (Optional)
                    </label>
                    <div class="relative h-40 border-2 border-dashed border-slate-300 rounded-2xl bg-gradient-to-br from-slate-50 to-slate-100 hover:from-slate-100 hover:to-slate-200 transition-all duration-300 flex flex-col items-center justify-center cursor-pointer overflow-hidden" onclick="document.getElementById('resImg').click()">
                        <input type="file" id="resImg" accept="image/*" class="hidden" onchange="window.previewImage(this, 'resImgPreview', 'resPlaceholder')">
                        <div id="resPlaceholder" class="text-center p-4">
                            <i class="fas fa-camera text-3xl text-slate-300 mb-3"></i>
                            <p class="text-sm text-slate-600 font-bold">Tap to upload proof</p>
                            <p class="text-xs text-slate-500 mt-1">Show before & after or completed work</p>
                        </div>
                        <img id="resImgPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-edit text-green-500"></i>
                        Resolution Notes
                    </label>
                    <textarea id="resNote" rows="3" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 focus:ring-2 focus:ring-green-500 outline-none transition-all duration-300" placeholder="Describe how the issue was resolved..."></textarea>
                </div>
                
                <input type="hidden" id="resolveId">
                
                <button onclick="confirmResolve()" id="btnConfirmResolve" class="w-full py-4 gradient-success text-white rounded-2xl font-bold shadow-lg shadow-green-500/30 transition-all duration-300 hover:scale-105">
                    Update Status
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-6 right-6 z-[100] glass rounded-2xl shadow-2xl p-5 transform translate-x-[200%] transition-transform duration-500 flex items-start gap-4 max-w-sm">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-xl" id="toastIconContainer">
            <i class="fas fa-info-circle" id="toastIcon"></i>
        </div>
        <div class="flex-1">
            <h4 id="toastTitle" class="font-bold text-slate-800 text-lg mb-1">Notice</h4>
            <p id="toastMsg" class="text-sm text-slate-600 leading-relaxed">Message will appear here</p>
            <div class="text-xs text-slate-500 mt-2" id="toastTime">Just now</div>
        </div>
        <button onclick="hideToast()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-800 transition-all duration-300">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, increment, arrayUnion, serverTimestamp, where, deleteDoc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, set, onDisconnect, onValue, push, remove, get, child } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // CONFIG (chatok-38a07)
        const firebaseConfig = {
            apiKey: "AIzaSyC6ImTLczrMo8m07fjYWVCeOjszrzgYw1w",
            authDomain: "chatok-38a07.firebaseapp.com",
            projectId: "chatok-38a07",
            storageBucket: "chatok-38a07.firebasestorage.app",
            messagingSenderId: "405598576994",
            appId: "1:405598576994:web:cdcb15ea806924753acc3b",
            databaseURL: "https://chatok-38a07-default-rtdb.firebaseio.com/"
        };
        const appId = 'civic-connect-reborn';

        // STATE
        const state = {
            user: null, role: 'citizen', reports: [], map: null, markers: [],
            mapMode: 'view', tempMarker: null, name: 'Anonymous',
            wizardStep: 1, currentFilter: 'all', activeMapFilter: 'all',
            comments: {}, userActivities: [], onlineUsers: {},
            notifications: [], unreadNotifications: 0,
            chatMessages: {}, activeChats: {}, typingUsers: {},
            userBadges: [], communityActivity: [],
            feedPage: 1, feedLimit: 10, isLoadingFeed: false,
            autoRefresh: true, lastUpdate: Date.now(),
            userReports: [], leaderboardRange: 'month'
        };

        // INIT FIREBASE
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // AUTH
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.warn("Auth fallback", e);
                state.user = { uid: 'guest-' + Date.now() }; 
                startListener(); 
                updateOnlineStatus();
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) { 
                state.user = user; 
                startListener(); 
                updateOnlineStatus();
            }
        });

        // CORE FUNCTIONS
        window.setRole = (r) => {
            state.role = r;
            const btnCit = document.getElementById('btnCit');
            const btnAuth = document.getElementById('btnAuth');
            
            if(r === 'citizen') {
                btnCit.className = "py-4 bg-white/20 backdrop-blur-sm text-white font-bold rounded-2xl border border-white/30 transition-all duration-300 btn-hover group";
                btnAuth.className = "py-4 bg-white/10 backdrop-blur-sm text-white font-bold rounded-2xl border border-white/20 transition-all duration-300 btn-hover group";
            } else {
                btnCit.className = "py-4 bg-white/10 backdrop-blur-sm text-white font-bold rounded-2xl border border-white/20 transition-all duration-300 btn-hover group";
                btnAuth.className = "py-4 bg-white/20 backdrop-blur-sm text-white font-bold rounded-2xl border border-white/30 transition-all duration-300 btn-hover group";
            }
        };

        window.handleLogin = () => {
            const name = document.getElementById('loginName').value || 'User';
            state.name = name;
            
            // Update all name displays
            document.getElementById('userName').innerText = name;
            document.getElementById('userRole').innerText = state.role.charAt(0).toUpperCase() + state.role.slice(1);
            document.getElementById('userAvatar').innerText = name[0];
            document.getElementById('profileName').innerText = name;
            document.getElementById('profileRole').innerText = state.role.charAt(0).toUpperCase() + state.role.slice(1);
            document.getElementById('profileAvatar').innerText = name[0];
            document.getElementById('welcomeName').innerText = name;
            
            // Show welcome animation
            document.getElementById('authScreen').classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appLayout').classList.remove('hidden');
                document.getElementById('appLayout').classList.add('animate__animated', 'animate__fadeIn');
                
                initMap();
                updateTime();
                setInterval(updateTime, 60000);
                
                // Show/hide authority features
                if(state.role === 'authority') {
                    document.getElementById('quickStats').classList.remove('hidden');
                }
                
                if(state.reports.length === 0) startListener();
                
                // Initialize online presence
                updateOnlineStatus();
                listenToOnlineUsers();
                listenToCommunityActivity();
                loadNotifications();
                loadUserBadges();
                
                // Request notification permission
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                // Start auto refresh
                if(state.autoRefresh) {
                    setInterval(refreshData, 30000); // Refresh every 30 seconds
                }
                
                // Add community activity for user join
                addCommunityActivity('user_joined', { name: state.name, role: state.role });
                
                // Show welcome toast
                showToast('Welcome to CivicConnect!', `Hello ${name}, ready to make a difference?`, 'success');
            }, 500);
        };

        window.switchView = (id) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // Update desktop navigation
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-purple-50', 'text-blue-600');
                el.classList.add('text-slate-600', 'hover:bg-slate-50/50');
            });
            
            const deskBtn = document.getElementById('nav-'+id);
            if(deskBtn) {
                deskBtn.classList.add('bg-gradient-to-r', 'from-blue-50', 'to-purple-50', 'text-blue-600');
                deskBtn.classList.remove('text-slate-600', 'hover:bg-slate-50/50');
            }

            // Update mobile navigation
            document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('text-blue-600', 'active'));
            const mobBtn = document.getElementById('mob-'+id);
            if(mobBtn) mobBtn.classList.add('text-blue-600', 'active');
            
            // Show the view
            const view = document.getElementById('view-'+id);
            view.classList.remove('hidden');
            view.classList.add('animate__animated', 'animate__fadeIn');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'map': 'Live Map',
                'feed': 'Reports Feed',
                'leaderboard': 'Leaderboard',
                'community': 'Community Hub',
                'profile': 'Profile'
            };
            
            const subtitles = {
                'dashboard': 'Welcome back! Here\'s what\'s happening.',
                'map': 'Explore and report city issues',
                'feed': 'Browse and interact with community reports',
                'leaderboard': 'Top contributors making a difference',
                'community': 'Connect, collaborate, and make change',
                'profile': 'Your activities and achievements'
            };
            
            document.getElementById('pageTitle').innerText = titles[id] || id.charAt(0).toUpperCase() + id.slice(1);
            document.getElementById('pageSubtitle').innerText = subtitles[id] || '';
            
            // View-specific actions
            if(id === 'map' && state.map) {
                setTimeout(() => {
                    state.map.invalidateSize();
                    if(state.activeMapFilter !== 'all') filterMap(state.activeMapFilter);
                    // Show online users on map
                    showOnlineUsersOnMap();
                    
                    // Update map coordinates display
                    updateMapCoordinates();
                }, 100);
            } else if(id === 'community') {
                loadCommunityUsers();
                updateCommunityActivity();
                // Clear community notification
                document.getElementById('communityNotification').classList.add('hidden');
                document.getElementById('mobCommunityNotification').classList.add('hidden');
            } else if(id === 'feed') {
                refreshFeed();
            } else if(id === 'profile') {
                loadUserReports();
            }
        };

        window.toggleSidebar = () => {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('flex');
            sidebar.classList.toggle('animate__animated', 'animate__slideInLeft');
        };

        // THEME TOGGLE
        window.toggleTheme = () => {
            const html = document.documentElement;
            const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.classList.remove(currentTheme);
            html.classList.add(newTheme);
            
            // Update button icon
            const themeIcon = document.querySelector('[onclick="toggleTheme()"] i');
            themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Show toast
            showToast('Theme Changed', `Switched to ${newTheme} mode`, 'info');
        };

        // TIME UPDATER
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const dateString = now.toLocaleDateString([], {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            
            document.getElementById('currentTime').innerText = `${timeString} â€¢ ${dateString}`;
        }

        // NOTIFICATIONS SYSTEM
        window.toggleNotifications = () => {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('hidden');
            panel.classList.toggle('animate__animated');
            panel.classList.toggle('animate__fadeInDown');
            
            if(!panel.classList.contains('hidden')) {
                // Mark all as read when opening
                markAllAsRead();
            }
        };

        window.markAllAsRead = async () => {
            try {
                if(state.user?.uid) {
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, state.user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if(userSnap.exists()) {
                        const notifications = userSnap.data().notifications || [];
                        const updatedNotifications = notifications.map(n => ({...n, read: true}));
                        
                        await updateDoc(userRef, { notifications: updatedNotifications });
                        state.unreadNotifications = 0;
                        updateNotificationBadge();
                    }
                }
            } catch(e) {
                console.error(e);
            }
        };

        window.clearNotifications = async () => {
            try {
                if(state.user?.uid) {
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, state.user.uid);
                    await updateDoc(userRef, { notifications: [] });
                    state.notifications = [];
                    state.unreadNotifications = 0;
                    updateNotificationBadge();
                    document.getElementById('notificationList').innerHTML = `
                        <div class="text-center py-8">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-500 text-2xl mx-auto mb-4">
                                <i class="fas fa-bell-slash"></i>
                            </div>
                            <p class="text-slate-600">No notifications</p>
                        </div>
                    `;
                }
            } catch(e) {
                console.error(e);
            }
        };

        async function loadNotifications() {
            try {
                if(!state.user?.uid) return;
                
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, state.user.uid);
                const unsubscribe = onSnapshot(userRef, (docSnap) => {
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        state.notifications = data.notifications || [];
                        state.unreadNotifications = state.notifications.filter(n => !n.read).length;
                        updateNotificationBadge();
                        updateNotificationList();
                    } else {
                        // Create user document
                        setDoc(userRef, {
                            name: state.name,
                            role: state.role,
                            xp: 0,
                            notifications: [],
                            badges: [],
                            joinDate: serverTimestamp(),
                            lastActive: serverTimestamp()
                        });
                    }
                });
            } catch(e) {
                console.error(e);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationCount');
            const mobCommunityBadge = document.getElementById('mobCommunityNotification');
            const desktopCommunityBadge = document.getElementById('communityNotification');
            
            const count = state.unreadNotifications;
            
            if(count > 0) {
                badge.classList.remove('hidden');
                badge.textContent = count > 9 ? '9+' : count;
                
                // Also show on community button if notifications are community-related
                const communityNotifications = state.notifications.filter(n => 
                    n.type === 'chat' || n.type === 'community' || n.type === 'comment'
                ).length;
                
                if(communityNotifications > 0) {
                    mobCommunityBadge.classList.remove('hidden');
                    desktopCommunityBadge.classList.remove('hidden');
                    mobCommunityBadge.textContent = communityNotifications > 9 ? '9+' : communityNotifications;
                    desktopCommunityBadge.textContent = communityNotifications > 9 ? '9+' : communityNotifications;
                }
            } else {
                badge.classList.add('hidden');
            }
        }

        function updateNotificationList() {
            const list = document.getElementById('notificationList');
            if(state.notifications.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-500 text-2xl mx-auto mb-4">
                            <i class="fas fa-bell-slash"></i>
                        </div>
                        <p class="text-slate-600">No notifications yet</p>
                        <p class="text-xs text-slate-500 mt-1">We'll notify you about important updates</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = state.notifications.slice().reverse().map(notif => {
                const iconMap = {
                    'success': { icon: 'fa-check-circle', color: 'green' },
                    'error': { icon: 'fa-exclamation-circle', color: 'red' },
                    'warning': { icon: 'fa-exclamation-triangle', color: 'yellow' },
                    'info': { icon: 'fa-info-circle', color: 'blue' },
                    'chat': { icon: 'fa-comment', color: 'purple' },
                    'comment': { icon: 'fa-comment-dots', color: 'blue' },
                    'like': { icon: 'fa-heart', color: 'pink' }
                };
                
                const config = iconMap[notif.type] || { icon: 'fa-bell', color: 'blue' };
                const timeAgo = getTimeAgo(notif.timestamp);
                
                return `
                    <div class="p-4 hover:bg-slate-50/50 transition-all duration-300 rounded-2xl ${!notif.read ? 'bg-blue-50/50' : ''}">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-${config.color}-100 to-${config.color}-50 flex items-center justify-center text-${config.color}-600">
                                <i class="fas ${config.icon}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-slate-800">${notif.title}</div>
                                <p class="text-sm text-slate-600 mt-1">${notif.message}</p>
                                <div class="text-xs text-slate-400 mt-2 flex items-center gap-2">
                                    <i class="far fa-clock"></i>
                                    <span>${timeAgo}</span>
                                    ${!notif.read ? '<span class="w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addNotification(title, message, type = 'info', icon = null) {
            try {
                if(!state.user?.uid) return;
                
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, state.user.uid);
                const notification = {
                    title,
                    message,
                    type,
                    icon: icon || (type === 'success' ? 'fa-check-circle' : 
                                 type === 'error' ? 'fa-exclamation-circle' : 
                                 type === 'warning' ? 'fa-exclamation-triangle' : 'fa-bell'),
                    timestamp: Date.now(),
                    read: false
                };
                
                await updateDoc(userRef, {
                    notifications: arrayUnion(notification)
                });
                
                // Show toast for important notifications
                if(type === 'success' || type === 'error' || type === 'warning') {
                    showToast(title, message, type);
                }
                
                // Play notification sound (simulated)
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                    audio.volume = 0.3;
                    audio.play().catch(() => {});
                } catch(e) {}
                
                // Browser notification if permission granted
                if(Notification.permission === 'granted') {
                    new Notification(title, { 
                        body: message,
                        icon: '/favicon.ico'
                    });
                }
            } catch(e) {
                console.error(e);
            }
        }

        // ONLINE PRESENCE SYSTEM
        function updateOnlineStatus() {
            if(!state.user?.uid) return;
            
            const userStatusRef = ref(rtdb, 'status/' + state.user.uid);
            const isOfflineForDatabase = {
                state: 'offline',
                last_changed: Date.now(),
                name: state.name,
                role: state.role
            };
            
            const isOnlineForDatabase = {
                state: 'online',
                name: state.name,
                role: state.role,
                last_changed: Date.now(),
                avatar: state.name[0]
            };

            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    set(userStatusRef, isOnlineForDatabase);
                    onDisconnect(userStatusRef).set(isOfflineForDatabase);
                    
                    // Update UI
                    document.getElementById('userOnlineStatus').style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                    document.getElementById('profileOnlineStatus').style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                }
            });
        }

        function listenToOnlineUsers() {
            const userStatusRef = ref(rtdb, 'status');
            onValue(userStatusRef, (snapshot) => {
                const users = snapshot.val() || {};
                state.onlineUsers = {};
                
                Object.keys(users).forEach(uid => {
                    if(users[uid].state === 'online' && uid !== state.user?.uid) {
                        state.onlineUsers[uid] = users[uid];
                    }
                });
                
                updateOnlineUsersUI();
                showOnlineUsersOnMap();
            });
        }

        function updateOnlineUsersUI() {
            const onlineCount = Object.keys(state.onlineUsers).length;
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('communityOnlineCount').textContent = onlineCount;
            document.getElementById('activeUsersCount').textContent = onlineCount;
            document.getElementById('activeUsersCountBadge').textContent = `${onlineCount} online`;
            document.getElementById('communityTotalUsers').textContent = Object.keys(state.onlineUsers).length + 1; // +1 for current user
            
            // Update live reports count
            const liveReports = state.reports.filter(r => 
                Date.now() - r.timestamp < 3600000 // Last hour
            ).length;
            document.getElementById('liveReports').textContent = `${liveReports} live reports`;

            // Update community users list
            const usersList = document.getElementById('communityUsers');
            if(Object.keys(state.onlineUsers).length === 0) {
                usersList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-400 text-2xl mx-auto mb-4">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <p class="text-slate-600">No other users online</p>
                        <p class="text-xs text-slate-500 mt-1">Be the first to start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            usersList.innerHTML = Object.values(state.onlineUsers).map(user => `
                <div class="flex items-center gap-4 p-4 hover:bg-slate-50/50 rounded-2xl transition-all duration-300 cursor-pointer group" onclick="openChatModal('${user.name}', 'private')">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                            ${user.avatar || user.name[0]}
                        </div>
                        <div class="online-indicator"></div>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-slate-800">${user.name}</div>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                            <span class="capitalize">${user.role}</span>
                            <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                            <span class="text-green-500 font-semibold">Online</span>
                        </div>
                    </div>
                    <button class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-600 flex items-center justify-center transition-all duration-300 group-hover:scale-110">
                        <i class="fas fa-comment"></i>
                    </button>
                </div>
            `).join('');
        }

        function showOnlineUsersOnMap() {
            if(!state.map) return;
            
            // Remove existing user markers
            if(state.userMarkers) {
                state.userMarkers.forEach(marker => state.map.removeLayer(marker));
            }
            state.userMarkers = [];
            
            Object.values(state.onlineUsers).forEach(user => {
                // Generate random coordinates near the center for demo
                const lat = 40.7128 + (Math.random() - 0.5) * 0.05;
                const lng = -74.0060 + (Math.random() - 0.5) * 0.05;
                
                const icon = L.divIcon({
                    className: 'custom',
                    html: `
                        <div class="relative">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 border-2 border-white shadow-lg flex items-center justify-center text-white text-xs font-bold">
                                ${user.avatar || user.name[0]}
                            </div>
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
                        </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });
                
                const marker = L.marker([lat, lng], {icon})
                    .addTo(state.map)
                    .bindPopup(`
                        <div class="p-3">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold">
                                    ${user.avatar || user.name[0]}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">${user.name}</div>
                                    <div class="text-xs text-slate-500">${user.role}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-green-600 text-xs">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span>Online Now</span>
                            </div>
                            <button onclick="window.openChatModal('${user.name}', 'private')" class="w-full mt-3 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg font-bold transition-colors">
                                <i class="fas fa-comment mr-1"></i> Message
                            </button>
                        </div>
                    `);
                
                state.userMarkers.push(marker);
            });
        }

        // DELETE REPORT FUNCTIONALITY
        window.openDeleteModal = (reportId) => {
            document.getElementById('deleteReportId').value = reportId;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('animate__animated', 'animate__fadeIn');
        };

        window.confirmDelete = async () => {
            const reportId = document.getElementById('deleteReportId').value;
            const btn = document.getElementById('btnConfirmDelete');
            
            if(!reportId) {
                closeModal('deleteModal');
                return;
            }
            
            btn.innerHTML = '<div class="loader-dots text-white"><div></div><div></div><div></div></div>';
            btn.disabled = true;
            
            try {
                // Delete from Firestore
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/reports`, reportId));
                
                // Remove from state
                state.reports = state.reports.filter(r => r.id !== reportId);
                
                // Update UI
                updateUI();
                
                // Show success message
                showToast('Report Deleted', 'The report has been permanently deleted', 'success');
                
                // Close modal
                closeModal('deleteModal');
                
                // Add community activity
                await addCommunityActivity('report_deleted', { 
                    deletedBy: state.name,
                    timestamp: Date.now()
                });
                
            } catch(e) {
                console.error(e);
                showToast('Error', 'Failed to delete report', 'error');
            } finally {
                btn.innerHTML = 'Yes, Delete Permanently';
                btn.disabled = false;
            }
        };

        // ENHANCED LIKE SYSTEM WITH REAL-TIME UPDATES
        window.upvote = async (reportId) => {
            const report = state.reports.find(r => r.id === reportId);
            if(!report) return;
            
            // Check if user already voted
            if(report.voters && report.voters.includes(state.user?.uid)) {
                showToast('Already Voted', 'You can only vote once per report', 'info');
                return;
            }
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/reports`, reportId), {
                    upvotes: increment(1),
                    voters: arrayUnion(state.user?.uid || 'anon')
                });
                
                // Update local state immediately for instant feedback
                const reportIndex = state.reports.findIndex(r => r.id === reportId);
                if(reportIndex !== -1) {
                    state.reports[reportIndex].upvotes = (state.reports[reportIndex].upvotes || 0) + 1;
                    state.reports[reportIndex].voters = state.reports[reportIndex].voters || [];
                    state.reports[reportIndex].voters.push(state.user?.uid || 'anon');
                }
                
                // Update UI immediately
                updateFeedItemLikes(reportId, state.reports[reportIndex].upvotes, true);
                
                // Add XP for voting
                await addUserXP(5);
                
                // Add notification to report owner
                if(report.user !== state.name) {
                    await addNotification(
                        'New Upvote!',
                        `${state.name} liked your report about ${report.category}`,
                        'info',
                        'fa-heart'
                    );
                }
                
            } catch(e) {
                console.error(e);
                showToast('Error', 'Failed to upvote', 'error');
            }
        };

        function updateFeedItemLikes(reportId, newCount, isLiked) {
            // Update like button in feed
            const likeButtons = document.querySelectorAll(`[onclick="upvote('${reportId}')"]`);
            likeButtons.forEach(btn => {
                const countSpan = btn.querySelector('span');
                if(countSpan) {
                    countSpan.textContent = newCount;
                }
                if(isLiked) {
                    btn.classList.add('active');
                    btn.classList.remove('text-slate-500');
                    btn.classList.add('text-red-600');
                }
            });
            
            // Update like count in report cards
            const likeCounts = document.querySelectorAll(`[data-report-id="${reportId}"] .like-count`);
            likeCounts.forEach(el => {
                el.textContent = newCount;
            });
        }

        // ENHANCED COMMENTS SYSTEM WITH REAL-TIME TYPING INDICATOR
        window.openComments = async (reportId) => {
            document.getElementById('currentReportId').value = reportId;
            document.getElementById('newComment').value = '';
            
            // Load comments
            const report = state.reports.find(r => r.id === reportId);
            if(report && report.comments) {
                displayComments(report.comments);
            } else {
                document.getElementById('commentsList').innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-500 text-2xl mx-auto mb-4">
                            <i class="fas fa-comment-slash"></i>
                        </div>
                        <p class="text-slate-600">No comments yet</p>
                        <p class="text-xs text-slate-500 mt-1">Be the first to comment on this report</p>
                    </div>
                `;
            }
            
            document.getElementById('commentsModal').classList.remove('hidden');
            document.getElementById('commentsModal').classList.add('animate__animated', 'animate__fadeIn');
            
            // Listen for new comments in real-time
            listenToComments(reportId);
        };

        function showCommentTyping() {
            const indicator = document.getElementById('commentTypingIndicator');
            indicator.classList.remove('hidden');
            
            // Clear previous timeout
            if(window.commentTypingTimeout) {
                clearTimeout(window.commentTypingTimeout);
            }
            
            // Hide indicator after 2 seconds of no typing
            window.commentTypingTimeout = setTimeout(() => {
                indicator.classList.add('hidden');
            }, 2000);
        }

        function listenToComments(reportId) {
            // This would be implemented with real-time listeners
            // For now, we'll simulate with polling
            if(window.commentListener) {
                clearInterval(window.commentListener);
            }
            
            window.commentListener = setInterval(() => {
                const report = state.reports.find(r => r.id === reportId);
                if(report && report.comments) {
                    displayComments(report.comments);
                }
            }, 2000); // Check every 2 seconds
        }

        window.postComment = async () => {
            const reportId = document.getElementById('currentReportId').value;
            const commentText = document.getElementById('newComment').value.trim();
            
            if(!commentText) return;
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/reports`, reportId), {
                    comments: arrayUnion({
                        user: state.name,
                        text: commentText,
                        timestamp: Date.now(),
                        avatar: state.name[0]
                    })
                });
                
                document.getElementById('newComment').value = '';
                
                // Hide typing indicator
                document.getElementById('commentTypingIndicator').classList.add('hidden');
                
                // Add community activity
                await addCommunityActivity('comment_added', { reportId });
                
                // Add XP for commenting
                await addUserXP(10);
                
                // Update local state
                const report = state.reports.find(r => r.id === reportId);
                if(report) {
                    if(!report.comments) report.comments = [];
                    report.comments.push({
                        user: state.name,
                        text: commentText,
                        timestamp: Date.now(),
                        avatar: state.name[0]
                    });
                    displayComments(report.comments);
                }
                
                // Add notification to report owner
                if(report.user !== state.name) {
                    await addNotification(
                        'New Comment!',
                        `${state.name} commented on your report`,
                        'info',
                        'fa-comment'
                    );
                }
                
            } catch(e) {
                console.error(e);
                showToast('Error', 'Failed to post comment', 'error');
            }
        };

        function displayComments(comments) {
            if(!comments || comments.length === 0) {
                document.getElementById('commentsList').innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-500 text-2xl mx-auto mb-4">
                            <i class="fas fa-comment-slash"></i>
                        </div>
                        <p class="text-slate-600">No comments yet</p>
                        <p class="text-xs text-slate-500 mt-1">Be the first to comment on this report</p>
                    </div>
                `;
                return;
            }
            
            const sortedComments = comments.sort((a, b) => b.timestamp - a.timestamp);
            document.getElementById('commentsList').innerHTML = sortedComments.map(comment => {
                const timeAgo = getTimeAgo(comment.timestamp);
                const isOwnComment = comment.user === state.name;
                
                return `
                    <div class="flex gap-4 p-4 hover:bg-slate-50/50 rounded-2xl transition-all duration-300">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">
                                ${comment.avatar || comment.user[0]}
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold text-sm text-slate-700">${comment.user}</span>
                                    ${isOwnComment ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-2">You</span>' : ''}
                                </div>
                                <span class="text-xs text-slate-400">${timeAgo}</span>
                            </div>
                            <p class="text-sm text-slate-600 mt-2 leading-relaxed">${comment.text}</p>
                            <div class="flex items-center gap-4 mt-3">
                                <button class="text-xs text-slate-400 hover:text-blue-600 transition-colors">
                                    <i class="far fa-thumbs-up mr-1"></i> Like
                                </button>
                                <button class="text-xs text-slate-400 hover:text-blue-600 transition-colors">
                                    <i class="fas fa-reply mr-1"></i> Reply
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            const container = document.getElementById('commentsList');
            container.scrollTop = container.scrollHeight;
        }

        // MAP FUNCTIONS
        function initMap() {
            if(state.map) return;
            
            state.map = L.map('leafletMap', { 
                zoomControl: false,
                zoomAnimation: true,
                fadeAnimation: true,
                markerZoomAnimation: true
            }).setView([40.7128, -74.0060], 14);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19,
                id: 'mapbox/streets-v11'
            }).addTo(state.map);
            
            L.control.zoom({ 
                position: 'bottomright',
                zoomInTitle: 'Zoom in',
                zoomOutTitle: 'Zoom out'
            }).addTo(state.map);
            
            // Add scale control
            L.control.scale({ 
                imperial: true,
                metric: true,
                position: 'bottomleft'
            }).addTo(state.map);
            
            // Add map movement listener for coordinates
            state.map.on('move', updateMapCoordinates);
            state.map.on('zoom', updateMapCoordinates);
            
            state.map.on('click', (e) => {
                if(state.mapMode === 'pick') {
                    if(state.tempMarker) state.map.removeLayer(state.tempMarker);
                    state.tempMarker = L.marker(e.latlng, {
                        draggable: true,
                        icon: L.divIcon({
                            className: 'custom',
                            html: `
                                <div class="relative">
                                    <div class="marker-pin" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)"></div>
                                    <i class="fas fa-map-marker-alt marker-icon"></i>
                                    <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-white text-xs px-2 py-1 rounded-lg shadow-lg whitespace-nowrap">
                                        Drag to adjust
                                    </div>
                                </div>
                            `,
                            iconSize: [30, 42],
                            iconAnchor: [15, 42]
                        })
                    }).addTo(state.map);
                    
                    state.tempMarker.on('dragend', (e) => {
                        const lat = e.target.getLatLng().lat.toFixed(6);
                        const lng = e.target.getLatLng().lng.toFixed(6);
                        updateLocationInput(lat, lng);
                    });
                    
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    updateLocationInput(lat, lng);
                    
                    state.mapMode = 'view';
                    document.getElementById('leafletMap').style.cursor = '';
                    
                    showToast('Location Selected', 'Returning to report wizard', 'success');
                    
                    // Return to modal after 1 second
                    setTimeout(() => {
                        document.getElementById('reportModal').classList.remove('hidden');
                        state.wizardStep = 4;
                        updateWizardUI();
                        updateReviewSummary();
                    }, 1000);
                }
            });
        }

        function updateLocationInput(lat, lng) {
            document.getElementById('inpLoc').value = `${lat}, ${lng}`;
            document.getElementById('reviewLocation').innerText = `${lat}, ${lng}`;
            
            // Also show address (simulated)
            const address = `Near ${Math.random() > 0.5 ? 'Central Park' : 'Times Square'}, NYC`;
            document.getElementById('reviewLocation').innerText = `${address} (${lat}, ${lng})`;
        }

        function updateMapCoordinates() {
            if(!state.map) return;
            
            const center = state.map.getCenter();
            const zoom = state.map.getZoom();
            
            document.getElementById('mapCoordinates').textContent = 
                `${center.lat.toFixed(4)}Â° N, ${center.lng.toFixed(4)}Â° W`;
            document.getElementById('mapZoom').textContent = zoom;
        }

        window.centerMap = () => {
            if(!state.map) return;
            
            state.map.setView([40.7128, -74.0060], 14);
            showToast('Map Centered', 'Returned to default view', 'info');
        };

        window.toggleMapLayers = () => {
            showToast('Map Layers', 'Layer switching coming soon', 'info');
        };

        // WIZARD FUNCTIONS
        window.openModal = () => { 
            state.wizardStep = 1;
            // Reset form
            document.getElementById('selectedCategory').value = '';
            document.getElementById('inpDesc').value = '';
            document.getElementById('selectedPriority').value = 'Normal';
            document.getElementById('inpLoc').value = '';
            document.getElementById('inpImg').value = '';
            document.getElementById('imgPreview').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            
            // Reset UI
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.remove('border-2');
            });
            document.querySelectorAll('.prio-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50');
                btn.classList.remove('border-2');
            });
            
            updateWizardUI();
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportModal').classList.add('animate__animated', 'animate__fadeIn');
        };
        
        window.closeModal = (id) => { 
            const modal = document.getElementById(id);
            modal.classList.add('animate__animated', 'animate__fadeOut');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('animate__animated', 'animate__fadeOut');
            }, 300);
            
            if(id === 'reportModal') {
                state.mapMode = 'view';
                document.getElementById('leafletMap').style.cursor = '';
                if(state.tempMarker) {
                    state.map.removeLayer(state.tempMarker);
                    state.tempMarker = null;
                }
            } else if(id === 'chatModal') {
                // Clean up chat listeners
                if(state.chatUnsubscribe) {
                    state.chatUnsubscribe();
                }
            } else if(id === 'commentsModal') {
                // Clean up comment listener
                if(window.commentListener) {
                    clearInterval(window.commentListener);
                }
            }
        };

        window.selectCategory = (cat) => {
            document.getElementById('selectedCategory').value = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.remove('border-2');
                if(btn.textContent.includes(cat)) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-2');
                }
            });
            updateReviewSummary();
            
            // Auto-proceed to next step after 1 second
            setTimeout(() => {
                if(state.wizardStep === 1) {
                    nextStep();
                }
            }, 1000);
        };

        window.setPriority = (prio) => {
            document.getElementById('selectedPriority').value = prio;
            document.querySelectorAll('.prio-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50');
                btn.classList.remove('border-2');
                if(btn.dataset.val === prio) {
                    if(prio === 'Low') {
                        btn.classList.add('border-green-500', 'bg-green-50', 'border-2');
                    } else if(prio === 'Normal') {
                        btn.classList.add('border-blue-500', 'bg-blue-50', 'border-2');
                    } else if(prio === 'High') {
                        btn.classList.add('border-orange-500', 'bg-orange-50', 'border-2');
                    } else if(prio === 'Critical') {
                        btn.classList.add('border-red-500', 'bg-red-50', 'border-2');
                    }
                }
            });
            updateReviewSummary();
            
            // Auto-proceed to next step after 1 second
            setTimeout(() => {
                if(state.wizardStep === 3) {
                    nextStep();
                }
            }, 1000);
        };

        window.nextStep = () => {
            if(state.wizardStep === 1) {
                if(!document.getElementById('selectedCategory').value) {
                    showToast('Required', 'Please select a category', 'error');
                    return;
                }
                state.wizardStep = 2;
            } else if (state.wizardStep === 2) {
                const desc = document.getElementById('inpDesc').value.trim();
                if(!desc) {
                    showToast('Required', 'Please add a description', 'error');
                    return;
                }
                if(desc.length < 10) {
                    showToast('Too Short', 'Description should be at least 10 characters', 'error');
                    return;
                }
                state.wizardStep = 3;
            } else if (state.wizardStep === 3) {
                if(!document.getElementById('selectedPriority').value) {
                    showToast('Required', 'Please select a priority level', 'error');
                    return;
                }
                state.wizardStep = 4;
                updateReviewSummary();
            } else if (state.wizardStep === 4) {
                if(!document.getElementById('inpLoc').value) {
                    showToast('Required', 'Please select a location', 'error');
                    return;
                }
                submitReport();
                return;
            }
            updateWizardUI();
        };

        window.prevStep = () => { 
            if(state.wizardStep > 1) { 
                state.wizardStep--; 
                updateWizardUI();
                if(state.wizardStep === 3) updateReviewSummary();
            } 
        };

        function updateWizardUI() {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            const currentStep = document.getElementById(`step-${state.wizardStep}`);
            currentStep.classList.remove('hidden');
            currentStep.classList.add('animate__animated', 'animate__fadeIn');
            
            // Update step indicator
            const steps = ['Select Category', 'Add Details', 'Set Priority', 'Review & Submit'];
            document.getElementById('stepIndicator').innerText = `Step ${state.wizardStep} of 4 â€¢ ${steps[state.wizardStep - 1]}`;
            
            // Update progress bar
            const progressDots = document.querySelectorAll('[class*="w-10 h-10 rounded-full"]');
            progressDots.forEach((dot, index) => {
                if(index < state.wizardStep) {
                    dot.className = "w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm";
                } else if(index === state.wizardStep) {
                    dot.className = "w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm";
                } else {
                    dot.className = "w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-sm";
                }
            });
            
            // Update buttons
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');
            btnBack.classList.toggle('hidden', state.wizardStep === 1);
            
            if(state.wizardStep === 4) {
                btnNext.innerHTML = `
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Report
                `;
            } else {
                btnNext.innerHTML = `
                    Next Step
                    <i class="fas fa-arrow-right ml-2"></i>
                `;
            }
            
            // Update character count for description
            if(state.wizardStep === 2) {
                const desc = document.getElementById('inpDesc');
                const charCount = document.getElementById('descCharCount');
                desc.addEventListener('input', () => {
                    charCount.textContent = `${desc.value.length}/1000`;
                });
                charCount.textContent = `${desc.value.length}/1000`;
            }
        }

        function updateReviewSummary() {
            document.getElementById('reviewCategory').innerText = 
                document.getElementById('selectedCategory').value || '-';
            
            const priority = document.getElementById('selectedPriority').value;
            document.getElementById('reviewPriority').innerText = priority || '-';
            
            // Set priority color
            const priorityElement = document.getElementById('reviewPriority');
            priorityElement.className = 'font-bold ' + 
                (priority === 'Critical' ? 'text-red-600' : 
                 priority === 'High' ? 'text-orange-600' : 
                 priority === 'Normal' ? 'text-blue-600' : 'text-green-600');
            
            document.getElementById('reviewImage').innerText = 
                document.getElementById('inpImg').files.length > 0 ? 'Image uploaded' : 'No image';
            
            document.getElementById('reviewLocation').innerText = 
                document.getElementById('inpLoc').value || 'Not selected';
        }

        // IMAGE HANDLING
        window.previewImage = (input, imgId, phId) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if(file.size > maxSize) {
                    showToast('File Too Large', 'Image must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById(phId).classList.add('hidden');
                    
                    if(imgId === 'imgPreview') {
                        // Simulate AI analysis
                        const loader = document.getElementById('aiLoader');
                        loader.classList.remove('hidden'); 
                        loader.classList.add('flex');
                        
                        setTimeout(() => { 
                            loader.classList.add('hidden'); 
                            loader.classList.remove('flex'); 
                            
                            // Auto-select category based on image (simulated AI)
                            const categories = ['Infrastructure', 'Sanitation', 'Safety', 'Transport', 'Utilities'];
                            const randomCat = categories[Math.floor(Math.random() * categories.length)];
                            selectCategory(randomCat);
                            
                            showToast('AI Analysis Complete', `Detected as ${randomCat} issue`, 'success');
                        }, 1500);
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }

        // SUBMIT REPORT
        window.submitReport = async () => {
            const desc = document.getElementById('inpDesc').value.trim();
            const cat = document.getElementById('selectedCategory').value;
            const prio = document.getElementById('selectedPriority').value;
            const locStr = document.getElementById('inpLoc').value;
            const fileInput = document.getElementById('inpImg');
            
            if(!locStr) {
                showToast('Location Missing', 'Please pick a location on the map', 'error');
                return;
            }
            
            document.getElementById('btnNext').innerHTML = `
                <div class="loader-dots text-white"><div></div><div></div><div></div></div>
                <span class="ml-2">Uploading...</span>
            `;
            document.getElementById('btnNext').disabled = true;
            
            let coords = [40.7128, -74.0060];
            if(locStr.includes(',')) {
                const parts = locStr.split(',').map(p => parseFloat(p.trim()));
                if(parts.length >= 2) coords = [parts[0], parts[1]];
            }

            try {
                let imageBase64 = null;
                if(fileInput.files.length > 0) {
                    imageBase64 = await compressImage(fileInput.files[0]);
                }

                const reportData = {
                    description: desc, 
                    category: cat, 
                    priority: prio, 
                    coords: coords,
                    image: imageBase64, 
                    status: 'Pending', 
                    timestamp: Date.now(),
                    createdAt: serverTimestamp(),
                    user: state.name, 
                    uid: state.user?.uid || 'anon',
                    upvotes: 0, 
                    comments: [],
                    voters: [],
                    viewCount: 0,
                    lastUpdated: Date.now()
                };

                const reportRef = await addDoc(collection(db, `artifacts/${appId}/public/data/reports`), reportData);
                
                // Add to local state immediately for instant feedback
                state.reports.unshift({
                    id: reportRef.id,
                    ...reportData
                });
                
                // Update UI immediately
                updateUI();
                
                // Add community activity
                await addCommunityActivity('report_created', { 
                    category: cat, 
                    reportId: reportRef.id,
                    user: state.name,
                    priority: prio
                });
                
                // Add XP for submitting report
                await addUserXP(50);
                
                // Add notification
                await addNotification(
                    'Report Submitted!',
                    `Your ${cat.toLowerCase()} report has been submitted successfully`,
                    'success',
                    'fa-check-circle'
                );
                
                // Show success message
                showToast('Report Submitted!', 'Your report is now visible to the community', 'success');
                
                // Close modal
                closeModal('reportModal');
                
                // Reset form
                document.getElementById('inpDesc').value = '';
                document.getElementById('inpLoc').value = '';
                document.getElementById('inpImg').value = '';
                document.getElementById('selectedCategory').value = '';
                document.getElementById('selectedPriority').value = 'Normal';
                state.wizardStep = 1;
                updateWizardUI();
                
                // Switch to feed view
                setTimeout(() => {
                    switchView('feed');
                }, 1000);
                
            } catch(e) { 
                console.error(e); 
                showToast('Error', 'Failed to submit report. Please try again.', 'error'); 
            }
            
            document.getElementById('btnNext').innerHTML = `
                <i class="fas fa-paper-plane mr-2"></i>
                Submit Report
            `;
            document.getElementById('btnNext').disabled = false;
        };

        // DATA MANAGEMENT
        function startListener() {
            const q = query(collection(db, `artifacts/${appId}/public/data/reports`), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                state.reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateUI();
                
                // Update last update time
                state.lastUpdate = Date.now();
                
                // Show loading bar
                showLoadingBar();
                
                // Update community stats
                updateCommunityStats();
            });
        }

        function showLoadingBar() {
            const bar = document.getElementById('loadingBar');
            bar.style.transform = 'translateX(0)';
            bar.style.transition = 'transform 0.3s ease';
            
            setTimeout(() => {
                bar.style.transform = 'translateX(-100%)';
                bar.style.transition = 'transform 0.5s ease';
            }, 300);
            
            setTimeout(() => {
                bar.style.transition = 'none';
            }, 800);
        }

        function updateCommunityStats() {
            document.getElementById('communityReports').textContent = state.reports.length;
            document.getElementById('communityResolved').textContent = 
                state.reports.filter(r => r.status === 'Resolved').length;
            
            const totalComments = state.reports.reduce((sum, r) => 
                sum + (r.comments ? r.comments.length : 0), 0);
            document.getElementById('communityComments').textContent = totalComments;
            
            const totalVotes = state.reports.reduce((sum, r) => 
                sum + (r.upvotes || 0), 0);
            document.getElementById('communityVotes').textContent = totalVotes;
        }

        // FEED MANAGEMENT
        window.refreshFeed = () => {
            state.feedPage = 1;
            updateUI();
            showToast('Feed Refreshed', 'Loaded latest reports', 'success');
        };

        window.toggleAutoRefresh = (enabled) => {
            state.autoRefresh = enabled;
            showToast('Auto-Refresh', enabled ? 'Enabled' : 'Disabled', 'info');
        };

        function updateUI() {
            // Update stats
            const total = state.reports.length;
            const pending = state.reports.filter(r => r.status === 'Pending').length;
            const resolved = state.reports.filter(r => r.status === 'Resolved').length;
            const critical = state.reports.filter(r => r.priority === 'Critical').length;
            const inProgress = state.reports.filter(r => r.status === 'In Progress').length;
            
            document.getElementById('statTotal').innerText = total;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statResolved').innerText = resolved;
            document.getElementById('totalReportsChart').textContent = total;
            
            // Update filter counts
            document.getElementById('filterAllCount').textContent = total;
            document.getElementById('filterCriticalCount').textContent = critical;
            document.getElementById('filterHighCount').textContent = state.reports.filter(r => r.priority === 'High').length;
            document.getElementById('filterPendingCount').textContent = pending;
            document.getElementById('filterResolvedCount').textContent = resolved;
            
            // Quick stats for authorities
            document.getElementById('quickCritical').innerText = critical;
            document.getElementById('quickProgress').innerText = inProgress;
            
            // Update feed counts
            const filteredReports = filterReportsForFeed();
            document.getElementById('filteredCount').textContent = filteredReports.length;
            document.getElementById('totalCount').textContent = state.reports.length;
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update feed
            updateFeed();
            
            // Update mini feed
            updateMiniFeed();
            
            // Update live activity
            updateLiveActivity();
            
            // Update charts
            updateCharts();
            
            // Update markers
            updateMarkers();
            
            // Update user reports
            updateUserReports();
        }

        function filterReportsForFeed() {
            let filteredReports = [...state.reports];
            
            // Apply status filter
            if(state.currentFilter !== 'all') {
                filteredReports = filteredReports.filter(r => r.status === state.currentFilter);
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('feedSearch')?.value.toLowerCase();
            if(searchTerm) {
                filteredReports = filteredReports.filter(r => 
                    r.description.toLowerCase().includes(searchTerm) ||
                    r.category.toLowerCase().includes(searchTerm) ||
                    r.user.toLowerCase().includes(searchTerm)
                );
            }
            
            return filteredReports;
        }

        function updateFeed() {
            const feed = document.getElementById('feedContainer');
            const loadMoreIndicator = document.getElementById('loadMoreIndicator');
            const endOfFeed = document.getElementById('endOfFeed');
            
            if(state.isLoadingFeed) {
                loadMoreIndicator.classList.remove('hidden');
                endOfFeed.classList.add('hidden');
                return;
            }
            
            const filteredReports = filterReportsForFeed();
            const start = 0;
            const end = state.feedPage * state.feedLimit;
            const reportsToShow = filteredReports.slice(start, end);
            
            if(reportsToShow.length === 0) {
                feed.innerHTML = `
                    <div class="glass rounded-3xl p-12 text-center">
                        <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-500 text-3xl mx-auto mb-6">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">No reports found</h3>
                        <p class="text-slate-600 mb-6">Try changing your filters or search terms</p>
                        <button onclick="refreshFeed()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                            Reset Filters
                        </button>
                    </div>
                `;
                loadMoreIndicator.classList.add('hidden');
                endOfFeed.classList.add('hidden');
                return;
            }
            
            feed.innerHTML = reportsToShow.map(r => renderReportCard(r)).join('');
            
            // Show/hide load more and end messages
            if(end >= filteredReports.length) {
                loadMoreIndicator.classList.add('hidden');
                endOfFeed.classList.remove('hidden');
            } else {
                loadMoreIndicator.classList.add('hidden');
                endOfFeed.classList.add('hidden');
            }
        }

        function renderReportCard(r) {
            const isResolved = r.status === 'Resolved';
            const isInProgress = r.status === 'In Progress';
            const commentCount = r.comments ? r.comments.length : 0;
            const upvoteCount = r.upvotes || 0;
            const hasVoted = r.voters && r.voters.includes(state.user?.uid);
            const isOwner = r.user === state.name;
            const timeAgo = getTimeAgo(r.timestamp);
            
            // Priority colors
            const priorityColors = {
                'Critical': 'from-red-500 to-red-600',
                'High': 'from-orange-500 to-orange-600',
                'Normal': 'from-blue-500 to-blue-600',
                'Low': 'from-green-500 to-green-600'
            };
            
            // Status badges
            const statusBadges = {
                'Pending': { color: 'bg-yellow-100 text-yellow-800', icon: 'fa-clock' },
                'In Progress': { color: 'bg-blue-100 text-blue-800', icon: 'fa-spinner' },
                'Resolved': { color: 'bg-green-100 text-green-800', icon: 'fa-check-circle' }
            };
            
            const statusConfig = statusBadges[r.status] || statusBadges.Pending;
            
            return `
                <div class="report-card animate__animated animate__fadeIn" data-report-id="${r.id}">
                    <!-- Report Header -->
                    <div class="p-6 border-b border-slate-100/50">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg">
                                        ${r.user[0]}
                                    </div>
                                    ${state.onlineUsers[r.uid] ? '<div class="online-indicator"></div>' : ''}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${r.user}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="status-badge ${statusConfig.color}">
                                            <i class="fas ${statusConfig.icon} mr-1"></i>
                                            ${r.status}
                                        </span>
                                        <span class="text-xs text-slate-500">${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="status-badge bg-gradient-to-r ${priorityColors[r.priority]} text-white">
                                    <i class="fas fa-flag mr-1"></i>
                                    ${r.priority}
                                </span>
                                ${isOwner ? `
                                    <button onclick="openDeleteModal('${r.id}')" class="delete-button w-10 h-10 rounded-xl bg-red-50 hover:bg-red-100 flex items-center justify-center text-red-500" title="Delete Report">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                ${state.role === 'authority' && !isResolved ? `
                                    <button onclick="openResolveModal('${r.id}')" class="w-10 h-10 rounded-xl bg-green-50 hover:bg-green-100 flex items-center justify-center text-green-500" title="Resolve Issue">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Category -->
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-100 to-blue-50 flex items-center justify-center text-blue-600">
                                <i class="fas ${getCategoryIcon(r.category)}"></i>
                            </div>
                            <span class="text-sm font-bold text-slate-700 uppercase tracking-wider">${r.category}</span>
                        </div>
                        
                        <!-- Description -->
                        <p class="text-slate-700 leading-relaxed mb-4">${r.description}</p>
                        
                        <!-- Image -->
                        ${r.image ? `
                            <div class="mb-4 rounded-2xl overflow-hidden h-64 bg-gradient-to-br from-slate-100 to-slate-200 relative group cursor-zoom-in" onclick="toggleImageZoom(this)">
                                <img src="${r.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                                    <span class="text-white text-sm">Click to zoom â€¢ Drag to pan</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Resolution Info -->
                        ${isResolved && r.resolution ? `
                            <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-100">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-green-800">Resolved by ${r.resolution.by}</div>
                                        <div class="text-sm text-green-600">${getTimeAgo(r.resolution.at)}</div>
                                    </div>
                                </div>
                                <p class="text-green-700 mb-3">${r.resolution.note}</p>
                                ${r.resolution.proof ? `
                                    <div class="rounded-xl overflow-hidden h-48 border border-green-200">
                                        <img src="${r.resolution.proof}" class="w-full h-full object-cover">
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Report Footer -->
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <!-- Action Buttons -->
                            <div class="flex items-center gap-6">
                                <button onclick="upvote('${r.id}')" class="like-button flex items-center gap-2 ${hasVoted ? 'active' : 'text-slate-500'}" title="Like this report">
                                    <i class="fas fa-thumbs-up text-lg"></i>
                                    <span class="font-bold like-count">${upvoteCount}</span>
                                </button>
                                <button onclick="openComments('${r.id}')" class="comment-button flex items-center gap-2 text-slate-500" title="View comments">
                                    <i class="fas fa-comment text-lg"></i>
                                    <span class="font-bold">${commentCount}</span>
                                </button>
                                <button onclick="openChatModal('${r.user}', 'private')" class="message-button flex items-center gap-2 text-slate-500" title="Message reporter">
                                    <i class="fas fa-envelope text-lg"></i>
                                    <span class="font-bold">Message</span>
                                </button>
                                ${!isOwner ? `
                                    <button onclick="openDeleteModal('${r.id}')" class="delete-button flex items-center gap-2 text-slate-500" title="Report issue">
                                        <i class="fas fa-flag text-lg"></i>
                                        <span class="font-bold">Report</span>
                                    </button>
                                ` : ''}
                            </div>
                            
                            <!-- Location & Info -->
                            <div class="flex items-center gap-4">
                                ${r.coords ? `
                                    <div class="text-xs text-slate-500 flex items-center gap-1">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${r.coords[0].toFixed(4)}, ${r.coords[1].toFixed(4)}</span>
                                    </div>
                                ` : ''}
                                <div class="text-xs text-slate-500">
                                    <i class="far fa-eye mr-1"></i>
                                    <span>${r.viewCount || 0} views</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleImageZoom(element) {
            const img = element.querySelector('img');
            if(img.classList.contains('object-scale-down')) {
                img.classList.remove('object-scale-down');
                img.classList.add('object-cover');
            } else {
                img.classList.remove('object-cover');
                img.classList.add('object-scale-down');
            }
        }

        function updateMiniFeed() {
            const container = document.getElementById('miniFeed');
            const recentReports = state.reports.slice(0, 3);
            
            if(recentReports.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-slate-600">No recent reports</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentReports.map(r => {
                const timeAgo = getTimeAgo(r.timestamp);
                const statusColor = r.status === 'Resolved' ? 'text-green-500' : 
                                   r.status === 'In Progress' ? 'text-yellow-500' : 'text-red-500';
                
                return `
                    <div class="flex items-center gap-4 p-4 hover:bg-slate-50/50 rounded-2xl transition-all duration-300 cursor-pointer group" onclick="openComments('${r.id}')">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                            ${r.user[0]}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-slate-800 text-sm truncate">${r.description.substring(0, 40)}...</div>
                            <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
                                <span>${r.category}</span>
                                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                <span class="${statusColor} font-semibold">${r.status}</span>
                                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 group-hover:translate-x-1 transition-all duration-300"></i>
                    </div>
                `;
            }).join('');
        }

        function updateLiveActivity() {
            const container = document.getElementById('liveActivity');
            const recentActivity = state.reports
                .filter(r => Date.now() - r.timestamp < 3600000) // Last hour
                .slice(0, 5);
            
            if(recentActivity.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-400 text-2xl mx-auto mb-4">
                            <i class="fas fa-bell-slash"></i>
                        </div>
                        <p class="text-slate-600">No recent activity</p>
                        <p class="text-xs text-slate-500 mt-1">Check back later for updates</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentActivity.map(r => {
                const timeAgo = getTimeAgo(r.timestamp);
                const icon = getCategoryIcon(r.category);
                const color = r.priority === 'Critical' ? 'text-red-500' : 
                             r.priority === 'High' ? 'text-orange-500' : 
                             r.priority === 'Normal' ? 'text-blue-500' : 'text-green-500';
                
                return `
                    <div class="flex items-center gap-4 p-4 hover:bg-slate-50/50 rounded-2xl transition-all duration-300">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-100 to-blue-50 flex items-center justify-center ${color}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-slate-800 text-sm truncate">${r.description.substring(0, 30)}...</div>
                            <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
                                <span>${r.user}</span>
                                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <div class="text-xs font-bold ${color}">
                            ${r.priority}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // LEADERBOARD
        window.updateLeaderboardRange = (range) => {
            state.leaderboardRange = range;
            updateLeaderboard();
        };

        function updateLeaderboard() {
            const users = {};
            
            // Calculate XP based on reports
            state.reports.forEach(r => {
                if(!users[r.user]) {
                    users[r.user] = {
                        xp: 0,
                        reports: 0,
                        resolved: 0,
                        comments: 0,
                        upvotes: 0
                    };
                }
                
                users[r.user].reports += 1;
                users[r.user].xp += 50; // Base XP for report
                
                if(r.status === 'Resolved') {
                    users[r.user].xp += 100;
                    users[r.user].resolved += 1;
                }
                
                if(r.upvotes) {
                    users[r.user].xp += r.upvotes * 10;
                    users[r.user].upvotes += r.upvotes;
                }
                
                if(r.comments) {
                    users[r.user].comments += r.comments.length;
                    users[r.user].xp += r.comments.length * 5;
                }
                
                // Priority bonus
                if(r.priority === 'Critical') users[r.user].xp += 50;
                else if(r.priority === 'High') users[r.user].xp += 25;
            });
            
            const sortedUsers = Object.entries(users)
                .sort((a, b) => b[1].xp - a[1].xp)
                .slice(0, 10);
            
            const list = document.getElementById('leaderboardList');
            list.innerHTML = sortedUsers.map(([name, data], index) => {
                const isCurrentUser = name === state.name;
                const rankColors = [
                    'from-yellow-500 to-yellow-600',
                    'from-slate-400 to-slate-500',
                    'from-orange-500 to-orange-600',
                    'from-blue-500 to-blue-600'
                ];
                
                const rankColor = index < 3 ? rankColors[index] : 'from-blue-500 to-purple-500';
                
                return `
                    <div class="flex items-center justify-between p-6 hover:bg-slate-50/50 transition-all duration-300 ${isCurrentUser ? 'bg-gradient-to-r from-blue-50 to-purple-50' : ''}">
                        <div class="flex items-center gap-6">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-r ${rankColor} flex items-center justify-center text-white text-xl font-black">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    ${name}
                                    ${isCurrentUser ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">You</span>' : ''}
                                </div>
                                <div class="text-sm text-slate-500 mt-1">
                                    ${data.reports} reports â€¢ ${data.resolved} resolved â€¢ Level ${Math.floor(data.xp / 500) + 1}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black gradient-text">${data.xp} XP</div>
                            <div class="text-xs text-slate-500">${data.upvotes} likes â€¢ ${data.comments} comments</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update user's position
            const userIndex = sortedUsers.findIndex(([name]) => name === state.name);
            const userPosition = document.getElementById('yourPosition');
            
            if(userIndex !== -1) {
                userPosition.classList.remove('hidden');
                document.getElementById('yourRank').textContent = userIndex + 1;
                document.getElementById('yourXP').textContent = `${sortedUsers[userIndex][1].xp} XP Points`;
            } else if(users[state.name]) {
                userPosition.classList.remove('hidden');
                document.getElementById('yourRank').textContent = '>10';
                document.getElementById('yourXP').textContent = `${users[state.name].xp} XP Points`;
            }
        }

        // USER PROFILE FUNCTIONS
        function loadUserReports() {
            state.userReports = state.reports.filter(r => r.user === state.name);
            updateUserReports();
        }

        function updateUserReports() {
            const container = document.getElementById('userReports');
            const userReports = state.reports.filter(r => r.user === state.name).slice(0, 5);
            
            if(userReports.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center text-blue-500 text-2xl mx-auto mb-4">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <p class="text-slate-600">No reports yet</p>
                        <p class="text-xs text-slate-500 mt-1">Create your first report to get started</p>
                        <button onclick="openModal()" class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-2xl font-bold shadow-lg shadow-purple-500/30 transition-all duration-300 hover:scale-105">
                            Create Report
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userReports.map(r => {
                const timeAgo = getTimeAgo(r.timestamp);
                const statusColor = r.status === 'Resolved' ? 'text-green-500' : 
                                   r.status === 'In Progress' ? 'text-yellow-500' : 'text-red-500';
                
                return `
                    <div class="flex items-center justify-between p-4 hover:bg-slate-50/50 rounded-2xl transition-all duration-300">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white">
                                <i class="fas ${getCategoryIcon(r.category)}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-slate-800">${r.category}</div>
                                <div class="text-sm text-slate-500 flex items-center gap-2 mt-1">
                                    <span class="${statusColor} font-semibold">${r.status}</span>
                                    <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                    <span>${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <div class="text-sm font-bold text-slate-800">${r.upvotes || 0} likes</div>
                                <div class="text-xs text-slate-500">${r.comments ? r.comments.length : 0} comments</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openComments('${r.id}')" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600">
                                    <i class="fas fa-comment"></i>
                                </button>
                                ${r.status !== 'Resolved' ? `
                                    <button onclick="openDeleteModal('${r.id}')" class="w-10 h-10 rounded-xl bg-red-50 hover:bg-red-100 flex items-center justify-center text-red-500">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.filterUserReports = (filter) => {
            // This would filter the user reports display
            showToast('Filter Applied', `Showing ${filter} reports`, 'info');
        };

        window.editProfile = () => {
            showToast('Edit Profile', 'Profile editing coming soon', 'info');
        };

        window.viewAllActivity = () => {
            switchView('feed');
        };

        // BADGES SYSTEM
        async function loadUserBadges() {
            try {
                if(!state.user?.uid) return;
                
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, state.user.uid);
                const userSnap = await getDoc(userRef);
                
                if(userSnap.exists()) {
                    state.userBadges = userSnap.data().badges || [];
                    updateUserBadges();
                }
            } catch(e) {
                console.error(e);
            }
        }

        function updateUserBadges() {
            const container = document.getElementById('userBadges');
            
            if(state.userBadges.length === 0) {
                container.innerHTML = `
                    <div class="text-center col-span-2 py-8">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-400 text-2xl mx-auto mb-4">
                            <i class="fas fa-award"></i>
                        </div>
                        <p class="text-slate-600">No badges yet</p>
                        <p class="text-xs text-slate-500 mt-1">Earn badges by being an active citizen</p>
                    </div>
                `;
                return;
            }
            
            const badges = {
                'first_report': { name: 'First Report', icon: 'fa-star', color: 'from-yellow-500 to-yellow-600' },
                'report_master': { name: 'Report Master', icon: 'fa-file-alt', color: 'from-blue-500 to-blue-600' },
                'community_helper': { name: 'Community Helper', icon: 'fa-hands-helping', color: 'from-green-500 to-green-600' },
                'quick_responder': { name: 'Quick Responder', icon: 'fa-bolt', color: 'from-purple-500 to-purple-600' },
                'city_champion': { name: 'City Champion', icon: 'fa-trophy', color: 'from-orange-500 to-orange-600' }
            };
            
            container.innerHTML = state.userBadges.map(badgeId => {
                const badge = badges[badgeId] || { name: badgeId, icon: 'fa-award', color: 'from-slate-500 to-slate-600' };
                
                return `
                    <div class="flex flex-col items-center p-4 rounded-2xl bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-r ${badge.color} flex items-center justify-center text-white text-2xl mb-3">
                            <i class="fas ${badge.icon}"></i>
                        </div>
                        <div class="font-bold text-slate-800 text-sm text-center">${badge.name}</div>
                    </div>
                `;
            }).join('');
        }

        async function addUserXP(amount) {
            try {
                if(!state.user?.uid) return;
                
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, state.user.uid);
                await updateDoc(userRef, {
                    xp: increment(amount),
                    lastActive: serverTimestamp()
                });
                
                // Update local XP display
                const userXpElement = document.getElementById('profileXP');
                const currentXP = parseInt(userXpElement.textContent) || 0;
                userXpElement.textContent = currentXP + amount;
                document.getElementById('statXP').textContent = currentXP + amount;
                
                // Check for level up
                const newLevel = Math.floor((currentXP + amount) / 500) + 1;
                const oldLevel = Math.floor(currentXP / 500) + 1;
                
                if(newLevel > oldLevel) {
                    showToast('Level Up!', `Congratulations! You reached Level ${newLevel}`, 'success');
                    document.getElementById('profileLevel').textContent = newLevel;
                    
                    // Award level up badge
                    await updateDoc(userRef, {
                        badges: arrayUnion('level_up')
                    });
                }
            } catch(e) {
                console.error(e);
            }
        }

        // COMMUNITY ACTIVITY
        function listenToCommunityActivity() {
            // This would listen to real-time community activity
            // For now, we'll simulate with an interval
            setInterval(() => {
                updateCommunityActivity();
            }, 5000);
        }

        async function addCommunityActivity(type, data) {
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/activity`), {
                    type,
                    user: state.name,
                    userId: state.user?.uid,
                    data,
                    timestamp: Date.now()
                });
            } catch(e) {
                console.error(e);
            }
        }

        function updateCommunityActivity() {
            const container = document.getElementById('communityActivity');
            
            // Simulate community activity from reports
            const recentActivity = state.reports.slice(0, 5).map(r => ({
                type: 'report_created',
                user: r.user,
                data: { category: r.category, reportId: r.id },
                timestamp: r.timestamp
            }));
            
            if(recentActivity.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-slate-600">No community activity yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentActivity.map(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const icon = activity.type === 'report_created' ? 'fa-plus-circle' : 'fa-comment';
                const color = activity.type === 'report_created' ? 'text-blue-500' : 'text-green-500';
                
                return `
                    <div class="flex items-center gap-4 p-4 hover:bg-slate-50/50 rounded-2xl transition-all duration-300">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-100 to-blue-50 flex items-center justify-center ${color}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-slate-700">
                                <span class="font-bold">${activity.user}</span> reported a new ${activity.data.category} issue
                            </div>
                            <div class="text-xs text-slate-500 mt-1">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.loadMoreActivity = () => {
            showToast('Loading', 'Loading more activity...', 'info');
            // Implement load more functionality
        };

        // CHAT SYSTEM
        window.openChatModal = (targetUser, roomType) => {
            // Chat system implementation
            showToast('Chat', `Opening chat with ${targetUser || roomType}`, 'info');
        };

        // MAP FILTERING
        window.filterMap = (filter) => {
            state.activeMapFilter = filter;
            updateMarkers();
            
            const filterNames = {
                'all': 'All Issues',
                'Critical': 'Critical Issues',
                'High': 'High Priority',
                'Pending': 'Pending Issues',
                'Resolved': 'Resolved Issues'
            };
            
            showToast('Map Filter', `Showing ${filterNames[filter]}`, 'info');
        };

        function updateMarkers() {
            if(!state.map) return;
            
            // Remove existing markers
            if(state.markers) {
                state.markers.forEach(m => state.map.removeLayer(m));
            }
            state.markers = [];
            
            let filteredReports = state.reports;
            if(state.activeMapFilter === 'Critical') {
                filteredReports = state.reports.filter(r => r.priority === 'Critical');
            } else if(state.activeMapFilter === 'High') {
                filteredReports = state.reports.filter(r => r.priority === 'High');
            } else if(state.activeMapFilter === 'Pending') {
                filteredReports = state.reports.filter(r => r.status === 'Pending');
            } else if(state.activeMapFilter === 'Resolved') {
                filteredReports = state.reports.filter(r => r.status === 'Resolved');
            }
            
            filteredReports.forEach(r => {
                if(r.coords && r.coords.length === 2) {
                    let color = '#3b82f6'; // Default blue
                    if(r.priority === 'Critical') color = '#ef4444';
                    else if(r.priority === 'High') color = '#f97316';
                    else if(r.priority === 'Normal') color = '#3b82f6';
                    else if(r.priority === 'Low') color = '#22c55e';
                    
                    if(r.status === 'Resolved') color = '#10b981';
                    else if(r.status === 'In Progress') color = '#eab308';
                    
                    const icon = L.divIcon({
                        className: 'custom',
                        html: `
                            <div class="relative">
                                <div class="marker-pin" style="background:${color}"></div>
                                <i class="fas ${getCategoryIcon(r.category)} marker-icon"></i>
                                ${r.priority === 'Critical' ? `
                                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white rounded-full animate-pulse"></div>
                                ` : ''}
                            </div>
                        `,
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    });
                    
                    const popupContent = `
                        <div class="p-3 max-w-xs">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold">
                                        ${r.user[0]}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-800 text-sm">${r.user}</div>
                                        <div class="text-xs text-slate-500">${getTimeAgo(r.timestamp)}</div>
                                    </div>
                                </div>
                                <span class="text-xs px-2 py-1 rounded font-bold ${getPriorityClass(r.priority)}">
                                    ${r.priority}
                                </span>
                            </div>
                            <div class="text-xs text-slate-600 mb-3">${r.description.substring(0, 80)}...</div>
                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <span>${r.category}</span>
                                <span class="font-bold ${r.status === 'Resolved' ? 'text-green-500' : r.status === 'In Progress' ? 'text-yellow-500' : 'text-red-500'}">
                                    ${r.status}
                                </span>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <button onclick="window.openComments('${r.id}')" class="flex-1 text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-bold transition-colors">
                                    <i class="fas fa-comment mr-1"></i> View
                                </button>
                                <button onclick="window.upvote('${r.id}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg font-bold transition-colors">
                                    <i class="fas fa-thumbs-up"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    const marker = L.marker(r.coords, {icon})
                        .addTo(state.map)
                        .bindPopup(popupContent);
                    
                    state.markers.push(marker);
                }
            });
        }

        // CHARTS
        let lineChart, pieChart;
        function updateCharts() {
            // Line Chart
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const data1 = new Array(7).fill(0);
            
            // Calculate reports per day for last week
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentReports = state.reports.filter(r => r.timestamp > oneWeekAgo);
            
            recentReports.forEach(r => {
                const day = new Date(r.timestamp).getDay();
                data1[day] = (data1[day] || 0) + 1;
            });
            
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx1, {
                type: 'line',
                data: { 
                    labels: days, 
                    datasets: [{ 
                        label: 'Reports', 
                        data: data1, 
                        borderColor: '#667eea', 
                        backgroundColor: 'rgba(102, 126, 234, 0.1)', 
                        fill: true, 
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            cornerRadius: 12,
                            padding: 12,
                            displayColors: false
                        }
                    }, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { 
                                borderDash: [4, 4],
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: { 
                                stepSize: 1,
                                color: '#64748b'
                            }
                        }, 
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#64748b' }
                        } 
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                } 
            });

            // Pie Chart
            const ctx2 = document.getElementById('pieChart').getContext('2d');
            const categories = {};
            state.reports.forEach(r => { 
                categories[r.category] = (categories[r.category] || 0) + 1; 
            });
            
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b'];
            
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctx2, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(categories), 
                    datasets: [{ 
                        data: Object.values(categories),
                        backgroundColor: colors.slice(0, Object.keys(categories).length),
                        borderWidth: 0,
                        hoverOffset: 15,
                        borderRadius: 10
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 11
                                },
                                color: '#64748b'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%'
                } 
            });
        }

        // TOAST SYSTEM
        let toastTimeout;
        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const iconContainer = document.getElementById('toastIconContainer');
            const icon = document.getElementById('toastIcon');
            
            // Set colors based on type
            const colors = {
                'success': { bg: 'from-green-500 to-emerald-600', icon: 'fa-check-circle' },
                'error': { bg: 'from-red-500 to-red-600', icon: 'fa-exclamation-circle' },
                'warning': { bg: 'from-yellow-500 to-yellow-600', icon: 'fa-exclamation-triangle' },
                'info': { bg: 'from-blue-500 to-purple-600', icon: 'fa-info-circle' }
            };
            
            const config = colors[type] || colors.info;
            
            // Update content
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMsg').textContent = message;
            document.getElementById('toastTime').textContent = 'Just now';
            
            // Update icon
            icon.className = `fas ${config.icon}`;
            iconContainer.className = `w-12 h-12 rounded-xl bg-gradient-to-br ${config.bg} flex items-center justify-center text-white text-xl`;
            
            // Show toast with animation
            toast.classList.remove('translate-x-[200%]');
            toast.classList.add('animate__animated', 'animate__fadeInRight');
            
            // Hide previous timeout
            if(toastTimeout) clearTimeout(toastTimeout);
            
            // Auto-hide after 5 seconds
            toastTimeout = setTimeout(() => {
                hideToast();
            }, 5000);
        }

        window.hideToast = () => {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-x-[200%]');
            toast.classList.remove('animate__animated', 'animate__fadeInRight');
            
            if(toastTimeout) {
                clearTimeout(toastTimeout);
                toastTimeout = null;
            }
        };

        // UTILITY FUNCTIONS
        function getCategoryIcon(category) {
            const icons = {
                'Infrastructure': 'fa-road',
                'Sanitation': 'fa-trash',
                'Safety': 'fa-shield-alt',
                'Transport': 'fa-bus',
                'Utilities': 'fa-bolt',
                'Other': 'fa-ellipsis-h'
            };
            return icons[category] || 'fa-exclamation';
        }

        function getPriorityClass(priority) {
            const classes = {
                'Critical': 'bg-red-100 text-red-800',
                'High': 'bg-orange-100 text-orange-800',
                'Normal': 'bg-blue-100 text-blue-800',
                'Low': 'bg-green-100 text-green-800'
            };
            return classes[priority] || 'bg-slate-100 text-slate-800';
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if(days > 0) return `${days}d ago`;
            if(hours > 0) return `${hours}h ago`;
            if(minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        function refreshData() {
            if(!state.autoRefresh) return;
            
            const now = Date.now();
            if(now - state.lastUpdate > 30000) { // 30 seconds
                showLoadingBar();
                // Force UI update
                updateUI();
                state.lastUpdate = now;
            }
        }

        // INITIALIZE
        initAuth();
        
        // Auto login for demo
        setTimeout(() => {
            if(document.getElementById('authScreen').classList.contains('fixed')) {
                document.getElementById('loginName').value = 'Demo User';
                setRole('citizen');
                handleLogin();
            }
        }, 100);
    </script>
</body>
</html>
