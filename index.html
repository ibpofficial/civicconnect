<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicConnect Pro - Advanced City Platform</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- TAILWIND CONFIG -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', '"Plus Jakarta Sans"', 'sans-serif'],
                        display: ['"Plus Jakarta Sans"', 'sans-serif']
                    },
                    colors: {
                        primary: { 
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        secondary: {
                            50: '#f8fafc',
                            600: '#475569',
                            700: '#334155',
                        },
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#0f172a',
                        surface: '#ffffff',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in-right': 'slideInRight 0.5s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b; 
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Custom scrollbar */
        .scroll-smooth::-webkit-scrollbar { width: 6px; }
        .scroll-smooth::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .scroll-smooth::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            border-radius: 10px; 
        }
        .scroll-smooth::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, #2563eb, #1e40af); }
        
        /* Social media feed styling */
        .feed-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .feed-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced map styling */
        .leaflet-container {
            font-family: 'Inter', sans-serif;
            border-radius: 16px;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Pulse animation for new reports */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        /* Department badges */
        .department-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Smooth transitions */
        .transition-all-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Enhanced button styles */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        /* Safe area for mobile */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 0); }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-gradient-to-br from-slate-50 to-blue-50">

    <!-- ENTRY SCREEN -->
    <div id="entryScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900">
        <div class="max-w-4xl w-full p-8 animate-slide-in-right">
            <div class="text-center mb-12">
                <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl mx-auto flex items-center justify-center text-white text-4xl shadow-2xl mb-6 animate-float">
                    <i class="fas fa-city"></i>
                </div>
                <h1 class="text-5xl font-bold text-white mb-4 font-display">CivicConnect<span class="gradient-text"> Pro</span></h1>
                <p class="text-xl text-slate-300 mb-8 max-w-2xl mx-auto">Smart City Platform - Bridging Citizens & Authorities for a Better Community</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
                <!-- Citizen Card -->
                <div class="glass p-8 rounded-3xl text-center hover:transform hover:-translate-y-2 transition-all duration-300 cursor-pointer group" onclick="selectUserType('citizen')">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-2xl mx-auto flex items-center justify-center text-white text-3xl shadow-lg mb-6 group-hover:scale-110 transition-transform">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-3 font-display">Citizen</h3>
                    <p class="text-slate-600 mb-6">Report issues, track progress, earn rewards, and engage with your community</p>
                    <div class="space-y-3 text-left">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Report city issues</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Earn XP & rewards</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Track resolution progress</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Community leaderboard</span>
                        </div>
                    </div>
                    <button class="mt-8 w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-95">
                        Continue as Citizen
                    </button>
                </div>

                <!-- Authority Card -->
                <div class="glass p-8 rounded-3xl text-center hover:transform hover:-translate-y-2 transition-all duration-300 cursor-pointer group" onclick="selectUserType('authority')">
                    <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl mx-auto flex items-center justify-center text-white text-3xl shadow-lg mb-6 group-hover:scale-110 transition-transform">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-3 font-display">Authority</h3>
                    <p class="text-slate-600 mb-6">Manage reports, assign departments, resolve issues, and analyze city data</p>
                    <div class="space-y-3 text-left">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Manage citizen reports</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Assign to departments</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Upload resolution proof</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm">Advanced analytics</span>
                        </div>
                    </div>
                    <button class="mt-8 w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-xl shadow-lg shadow-purple-500/30 transition-all transform hover:scale-[1.02] active:scale-95">
                        Continue as Authority
                    </button>
                </div>
            </div>

            <div class="text-center mt-12">
                <p class="text-slate-400 text-sm">Join thousands of users making their cities better</p>
                <div class="flex items-center justify-center gap-6 mt-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-white">15K+</div>
                        <div class="text-xs text-slate-400">Reports Resolved</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-white">8K+</div>
                        <div class="text-xs text-slate-400">Active Citizens</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-white">95%</div>
                        <div class="text-xs text-slate-400">Satisfaction Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="authScreen" class="fixed inset-0 z-40 bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 hidden flex items-center justify-center">
        <div class="max-w-md w-full p-8 text-center animate-slide-in-right">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center text-white text-3xl shadow-2xl mb-6 animate-float">
                <i class="fas fa-city"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2 font-display">CivicConnect<span class="gradient-text"> Pro</span></h1>
            <p class="text-slate-300 mb-8">Enter your details to continue</p>
            
            <div class="space-y-6">
                <div class="text-left">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Your Name</label>
                    <input type="text" id="loginName" class="w-full px-4 py-3 rounded-xl glass-dark border border-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-slate-400 transition-all" placeholder="Enter your full name">
                </div>
                
                <div class="text-left">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Your Role</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setRole('citizen')" id="btnCit" class="py-3 glass-dark text-blue-400 font-bold rounded-xl border-2 border-blue-500/50 transition-all hover:border-blue-500 hover:bg-blue-500/10">
                            <i class="fas fa-users mr-2"></i>Citizen
                        </button>
                        <button onclick="setRole('authority')" id="btnAuth" class="py-3 glass-dark text-purple-400 font-bold rounded-xl border-2 border-purple-500/50 transition-all hover:border-purple-500 hover:bg-purple-500/10">
                            <i class="fas fa-user-shield mr-2"></i>Authority
                        </button>
                    </div>
                </div>

                <div class="text-left">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Department (For Authorities)</label>
                    <select id="departmentSelect" class="w-full px-4 py-3 rounded-xl glass-dark border border-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white transition-all">
                        <option value="" class="bg-slate-800">Select Department</option>
                        <option value="Sanitation" class="bg-slate-800">Sanitation Department</option>
                        <option value="Infrastructure" class="bg-slate-800">Public Works</option>
                        <option value="Transport" class="bg-slate-800">Transport Authority</option>
                        <option value="Safety" class="bg-slate-800">Public Safety</option>
                        <option value="Utilities" class="bg-slate-800">Utilities Department</option>
                        <option value="Planning" class="bg-slate-800">City Planning</option>
                    </select>
                </div>
                
                <button onclick="handleLogin()" class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-95">
                    <i class="fas fa-rocket mr-2"></i>Enter Smart Platform
                </button>
            </div>
            
            <button onclick="goBackToEntry()" class="mt-6 text-blue-400 hover:text-blue-300 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Role Selection
            </button>
            
            <p class="text-xs text-slate-500 mt-8">Secure Platform • Real-time Updates • Encrypted Data</p>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div id="appLayout" class="hidden flex-1 flex overflow-hidden">
        <!-- Sidebar (Desktop) -->
        <aside class="hidden lg:flex w-72 bg-white/90 backdrop-blur-xl border-r border-slate-200/50 flex-col z-30">
            <div class="h-20 flex items-center px-6 border-b border-slate-100">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl mr-3">
                    <i class="fas fa-city"></i>
                </div>
                <div>
                    <span class="font-bold text-lg tracking-tight text-slate-900 font-display">CivicConnect</span>
                    <div class="text-xs text-slate-500" id="sidebarRole">Citizen Dashboard</div>
                </div>
            </div>
            
            <div class="p-6">
                <!-- User Profile Card -->
                <div class="glass p-4 rounded-2xl mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg" id="userAvatar">U</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-bold text-slate-900 truncate" id="userName">User</div>
                            <div class="text-xs text-slate-500 truncate" id="userRole">Citizen</div>
                            <div class="text-xs text-slate-400 truncate" id="userDepartment"></div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <div class="text-center p-2 bg-blue-50 rounded-lg">
                            <div class="text-sm font-bold text-blue-600" id="userXP">0</div>
                            <div class="text-xs text-slate-500">XP</div>
                        </div>
                        <div class="text-center p-2 bg-green-50 rounded-lg">
                            <div class="text-sm font-bold text-green-600" id="userLevel">1</div>
                            <div class="text-xs text-slate-500">Level</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="space-y-1">
                    <button onclick="switchView('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-semibold nav-item transition-all hover:bg-blue-100" id="nav-dashboard">
                        <i class="fas fa-chart-pie w-5 text-center"></i> Dashboard
                    </button>
                    <button onclick="switchView('map')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold nav-item transition-all" id="nav-map">
                        <i class="fas fa-map-marked-alt w-5 text-center"></i> Live City Map
                    </button>
                    <button onclick="switchView('feed')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold nav-item transition-all" id="nav-feed">
                        <i class="fas fa-newspaper w-5 text-center"></i> Community Feed
                    </button>
                    <button onclick="switchView('leaderboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold nav-item transition-all" id="nav-leaderboard">
                        <i class="fas fa-trophy w-5 text-center"></i> Leaderboard
                    </button>
                    <button onclick="switchView('profile')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold nav-item transition-all" id="nav-profile">
                        <i class="fas fa-user-circle w-5 text-center"></i> My Profile
                    </button>
                    
                    <!-- Authority Specific -->
                    <div id="authorityNav" class="hidden space-y-1 mt-4 pt-4 border-t border-slate-100">
                        <div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Authority Tools</div>
                        <button onclick="switchView('assignments')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold transition-all">
                            <i class="fas fa-tasks w-5 text-center"></i> Assignments
                        </button>
                        <button onclick="switchView('analytics')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold transition-all">
                            <i class="fas fa-chart-bar w-5 text-center"></i> Analytics
                        </button>
                        <button onclick="switchView('teams')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-semibold transition-all">
                            <i class="fas fa-users-cog w-5 text-center"></i> Team Management
                        </button>
                    </div>
                </nav>
            </div>

            <!-- Quick Stats -->
            <div class="mt-auto p-6 border-t border-slate-100">
                <div class="text-xs font-bold text-slate-400 uppercase mb-3">Quick Stats</div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Active Reports</span>
                        <span class="text-sm font-bold text-blue-600" id="sidebarActive">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Resolved Today</span>
                        <span class="text-sm font-bold text-green-600" id="sidebarResolved">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Your Contributions</span>
                        <span class="text-sm font-bold text-purple-600" id="sidebarContributions">0</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 flex flex-col relative overflow-hidden">
            <header class="h-20 bg-white/80 backdrop-blur-xl border-b border-slate-200/50 flex items-center justify-between px-6 lg:px-8 z-20 sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center text-slate-600 hover:bg-slate-50 transition-colors">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 font-display" id="pageTitle">Dashboard</h2>
                        <p class="text-sm text-slate-500" id="pageSubtitle">Welcome back! Here's what's happening in your city.</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Notifications -->
                    <button class="relative w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-colors">
                        <i class="fas fa-bell"></i>
                        <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                    </button>
                    
                    <!-- Quick Stats for Authorities -->
                    <div id="quickStats" class="hidden lg:flex items-center gap-6">
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-400">CRITICAL</div>
                            <div class="text-xl font-bold text-red-600 flex items-center gap-1" id="quickCritical">0 <i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-400">IN PROGRESS</div>
                            <div class="text-xl font-bold text-yellow-600 flex items-center gap-1" id="quickProgress">0 <i class="fas fa-tasks"></i></div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-400">ASSIGNED</div>
                            <div class="text-xl font-bold text-purple-600 flex items-center gap-1" id="quickAssigned">0 <i class="fas fa-user-check"></i></div>
                        </div>
                    </div>
                    
                    <!-- New Report Button -->
                    <button onclick="openModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-95 flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> <span class="hidden sm:inline">New Report</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 scroll-smooth" id="mainScroll">
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="view-section space-y-8">
                    <!-- Hero Stats Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass p-6 rounded-2xl border border-slate-100 relative overflow-hidden group hover:border-blue-200 transition-all">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-slate-400 text-sm font-semibold uppercase tracking-wide">Total Reports</div>
                                    <i class="fas fa-chart-bar text-blue-500 text-xl"></i>
                                </div>
                                <div class="text-3xl md:text-4xl font-black text-slate-900 mb-2" id="statTotal">0</div>
                                <div class="text-sm text-slate-500">Across all categories</div>
                            </div>
                        </div>
                        <div class="glass p-6 rounded-2xl border border-slate-100 relative overflow-hidden group hover:border-yellow-200 transition-all">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-slate-400 text-sm font-semibold uppercase tracking-wide">Pending</div>
                                    <i class="fas fa-clock text-yellow-500 text-xl"></i>
                                </div>
                                <div class="text-3xl md:text-4xl font-black text-yellow-500 mb-2" id="statPending">0</div>
                                <div class="text-sm text-slate-500">Awaiting action</div>
                            </div>
                        </div>
                        <div class="glass p-6 rounded-2xl border border-slate-100 relative overflow-hidden group hover:border-green-200 transition-all">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/10 rounded-full"></div>
                            <div class="relative z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-slate-400 text-sm font-semibold uppercase tracking-wide">Resolved</div>
                                    <i class="fas fa-check-circle text-green-500 text-xl"></i>
                                </div>
                                <div class="text-3xl md:text-4xl font-black text-green-500 mb-2" id="statResolved">0</div>
                                <div class="text-sm text-slate-500">Completed issues</div>
                            </div>
                        </div>
                        <div class="glass p-6 rounded-2xl border border-slate-100 bg-gradient-to-br from-blue-600 to-indigo-700 text-white shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-blue-200 text-sm font-semibold uppercase tracking-wide">Your XP</div>
                                <i class="fas fa-star text-yellow-300 text-xl"></i>
                            </div>
                            <div class="text-3xl md:text-4xl font-black mb-2" id="statXP">0</div>
                            <div class="text-sm text-blue-200">Level <span id="statLevel">1</span> • Top 10%</div>
                            <div class="mt-4 w-full bg-blue-500/30 rounded-full h-2">
                                <div class="bg-gradient-to-r from-yellow-400 to-yellow-300 h-2 rounded-full w-1/3" id="xpProgress"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts & Activity Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="glass p-6 rounded-2xl border border-slate-100 h-full">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="font-bold text-slate-900 text-lg font-display flex items-center gap-2">
                                        <i class="fas fa-chart-line text-blue-500"></i> Weekly Activity Trend
                                    </h3>
                                    <select class="text-sm border border-slate-200 rounded-lg px-3 py-2 bg-white outline-none">
                                        <option>Last 7 Days</option>
                                        <option>Last 30 Days</option>
                                        <option>Last Quarter</option>
                                    </select>
                                </div>
                                <div class="h-64"><canvas id="mainChart"></canvas></div>
                            </div>
                        </div>
                        <div class="glass p-6 rounded-2xl border border-slate-100">
                            <h3 class="font-bold text-slate-900 text-lg font-display mb-6 flex items-center gap-2">
                                <i class="fas fa-chart-pie text-purple-500"></i> Issues by Category
                            </h3>
                            <div class="h-64"><canvas id="pieChart"></canvas></div>
                        </div>
                    </div>

                    <!-- Recent Activity & Quick Actions -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Recent Updates -->
                        <div class="glass p-6 rounded-2xl border border-slate-100 lg:col-span-2">
                            <h3 class="font-bold text-slate-900 text-lg font-display mb-6 flex items-center gap-2">
                                <i class="fas fa-bell text-yellow-500"></i> Recent Community Activity
                            </h3>
                            <div id="miniFeed" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                <!-- Dynamic content -->
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="glass p-6 rounded-2xl border border-slate-100">
                            <h3 class="font-bold text-slate-900 text-lg font-display mb-6 flex items-center gap-2">
                                <i class="fas fa-bolt text-green-500"></i> Quick Actions
                            </h3>
                            <div class="space-y-3">
                                <button onclick="openModal()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-blue-50 hover:bg-blue-100 text-blue-600 font-semibold transition-colors group">
                                    <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <span>Submit New Report</span>
                                </button>
                                <button onclick="switchView('map')" class="w-full flex items-center gap-3 p-4 rounded-xl bg-purple-50 hover:bg-purple-100 text-purple-600 font-semibold transition-colors group">
                                    <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <span>View Live Map</span>
                                </button>
                                <button onclick="switchView('leaderboard')" class="w-full flex items-center gap-3 p-4 rounded-xl bg-yellow-50 hover:bg-yellow-100 text-yellow-600 font-semibold transition-colors group">
                                    <div class="w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <span>Check Leaderboard</span>
                                </button>
                                <button onclick="switchView('profile')" class="w-full flex items-center gap-3 p-4 rounded-xl bg-green-50 hover:bg-green-100 text-green-600 font-semibold transition-colors group">
                                    <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <span>View Profile</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MAP -->
                <div id="view-map" class="view-section hidden h-full flex flex-col rounded-2xl overflow-hidden shadow-xl border border-slate-200 relative bg-gradient-to-br from-blue-50 to-indigo-50" style="min-height: 600px;">
                    <div id="leafletMap" class="w-full h-full z-0 absolute inset-0 rounded-2xl"></div>
                    
                    <!-- Map Controls -->
                    <div class="absolute top-6 left-6 z-[400] flex flex-wrap gap-3">
                        <button onclick="filterMap('all')" class="glass px-4 py-2.5 rounded-xl shadow-lg font-semibold text-sm text-slate-700 hover:bg-white transition-all flex items-center gap-2">
                            <i class="fas fa-layer-group"></i> All Issues
                        </button>
                        <button onclick="filterMap('Critical')" class="glass px-4 py-2.5 rounded-xl shadow-lg font-semibold text-sm text-red-600 hover:bg-white transition-all flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i> Critical
                        </button>
                        <button onclick="filterMap('High')" class="glass px-4 py-2.5 rounded-xl shadow-lg font-semibold text-sm text-orange-600 hover:bg-white transition-all flex items-center gap-2">
                            <i class="fas fa-exclamation-circle"></i> High Priority
                        </button>
                        <button onclick="filterMap('Pending')" class="glass px-4 py-2.5 rounded-xl shadow-lg font-semibold text-sm text-yellow-600 hover:bg-white transition-all flex items-center gap-2">
                            <i class="fas fa-clock"></i> Pending
                        </button>
                        <button onclick="filterMap('In Progress')" class="glass px-4 py-2.5 rounded-xl shadow-lg font-semibold text-sm text-blue-600 hover:bg-white transition-all flex items-center gap-2">
                            <i class="fas fa-tasks"></i> In Progress
                        </button>
                        <button onclick="filterMap('Resolved')" class="glass px-4 py-2.5 rounded-xl shadow-lg font-semibold text-sm text-green-600 hover:bg-white transition-all flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> Resolved
                        </button>
                    </div>
                    
                    <div class="absolute top-6 right-6 z-[400] space-y-3">
                        <button onclick="state.mapMode='pick'; pickLocation();" class="glass px-5 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl shadow-xl font-bold text-sm flex items-center gap-3 transition-all transform hover:scale-[1.02]">
                            <i class="fas fa-map-marker-alt"></i> Add Location
                        </button>
                        <button onclick="locateUser()" class="glass px-5 py-3 bg-white text-slate-700 rounded-xl shadow-lg font-semibold text-sm flex items-center gap-3 hover:bg-slate-50 transition-all">
                            <i class="fas fa-location-arrow"></i> My Location
                        </button>
                    </div>
                    
                    <!-- Map Legend -->
                    <div class="absolute bottom-6 left-6 z-[400] glass p-4 rounded-xl shadow-lg max-w-xs">
                        <div class="text-sm font-bold text-slate-700 mb-2">Map Legend</div>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-red-500"></div>
                                <span class="text-xs text-slate-600">Critical Priority</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-orange-500"></div>
                                <span class="text-xs text-slate-600">High Priority</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                                <span class="text-xs text-slate-600">Normal Priority</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-green-500"></div>
                                <span class="text-xs text-slate-600">Resolved</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Search -->
                    <div class="absolute top-6 left-1/2 transform -translate-x-1/2 z-[400] glass p-2 rounded-xl shadow-lg">
                        <div class="flex items-center gap-2">
                            <input type="text" id="mapSearch" placeholder="Search location..." class="px-4 py-2 rounded-lg bg-transparent border-none outline-none w-64">
                            <button class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: FEED (Social Media Style) -->
                <div id="view-feed" class="view-section hidden max-w-4xl mx-auto space-y-6 pb-12">
                    <!-- Feed Header -->
                    <div class="glass p-6 rounded-2xl">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900 font-display">Community Feed</h2>
                                <p class="text-slate-500">Stay updated with city issues and resolutions</p>
                            </div>
                            <div class="flex gap-3">
                                <select onchange="filterFeed(this.value)" class="text-sm border border-slate-200 rounded-xl px-4 py-2.5 bg-white outline-none">
                                    <option value="all">All Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Resolved">Resolved</option>
                                </select>
                                <select onchange="sortFeed(this.value)" class="text-sm border border-slate-200 rounded-xl px-4 py-2.5 bg-white outline-none">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="votes">Most Votes</option>
                                    <option value="comments">Most Comments</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Create Post -->
                        <div class="mb-8 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl border border-blue-100">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg" id="feedUserAvatar">U</div>
                                <div class="flex-1">
                                    <div class="font-bold text-slate-900" id="feedUserName">User</div>
                                    <div class="text-xs text-slate-500">Share an update or report an issue</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="openModal()" class="flex-1 flex items-center justify-center gap-2 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition-colors">
                                    <i class="fas fa-plus"></i> New Report
                                </button>
                                <button class="flex-1 flex items-center justify-center gap-2 py-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-xl font-semibold transition-colors">
                                    <i class="fas fa-image"></i> Add Photos
                                </button>
                            </div>
                        </div>
                        
                        <!-- Feed Container -->
                        <div id="feedContainer" class="space-y-6"></div>
                        
                        <!-- Loading More -->
                        <div class="text-center mt-8">
                            <button onclick="loadMoreFeed()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-semibold transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i> Load More
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LEADERBOARD -->
                <div id="view-leaderboard" class="view-section hidden max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <!-- Hero Section -->
                    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500 p-8 text-white shadow-2xl">
                        <div class="relative z-10">
                            <h2 class="text-4xl font-black mb-3 font-display">Top Community Heroes</h2>
                            <p class="text-yellow-100 text-lg mb-6">Recognizing citizens making our city better every day</p>
                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <div class="text-3xl font-black">15K+</div>
                                    <div class="text-sm text-yellow-100">Total Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-black">250+</div>
                                    <div class="text-sm text-yellow-100">Active Heroes</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-black">95%</div>
                                    <div class="text-sm text-yellow-100">Issue Resolution</div>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-crown absolute -right-8 -bottom-8 text-9xl text-white/20"></i>
                    </div>

                    <!-- Leaderboard -->
                    <div class="glass rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <h3 class="text-xl font-bold text-slate-900 font-display">Leaderboard Rankings</h3>
                                    <p class="text-slate-600">Top contributors this month</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="text-sm text-slate-500 flex items-center gap-2">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Points based on reports, votes & resolutions</span>
                                    </div>
                                    <select class="text-sm border border-slate-200 rounded-xl px-4 py-2 bg-white outline-none">
                                        <option>This Month</option>
                                        <option>All Time</option>
                                        <option>This Week</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="leaderboardList" class="divide-y divide-slate-100"></div>
                        
                        <!-- Your Rank -->
                        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-slate-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-bold text-slate-400 uppercase">Your Rank</div>
                                    <div class="text-2xl font-bold text-slate-900" id="yourRank">#0</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-slate-400 uppercase">Your Points</div>
                                    <div class="text-2xl font-bold text-blue-600" id="yourPoints">0 XP</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievement Badges -->
                    <div class="glass p-6 rounded-2xl border border-slate-100">
                        <h3 class="text-xl font-bold text-slate-900 font-display mb-6">Achievement Badges</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl border border-yellow-100">
                                <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white text-xl mx-auto mb-3">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="font-bold text-slate-900">First Report</div>
                                <div class="text-xs text-slate-500">Submitted first issue</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border border-blue-100">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center text-white text-xl mx-auto mb-3">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="font-bold text-slate-900">Top Voter</div>
                                <div class="text-xs text-slate-500">Voted on 50+ reports</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border border-green-100">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center text-white text-xl mx-auto mb-3">
                                    <i class="fas fa-check-double"></i>
                                </div>
                                <div class="font-bold text-slate-900">Resolver</div>
                                <div class="text-xs text-slate-500">10+ issues resolved</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl border border-purple-100">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center text-white text-xl mx-auto mb-3">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="font-bold text-slate-900">Community Hero</div>
                                <div class="text-xs text-slate-500">Top 10 contributor</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PROFILE -->
                <div id="view-profile" class="view-section hidden max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <!-- Profile Header -->
                    <div class="relative overflow-hidden rounded-2xl shadow-xl">
                        <div class="h-48 bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-8">
                            <div class="flex flex-col md:flex-row md:items-end gap-6">
                                <div class="w-32 h-32 rounded-2xl bg-white p-2 shadow-2xl -mt-16">
                                    <div class="w-full h-full rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-4xl font-bold text-white" id="profileAvatar">U</div>
                                </div>
                                <div class="flex-1 text-white">
                                    <h2 class="text-3xl font-bold mb-2" id="profileName">User Name</h2>
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold" id="profileRole">Citizen</span>
                                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold" id="profileDepartment"></span>
                                        <span class="bg-yellow-500/80 px-3 py-1 rounded-full text-sm font-semibold">Level <span id="profileLevel">1</span></span>
                                    </div>
                                    <p class="text-blue-100">Joined <span id="joinDate">Today</span> • <span id="reportCount">0</span> reports submitted</p>
                                </div>
                                <button onclick="switchView('dashboard')" class="glass px-6 py-3 rounded-xl font-semibold text-blue-600 hover:bg-white transition-colors">
                                    Edit Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass p-5 rounded-2xl text-center hover:transform hover:-translate-y-1 transition-all">
                            <div class="text-3xl font-bold text-blue-600 mb-2" id="profileReports">0</div>
                            <div class="text-sm text-slate-600 font-semibold">Reports</div>
                        </div>
                        <div class="glass p-5 rounded-2xl text-center hover:transform hover:-translate-y-1 transition-all">
                            <div class="text-3xl font-bold text-purple-600 mb-2" id="profileXP">0</div>
                            <div class="text-sm text-slate-600 font-semibold">XP Points</div>
                        </div>
                        <div class="glass p-5 rounded-2xl text-center hover:transform hover:-translate-y-1 transition-all">
                            <div class="text-3xl font-bold text-green-600 mb-2" id="profileResolved">0</div>
                            <div class="text-sm text-slate-600 font-semibold">Resolved</div>
                        </div>
                        <div class="glass p-5 rounded-2xl text-center hover:transform hover:-translate-y-1 transition-all">
                            <div class="text-3xl font-bold text-yellow-600 mb-2" id="profileRank">#0</div>
                            <div class="text-sm text-slate-600 font-semibold">Rank</div>
                        </div>
                    </div>

                    <!-- Activity & Badges -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- User Activity -->
                        <div class="glass p-6 rounded-2xl border border-slate-100 lg:col-span-2">
                            <h3 class="font-bold text-slate-900 text-lg font-display mb-6 flex items-center gap-2">
                                <i class="fas fa-history text-blue-500"></i> Recent Activity
                            </h3>
                            <div id="userActivity" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                        </div>

                        <!-- Badges -->
                        <div class="glass p-6 rounded-2xl border border-slate-100">
                            <h3 class="font-bold text-slate-900 text-lg font-display mb-6 flex items-center gap-2">
                                <i class="fas fa-award text-yellow-500"></i> Badges Earned
                            </h3>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="text-center p-3 bg-yellow-50 rounded-xl">
                                    <i class="fas fa-star text-yellow-500 text-xl mb-1"></i>
                                    <div class="text-xs font-bold text-slate-700">First Step</div>
                                </div>
                                <div class="text-center p-3 bg-blue-50 rounded-xl">
                                    <i class="fas fa-comment text-blue-500 text-xl mb-1"></i>
                                    <div class="text-xs font-bold text-slate-700">Contributor</div>
                                </div>
                                <div class="text-center p-3 bg-green-50 rounded-xl">
                                    <i class="fas fa-check text-green-500 text-xl mb-1"></i>
                                    <div class="text-xs font-bold text-slate-700">Helper</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AUTHORITY VIEW: ASSIGNMENTS -->
                <div id="view-assignments" class="view-section hidden max-w-6xl mx-auto space-y-8">
                    <div class="glass p-6 rounded-2xl border border-slate-100">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900 font-display">Assignments Dashboard</h2>
                                <p class="text-slate-600">Manage and assign issues to departments</p>
                            </div>
                            <div class="flex gap-3">
                                <button class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold flex items-center gap-2">
                                    <i class="fas fa-plus"></i> New Assignment
                                </button>
                                <button class="px-5 py-2.5 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-xl font-semibold flex items-center gap-2">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                        
                        <!-- Department Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
                                <div class="text-sm font-bold text-slate-400 mb-1">Pending Assignments</div>
                                <div class="text-2xl font-bold text-blue-600" id="assignPending">0</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-100">
                                <div class="text-sm font-bold text-slate-400 mb-1">In Progress</div>
                                <div class="text-2xl font-bold text-yellow-600" id="assignProgress">0</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-100">
                                <div class="text-sm font-bold text-slate-400 mb-1">Completed Today</div>
                                <div class="text-2xl font-bold text-green-600" id="assignCompleted">0</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-100">
                                <div class="text-sm font-bold text-slate-400 mb-1">Your Department</div>
                                <div class="text-2xl font-bold text-purple-600" id="assignDept">-</div>
                            </div>
                        </div>
                        
                        <!-- Assignments Table -->
                        <div class="overflow-x-auto rounded-xl border border-slate-200">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="text-left p-4 font-semibold text-slate-700">Issue</th>
                                        <th class="text-left p-4 font-semibold text-slate-700">Priority</th>
                                        <th class="text-left p-4 font-semibold text-slate-700">Department</th>
                                        <th class="text-left p-4 font-semibold text-slate-700">Assigned To</th>
                                        <th class="text-left p-4 font-semibold text-slate-700">Status</th>
                                        <th class="text-left p-4 font-semibold text-slate-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assignmentsTable" class="divide-y divide-slate-100">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="lg:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-xl border-t border-slate-200/50 flex justify-around p-3 z-30 pb-safe">
            <button onclick="switchView('dashboard')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item transition-colors" id="mob-dashboard">
                <i class="fas fa-chart-pie text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Dashboard</span>
            </button>
            <button onclick="switchView('map')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item transition-colors" id="mob-map">
                <i class="fas fa-map text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Map</span>
            </button>
            <button onclick="openModal()" class="flex flex-col items-center justify-center -mt-10">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-blue-500/30 pulse-glow">
                    <i class="fas fa-plus text-2xl"></i>
                </div>
            </button>
            <button onclick="switchView('feed')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item transition-colors" id="mob-feed">
                <i class="fas fa-newspaper text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Feed</span>
            </button>
            <button onclick="switchView('profile')" class="flex flex-col items-center p-2 text-slate-400 hover:text-blue-600 mobile-nav-item transition-colors" id="mob-profile">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Profile</span>
            </button>
        </nav>
    </div>

    <!-- REPORT MODAL (WIZARD) -->
    <div id="reportModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-slide-in-right flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="font-bold text-slate-900 text-xl font-display">Submit New Report</h3>
                    <p class="text-sm text-slate-500" id="stepIndicator">Step 1 of 4 - Select Category</p>
                </div>
                <button onclick="closeModal('reportModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Step Progress -->
                <div class="mb-8">
                    <div class="flex justify-between mb-2">
                        <div class="text-xs font-semibold text-blue-600">Category</div>
                        <div class="text-xs font-semibold text-slate-400">Details</div>
                        <div class="text-xs font-semibold text-slate-400">Priority</div>
                        <div class="text-xs font-semibold text-slate-400">Review</div>
                    </div>
                    <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 25%" id="stepProgress"></div>
                    </div>
                </div>

                <!-- Step 1: Category -->
                <div id="step-1" class="wizard-step space-y-6">
                    <div>
                        <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Select Issue Category</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <button onclick="selectCategory('Infrastructure')" class="cat-btn p-5 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <i class="fas fa-road text-3xl mb-3 text-slate-400 group-hover:text-blue-600 transition-colors"></i>
                                <div class="font-bold text-slate-700 text-lg">Infrastructure</div>
                                <p class="text-sm text-slate-500 mt-2">Roads, bridges, public buildings</p>
                            </button>
                            <button onclick="selectCategory('Sanitation')" class="cat-btn p-5 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <i class="fas fa-trash text-3xl mb-3 text-slate-400 group-hover:text-blue-600 transition-colors"></i>
                                <div class="font-bold text-slate-700 text-lg">Sanitation</div>
                                <p class="text-sm text-slate-500 mt-2">Garbage, cleanliness, waste</p>
                            </button>
                            <button onclick="selectCategory('Safety')" class="cat-btn p-5 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <i class="fas fa-shield-alt text-3xl mb-3 text-slate-400 group-hover:text-blue-600 transition-colors"></i>
                                <div class="font-bold text-slate-700 text-lg">Public Safety</div>
                                <p class="text-sm text-slate-500 mt-2">Security, hazards, emergency</p>
                            </button>
                            <button onclick="selectCategory('Transport')" class="cat-btn p-5 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <i class="fas fa-bus text-3xl mb-3 text-slate-400 group-hover:text-blue-600 transition-colors"></i>
                                <div class="font-bold text-slate-700 text-lg">Transport</div>
                                <p class="text-sm text-slate-500 mt-2">Traffic, public transport</p>
                            </button>
                            <button onclick="selectCategory('Utilities')" class="cat-btn p-5 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <i class="fas fa-bolt text-3xl mb-3 text-slate-400 group-hover:text-blue-600 transition-colors"></i>
                                <div class="font-bold text-slate-700 text-lg">Utilities</div>
                                <p class="text-sm text-slate-500 mt-2">Water, electricity, internet</p>
                            </button>
                            <button onclick="selectCategory('Other')" class="cat-btn p-5 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <i class="fas fa-ellipsis-h text-3xl mb-3 text-slate-400 group-hover:text-blue-600 transition-colors"></i>
                                <div class="font-bold text-slate-700 text-lg">Other</div>
                                <p class="text-sm text-slate-500 mt-2">Any other city issues</p>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" id="selectedCategory">
                </div>

                <!-- Step 2: Details -->
                <div id="step-2" class="wizard-step hidden space-y-6">
                    <div class="space-y-6">
                        <div>
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center justify-between">
                                <span>Evidence Photos</span>
                                <span class="text-xs font-normal text-slate-400">Max 3 photos</span>
                            </label>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="relative h-32 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all flex flex-col items-center justify-center cursor-pointer overflow-hidden group" onclick="document.getElementById('inpImg1').click()">
                                    <input type="file" id="inpImg1" accept="image/*" class="hidden" onchange="window.previewImage(this, 'imgPreview1', 'uploadPlaceholder1')">
                                    <div id="uploadPlaceholder1" class="text-center p-4">
                                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm mx-auto mb-2 text-blue-500 group-hover:scale-110 transition-transform">
                                            <i class="fas fa-camera"></i>
                                        </div>
                                        <p class="text-xs text-slate-500 font-bold">Add Photo</p>
                                    </div>
                                    <img id="imgPreview1" class="absolute inset-0 w-full h-full object-cover hidden">
                                </div>
                                <div class="relative h-32 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all flex flex-col items-center justify-center cursor-pointer overflow-hidden group" onclick="document.getElementById('inpImg2').click()">
                                    <input type="file" id="inpImg2" accept="image/*" class="hidden" onchange="window.previewImage(this, 'imgPreview2', 'uploadPlaceholder2')">
                                    <div id="uploadPlaceholder2" class="text-center p-4">
                                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm mx-auto mb-2 text-blue-500 group-hover:scale-110 transition-transform">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <p class="text-xs text-slate-500 font-bold">Add Photo</p>
                                    </div>
                                    <img id="imgPreview2" class="absolute inset-0 w-full h-full object-cover hidden">
                                </div>
                                <div class="relative h-32 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all flex flex-col items-center justify-center cursor-pointer overflow-hidden group" onclick="document.getElementById('inpImg3').click()">
                                    <input type="file" id="inpImg3" accept="image/*" class="hidden" onchange="window.previewImage(this, 'imgPreview3', 'uploadPlaceholder3')">
                                    <div id="uploadPlaceholder3" class="text-center p-4">
                                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm mx-auto mb-2 text-blue-500 group-hover:scale-110 transition-transform">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <p class="text-xs text-slate-500 font-bold">Add Photo</p>
                                    </div>
                                    <img id="imgPreview3" class="absolute inset-0 w-full h-full object-cover hidden">
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">AI will analyze images to categorize and prioritize</p>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Detailed Description</label>
                            <textarea id="inpDesc" rows="4" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none" placeholder="Describe the issue in detail. Be specific about location, impact, and any safety concerns..."></textarea>
                            <div class="flex justify-between">
                                <p class="text-xs text-slate-400">Include specific details for faster resolution</p>
                                <p class="text-xs text-slate-400" id="charCount">0/500</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Additional Details</label>
                            <input type="text" id="inpAddress" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Exact address or landmark...">
                            <input type="text" id="inpLandmark" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Nearest landmark...">
                        </div>
                    </div>
                </div>

                <!-- Step 3: Priority & Department -->
                <div id="step-3" class="wizard-step hidden space-y-6">
                    <div class="space-y-6">
                        <div>
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Priority Level</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onclick="setPriority('Low')" class="prio-btn flex flex-col items-center p-4 rounded-xl border-2 border-slate-200 hover:border-green-500 hover:bg-green-50 transition-all" data-val="Low">
                                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600 mb-3">
                                        <i class="fas fa-check text-xl"></i>
                                    </div>
                                    <div class="font-bold text-slate-700">Low</div>
                                    <p class="text-xs text-slate-500 text-center">Minor issue</p>
                                </button>
                                <button onclick="setPriority('Normal')" class="prio-btn flex flex-col items-center p-4 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all" data-val="Normal">
                                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mb-3">
                                        <i class="fas fa-exclamation text-xl"></i>
                                    </div>
                                    <div class="font-bold text-slate-700">Normal</div>
                                    <p class="text-xs text-slate-500 text-center">Standard priority</p>
                                </button>
                                <button onclick="setPriority('High')" class="prio-btn flex flex-col items-center p-4 rounded-xl border-2 border-slate-200 hover:border-orange-500 hover:bg-orange-50 transition-all" data-val="High">
                                    <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 mb-3">
                                        <i class="fas fa-exclamation-triangle text-xl"></i>
                                    </div>
                                    <div class="font-bold text-slate-700">High</div>
                                    <p class="text-xs text-slate-500 text-center">Urgent attention</p>
                                </button>
                                <button onclick="setPriority('Critical')" class="prio-btn flex flex-col items-center p-4 rounded-xl border-2 border-slate-200 hover:border-red-500 hover:bg-red-50 transition-all" data-val="Critical">
                                    <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center text-red-600 mb-3">
                                        <i class="fas fa-skull-crossbones text-xl"></i>
                                    </div>
                                    <div class="font-bold text-slate-700">Critical</div>
                                    <p class="text-xs text-slate-500 text-center">Emergency</p>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Department Assignment (for authorities) -->
                        <div id="departmentSection" class="space-y-3 hidden">
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Assign to Department</label>
                            <select id="assignDepartment" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                <option value="">Select Department</option>
                                <option value="Sanitation">Sanitation Department</option>
                                <option value="Infrastructure">Public Works</option>
                                <option value="Transport">Transport Authority</option>
                                <option value="Safety">Public Safety</option>
                                <option value="Utilities">Utilities Department</option>
                                <option value="Planning">City Planning</option>
                            </select>
                        </div>
                        
                        <input type="hidden" id="selectedPriority" value="Normal">
                    </div>
                </div>

                <!-- Step 4: Location & Review -->
                <div id="step-4" class="wizard-step hidden space-y-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-100 flex items-start gap-4">
                        <i class="fas fa-info-circle text-blue-500 text-xl mt-0.5"></i>
                        <div>
                            <h5 class="font-bold text-blue-700 mb-1">Location Accuracy is Key</h5>
                            <p class="text-sm text-blue-600">Pinpointing the exact location helps our team resolve issues 3x faster. Use the map for precise placement.</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Location Details</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div class="flex gap-3">
                                    <input id="inpLoc" type="text" class="flex-1 p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Coordinates will appear here..." readonly>
                                    <button onclick="pickLocation()" class="px-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all hover:scale-[1.02]">
                                        <i class="fas fa-map-marker-alt mr-2"></i> Pick on Map
                                    </button>
                                </div>
                                <input type="text" id="inpLocationName" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Location name (e.g., Central Park)">
                            </div>
                            <div class="space-y-3">
                                <input type="text" id="inpCity" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="City" value="New York">
                                <input type="text" id="inpZipCode" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Zip Code">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Review Summary -->
                    <div class="mt-6 p-5 bg-gradient-to-br from-slate-50 to-white rounded-xl border border-slate-200">
                        <h4 class="text-lg font-bold text-slate-900 mb-4 font-display">Review Your Report</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <div class="text-sm font-bold text-slate-400">Category</div>
                                <div class="text-base font-bold text-slate-700" id="reviewCategory">-</div>
                            </div>
                            <div class="space-y-2">
                                <div class="text-sm font-bold text-slate-400">Priority</div>
                                <div class="text-base font-bold" id="reviewPriority">-</div>
                            </div>
                            <div class="space-y-2">
                                <div class="text-sm font-bold text-slate-400">Images</div>
                                <div class="text-base font-bold text-slate-700" id="reviewImage">0 uploaded</div>
                            </div>
                            <div class="space-y-2">
                                <div class="text-sm font-bold text-slate-400">Location</div>
                                <div class="text-base font-bold text-slate-700" id="reviewLocation">Not selected</div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <div class="text-sm font-bold text-slate-400 mb-2">Description Preview</div>
                            <p class="text-sm text-slate-600 line-clamp-3" id="reviewDescription">No description provided</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-between">
                <button onclick="prevStep()" id="btnBack" class="px-8 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors hidden">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>
                <button onclick="nextStep()" id="btnNext" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all transform hover:scale-[1.02] ml-auto">
                    Continue <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- COMMENTS MODAL -->
    <div id="commentsModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-in-right flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="font-bold text-slate-900 text-lg font-display">Comments & Discussion</h3>
                    <p class="text-sm text-slate-500">Share your thoughts and updates</p>
                </div>
                <button onclick="closeModal('commentsModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="commentsList" class="space-y-6 mb-6"></div>
                <div class="flex gap-3">
                    <input type="text" id="newComment" class="flex-1 p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Add a comment...">
                    <button onclick="postComment()" class="px-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold transition-all hover:scale-[1.02]">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <input type="hidden" id="currentReportId">
        </div>
    </div>

    <!-- RESOLUTION PROOF MODAL -->
    <div id="resolveModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-in-right">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white">
                <div>
                    <h3 class="font-bold text-slate-900 text-lg font-display">Update Issue Status</h3>
                    <p class="text-sm text-slate-500">Mark as resolved or in progress</p>
                </div>
                <button onclick="closeModal('resolveModal')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Update Status</label>
                    <select id="statusSelect" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all">
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                
                <!-- Department Assignment -->
                <div class="space-y-3" id="resolveDepartmentSection">
                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Assign Department</label>
                    <select id="resolveDepartment" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all">
                        <option value="">Select Department</option>
                        <option value="Sanitation">Sanitation Department</option>
                        <option value="Infrastructure">Public Works</option>
                        <option value="Transport">Transport Authority</option>
                        <option value="Safety">Public Safety</option>
                        <option value="Utilities">Utilities Department</option>
                        <option value="Planning">City Planning</option>
                    </select>
                </div>
                
                <!-- Assigned Official -->
                <div class="space-y-3" id="officialSection">
                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Assigned Official</label>
                    <select id="assignedOfficial" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all">
                        <option value="">Select Official</option>
                        <option value="John Smith">John Smith - Team Lead</option>
                        <option value="Sarah Johnson">Sarah Johnson - Supervisor</option>
                        <option value="Mike Wilson">Mike Wilson - Field Agent</option>
                        <option value="Lisa Brown">Lisa Brown - Coordinator</option>
                    </select>
                </div>
                
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Proof of Resolution (Required)</label>
                    <div class="relative h-40 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all flex flex-col items-center justify-center cursor-pointer overflow-hidden" onclick="document.getElementById('resImg').click()">
                        <input type="file" id="resImg" accept="image/*" class="hidden" onchange="window.previewImage(this, 'resImgPreview', 'resPlaceholder')">
                        <div id="resPlaceholder" class="text-center p-4">
                            <i class="fas fa-camera text-3xl text-slate-300 mb-3"></i>
                            <p class="text-sm text-slate-500 font-bold">Upload Proof Photo</p>
                            <p class="text-xs text-slate-400">Required for resolution</p>
                        </div>
                        <img id="resImgPreview" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider">Resolution Notes</label>
                    <textarea id="resNote" rows="3" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all resize-none" placeholder="Describe how the issue was resolved, time taken, resources used..."></textarea>
                </div>
                
                <input type="hidden" id="resolveId">
                
                <button onclick="confirmResolve()" id="btnConfirmResolve" class="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-green-500/20 transition-all transform hover:scale-[1.02]">
                    Update Status & Notify Citizen
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-6 right-6 z-[100] glass shadow-2xl rounded-xl p-4 border-l-4 border-blue-500 transform translate-x-[200%] transition-all duration-300 flex items-center gap-3 min-w-80">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white" id="toastIcon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="flex-1">
            <h4 id="toastTitle" class="font-bold text-sm text-slate-900">Notice</h4>
            <p id="toastMsg" class="text-xs text-slate-600">Message here</p>
        </div>
        <button onclick="hideToast()" class="w-6 h-6 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-400">
            <i class="fas fa-times text-xs"></i>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, increment, arrayUnion, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG (chatok-38a07)
        const firebaseConfig = {
            apiKey: "AIzaSyC6ImTLczrMo8m07fjYWVCeOjszrzgYw1w",
            authDomain: "chatok-38a07.firebaseapp.com",
            projectId: "chatok-38a07",
            storageBucket: "chatok-38a07.firebasestorage.app",
            messagingSenderId: "405598576994",
            appId: "1:405598576994:web:cdcb15ea806924753acc3b"
        };
        const appId = 'civic-connect-reborn';

        // STATE
        const state = {
            user: null, 
            role: 'citizen', 
            department: '',
            reports: [], 
            map: null, 
            markers: [],
            mapMode: 'view', 
            tempMarker: null, 
            name: 'Anonymous',
            wizardStep: 1, 
            currentFilter: 'all', 
            activeMapFilter: 'all',
            comments: {}, 
            userActivities: [],
            userLocation: null,
            feedPage: 1,
            feedPerPage: 10
        };

        // INIT FIREBASE
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ENTRY SCREEN FUNCTIONS
        window.selectUserType = (type) => {
            state.role = type;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('entryScreen').classList.add('hidden');
            if(type === 'authority') {
                document.getElementById('departmentSelect').required = true;
            }
        };

        window.goBackToEntry = () => {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('entryScreen').classList.remove('hidden');
        };

        // AUTH
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.warn("Auth fallback", e);
                state.user = { uid: 'guest-' + Date.now() }; 
                startListener(); 
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) { 
                state.user = user; 
                startListener(); 
            }
        });

        // CORE FUNCTIONS
        window.setRole = (r) => {
            state.role = r;
            const citizenBtn = document.getElementById('btnCit');
            const authBtn = document.getElementById('btnAuth');
            
            if(r === 'citizen') {
                citizenBtn.className = "py-3 glass-dark text-blue-400 font-bold rounded-xl border-2 border-blue-500 transition-all hover:border-blue-500 hover:bg-blue-500/10";
                authBtn.className = "py-3 glass-dark text-purple-400 font-bold rounded-xl border-2 border-purple-500/50 transition-all hover:border-purple-500 hover:bg-purple-500/10";
                document.getElementById('departmentSelect').required = false;
            } else {
                citizenBtn.className = "py-3 glass-dark text-blue-400 font-bold rounded-xl border-2 border-blue-500/50 transition-all hover:border-blue-500 hover:bg-blue-500/10";
                authBtn.className = "py-3 glass-dark text-purple-400 font-bold rounded-xl border-2 border-purple-500 transition-all hover:border-purple-500 hover:bg-purple-500/10";
                document.getElementById('departmentSelect').required = true;
            }
        };

        window.handleLogin = () => {
            const name = document.getElementById('loginName').value || 'Anonymous User';
            const department = document.getElementById('departmentSelect').value;
            
            if(state.role === 'authority' && !department) {
                showToast('Required', 'Please select your department', 'error');
                return;
            }
            
            state.name = name;
            state.department = department;
            
            // Update UI with user info
            document.getElementById('userName').innerText = name;
            document.getElementById('userRole').innerText = state.role.charAt(0).toUpperCase() + state.role.slice(1);
            document.getElementById('sidebarRole').innerText = state.role === 'authority' ? 'Authority Dashboard' : 'Citizen Dashboard';
            document.getElementById('userAvatar').innerText = name[0];
            document.getElementById('feedUserName').innerText = name;
            document.getElementById('feedUserAvatar').innerText = name[0];
            document.getElementById('profileName').innerText = name;
            document.getElementById('profileRole').innerText = state.role.charAt(0).toUpperCase() + state.role.slice(1);
            document.getElementById('profileDepartment').innerText = department || '';
            document.getElementById('profileAvatar').innerText = name[0];
            document.getElementById('userDepartment').innerText = department || '';
            
            // Update department in profile
            if(department) {
                document.getElementById('profileDepartment').innerText = department;
            }
            
            // Hide auth screens, show main layout
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('entryScreen').classList.add('hidden');
            document.getElementById('appLayout').classList.remove('hidden');
            
            // Initialize map
            initMap();
            
            // Show/hide authority features
            if(state.role === 'authority') {
                document.getElementById('quickStats').classList.remove('hidden');
                document.getElementById('authorityNav').classList.remove('hidden');
                document.getElementById('departmentSection').classList.remove('hidden');
                document.getElementById('resolveDepartmentSection').classList.remove('hidden');
                document.getElementById('officialSection').classList.remove('hidden');
                document.getElementById('assignDepartment').value = department;
                document.getElementById('assignDept').innerText = department;
            }
            
            // Start listening for data
            if(state.reports.length === 0) startListener();
            
            showToast('Welcome!', `Welcome to CivicConnect ${state.role}`, 'success');
        };

        window.switchView = (id) => {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // Update desktop navigation
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-blue-50', 'text-blue-600', 'hover:bg-blue-100');
                el.classList.add('hover:bg-slate-100', 'text-slate-600');
            });
            
            const deskBtn = document.getElementById('nav-'+id);
            if(deskBtn) {
                deskBtn.classList.add('bg-blue-50', 'text-blue-600');
                deskBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
            }

            // Update mobile navigation
            document.querySelectorAll('.mobile-nav-item').forEach(el => {
                el.classList.remove('text-blue-600', 'active');
                el.classList.add('text-slate-400');
            });
            
            const mobBtn = document.getElementById('mob-'+id);
            if(mobBtn) {
                mobBtn.classList.add('text-blue-600', 'active');
                mobBtn.classList.remove('text-slate-400');
            }
            
            // Show selected view
            document.getElementById('view-'+id).classList.remove('hidden');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'map': 'Live City Map',
                'feed': 'Community Feed',
                'leaderboard': 'Leaderboard',
                'profile': 'My Profile',
                'assignments': 'Assignments',
                'analytics': 'Analytics',
                'teams': 'Team Management'
            };
            
            const subtitles = {
                'dashboard': 'Welcome back! Here\'s what\'s happening in your city.',
                'map': 'Real-time tracking of city issues and resolutions.',
                'feed': 'Stay updated with community reports and discussions.',
                'leaderboard': 'Top contributors making our city better.',
                'profile': 'Your activity, stats, and achievements.',
                'assignments': 'Manage and assign issues to departments.',
                'analytics': 'Detailed insights and city metrics.',
                'teams': 'Manage your department and team members.'
            };
            
            document.getElementById('pageTitle').innerText = titles[id] || id.charAt(0).toUpperCase() + id.slice(1);
            document.getElementById('pageSubtitle').innerText = subtitles[id] || '';
            
            // Handle map resize
            if(id === 'map' && state.map) {
                setTimeout(() => {
                    state.map.invalidateSize();
                    if(state.activeMapFilter !== 'all') filterMap(state.activeMapFilter);
                }, 100);
            }
            
            // Smooth scroll to top
            document.getElementById('mainScroll').scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleSidebar = () => {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('flex');
        };

        // MAP FUNCTIONS
        function initMap() {
            if(state.map) return;
            
            // Default to New York City
            const defaultCoords = [40.7128, -74.0060];
            state.map = L.map('leafletMap', { 
                zoomControl: false,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                touchZoom: true,
                dragging: true
            }).setView(defaultCoords, 13);
            
            // Add tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19,
                id: 'carto-voyager'
            }).addTo(state.map);
            
            // Add zoom control
            L.control.zoom({ position: 'bottomright' }).addTo(state.map);
            
            // Add click handler for location picking
            state.map.on('click', (e) => {
                if(state.mapMode === 'pick') {
                    if(state.tempMarker) state.map.removeLayer(state.tempMarker);
                    
                    // Add custom marker
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white shadow-2xl animate-pulse">
                                  <i class="fas fa-map-marker-alt text-xl"></i>
                               </div>`,
                        iconSize: [48, 48],
                        iconAnchor: [24, 48]
                    });
                    
                    state.tempMarker = L.marker(e.latlng, {icon, draggable: true}).addTo(state.map);
                    
                    // Format coordinates
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    
                    // Update form fields
                    document.getElementById('inpLoc').value = `${lat}, ${lng}`;
                    document.getElementById('reviewLocation').innerText = `${lat}, ${lng}`;
                    
                    // Get location name (reverse geocode simulation)
                    getLocationName(lat, lng);
                    
                    // Update map mode
                    state.mapMode = 'view';
                    document.getElementById('leafletMap').style.cursor = '';
                    
                    showToast('Location Selected', 'Returning to report wizard', 'success');
                    
                    // Return to modal
                    setTimeout(() => {
                        document.getElementById('reportModal').classList.remove('hidden');
                        state.wizardStep = 4;
                        updateWizardUI();
                        updateReviewSummary();
                    }, 1000);
                    
                    // Make marker draggable
                    state.tempMarker.on('dragend', function(event) {
                        const marker = event.target;
                        const position = marker.getLatLng();
                        const lat = position.lat.toFixed(6);
                        const lng = position.lng.toFixed(6);
                        document.getElementById('inpLoc').value = `${lat}, ${lng}`;
                        document.getElementById('reviewLocation').innerText = `${lat}, ${lng}`;
                        getLocationName(lat, lng);
                    });
                }
            });
            
            // Try to get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    state.userLocation = [position.coords.latitude, position.coords.longitude];
                    state.map.setView(state.userLocation, 15);
                    
                    // Add user location marker
                    const userIcon = L.divIcon({
                        className: 'user-marker',
                        html: `<div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white shadow-lg">
                                  <i class="fas fa-user text-sm"></i>
                               </div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });
                    
                    L.marker(state.userLocation, {icon: userIcon})
                        .addTo(state.map)
                        .bindPopup('Your current location')
                        .openPopup();
                }, (error) => {
                    console.warn('Geolocation error:', error);
                    showToast('Location', 'Using default location', 'info');
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            }
        }

        function updateMarkers() {
            if(!state.map) return;
            
            // Clear existing markers
            state.markers.forEach(m => state.map.removeLayer(m));
            state.markers = [];
            
            // Filter reports based on active filter
            let filteredReports = state.reports;
            if(state.activeMapFilter !== 'all') {
                if(['Critical', 'High', 'Normal', 'Low'].includes(state.activeMapFilter)) {
                    filteredReports = state.reports.filter(r => r.priority === state.activeMapFilter);
                } else {
                    filteredReports = state.reports.filter(r => r.status === state.activeMapFilter);
                }
            }
            
            // Add markers for filtered reports
            filteredReports.forEach(r => {
                if(r.coords && r.coords.length === 2) {
                    // Determine marker color based on priority/status
                    let color = '#3b82f6'; // Default blue for Normal
                    let iconClass = 'fa-exclamation';
                    
                    if(r.priority === 'Critical') {
                        color = '#ef4444';
                        iconClass = 'fa-skull-crossbones';
                    } else if(r.priority === 'High') {
                        color = '#f97316';
                        iconClass = 'fa-exclamation-triangle';
                    } else if(r.priority === 'Low') {
                        color = '#22c55e';
                        iconClass = 'fa-check';
                    }
                    
                    if(r.status === 'Resolved') {
                        color = '#10b981';
                        iconClass = 'fa-check-circle';
                    } else if(r.status === 'In Progress') {
                        color = '#eab308';
                        iconClass = 'fa-tasks';
                    }
                    
                    // Create custom marker
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-lg" style="background:${color}">
                                  <i class="fas ${iconClass}"></i>
                               </div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });
                    
                    // Create popup content
                    const popupContent = `
                        <div class="font-sans p-3 max-w-xs">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <b class="text-sm text-slate-900">${r.category}</b>
                                    <div class="text-xs text-slate-500">${r.user}</div>
                                </div>
                                <span class="text-xs px-2 py-1 rounded ${getPriorityClass(r.priority)}">${r.priority}</span>
                            </div>
                            <p class="text-sm text-slate-700 mb-2 line-clamp-2">${r.description}</p>
                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <span>${r.status}</span>
                                <span>${r.department ? r.department : 'Unassigned'}</span>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <button onclick="switchView('feed');" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                    View Details
                                </button>
                                ${state.role === 'authority' ? `
                                <button onclick="openResolveModal('${r.id}')" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">
                                    Resolve
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    const m = L.marker(r.coords, {icon}).addTo(state.map).bindPopup(popupContent);
                    state.markers.push(m);
                }
            });
        }

        window.filterMap = (filter) => {
            state.activeMapFilter = filter;
            updateMarkers();
            
            const filterNames = {
                'all': 'All Issues',
                'Critical': 'Critical Priority',
                'High': 'High Priority',
                'Pending': 'Pending Status',
                'In Progress': 'In Progress',
                'Resolved': 'Resolved'
            };
            
            showToast('Map Filter', `Showing ${filterNames[filter] || filter}`, 'info');
        };

        window.pickLocation = () => {
            document.getElementById('reportModal').classList.add('hidden');
            switchView('map');
            state.mapMode = 'pick';
            document.getElementById('leafletMap').style.cursor = 'crosshair';
            
            // Center map on user location if available
            if(state.userLocation) {
                state.map.setView(state.userLocation, 15);
            }
            
            showToast('Select Location', 'Click on the map to place marker', 'info');
        };

        window.locateUser = () => {
            if(state.userLocation) {
                state.map.setView(state.userLocation, 15);
                showToast('Location', 'Centered on your location', 'success');
            } else if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLoc = [position.coords.latitude, position.coords.longitude];
                    state.map.setView(userLoc, 15);
                    showToast('Location', 'Centered on your location', 'success');
                }, () => {
                    showToast('Location', 'Unable to get your location', 'error');
                });
            }
        };

        function getLocationName(lat, lng) {
            // Simulated reverse geocoding
            const locations = [
                'Central Park, New York',
                'Times Square, Manhattan',
                'Brooklyn Bridge, NYC',
                'Empire State Building',
                'Statue of Liberty'
            ];
            
            const randomLocation = locations[Math.floor(Math.random() * locations.length)];
            document.getElementById('inpLocationName').value = randomLocation;
            document.getElementById('reviewLocation').innerText = randomLocation;
        }

        function getPriorityClass(priority) {
            const classes = {
                'Critical': 'bg-red-100 text-red-800',
                'High': 'bg-orange-100 text-orange-800',
                'Normal': 'bg-blue-100 text-blue-800',
                'Low': 'bg-green-100 text-green-800'
            };
            return classes[priority] || 'bg-slate-100 text-slate-800';
        }

        // WIZARD FUNCTIONS
        window.openModal = () => { 
            state.wizardStep = 1;
            
            // Reset form
            document.getElementById('selectedCategory').value = '';
            document.getElementById('inpDesc').value = '';
            document.getElementById('selectedPriority').value = 'Normal';
            document.getElementById('inpLoc').value = '';
            document.getElementById('inpAddress').value = '';
            document.getElementById('inpLandmark').value = '';
            document.getElementById('inpLocationName').value = '';
            document.getElementById('inpCity').value = 'New York';
            document.getElementById('inpZipCode').value = '';
            
            // Reset file inputs
            ['inpImg1', 'inpImg2', 'inpImg3'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            // Reset previews
            ['imgPreview1', 'imgPreview2', 'imgPreview3'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.src = '';
            });
            
            // Reset placeholders
            ['uploadPlaceholder1', 'uploadPlaceholder2', 'uploadPlaceholder3'].forEach(id => {
                document.getElementById(id).classList.remove('hidden');
            });
            
            // Reset UI
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            document.querySelectorAll('.prio-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50');
            });
            
            // Set default priority
            document.querySelector('.prio-btn[data-val="Normal"]').classList.add('border-blue-500', 'bg-blue-50');
            
            // Update wizard
            updateWizardUI();
            document.getElementById('reportModal').classList.remove('hidden');
            
            // Focus on description textarea
            setTimeout(() => {
                document.getElementById('inpDesc').focus();
            }, 300);
        };
        
        window.closeModal = (id) => { 
            document.getElementById(id).classList.add('hidden'); 
            if(id === 'reportModal') {
                state.mapMode = 'view';
                document.getElementById('leafletMap').style.cursor = '';
                if(state.tempMarker) {
                    state.map.removeLayer(state.tempMarker);
                    state.tempMarker = null;
                }
            }
        };

        window.selectCategory = (cat) => {
            document.getElementById('selectedCategory').value = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            // Find and highlight selected category button
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.textContent.includes(cat)) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                }
            });
            
            updateReviewSummary();
        };

        window.setPriority = (prio) => {
            document.getElementById('selectedPriority').value = prio;
            document.querySelectorAll('.prio-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50');
            });
            
            const selectedBtn = document.querySelector(`.prio-btn[data-val="${prio}"]`);
            if(selectedBtn) {
                if(prio === 'Low') selectedBtn.classList.add('border-green-500', 'bg-green-50');
                else if(prio === 'Normal') selectedBtn.classList.add('border-blue-500', 'bg-blue-50');
                else if(prio === 'High') selectedBtn.classList.add('border-orange-500', 'bg-orange-50');
                else if(prio === 'Critical') selectedBtn.classList.add('border-red-500', 'bg-red-50');
            }
            
            updateReviewSummary();
        };

        window.nextStep = () => {
            if(state.wizardStep === 1) {
                if(!document.getElementById('selectedCategory').value) {
                    showToast('Required', 'Please select a category', 'error');
                    return;
                }
                state.wizardStep = 2;
            } else if (state.wizardStep === 2) {
                const desc = document.getElementById('inpDesc').value.trim();
                if(!desc) {
                    showToast('Required', 'Please add a description', 'error');
                    return;
                }
                if(desc.length < 10) {
                    showToast('Description', 'Please provide more details (min 10 characters)', 'warning');
                    return;
                }
                state.wizardStep = 3;
            } else if (state.wizardStep === 3) {
                if(!document.getElementById('selectedPriority').value) {
                    showToast('Required', 'Please select priority', 'error');
                    return;
                }
                state.wizardStep = 4;
                updateReviewSummary();
            } else if (state.wizardStep === 4) {
                if(!document.getElementById('inpLoc').value) {
                    showToast('Required', 'Please select a location', 'error');
                    return;
                }
                submitReport();
                return;
            }
            updateWizardUI();
        };

        window.prevStep = () => { 
            if(state.wizardStep > 1) { 
                state.wizardStep--; 
                updateWizardUI();
                if(state.wizardStep === 3) updateReviewSummary();
            } 
        };

        function updateWizardUI() {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            document.getElementById(`step-${state.wizardStep}`).classList.remove('hidden');
            
            // Update step indicator
            const stepTitles = {
                1: 'Select Category',
                2: 'Add Details',
                3: 'Set Priority',
                4: 'Review & Location'
            };
            
            document.getElementById('stepIndicator').innerText = `Step ${state.wizardStep} of 4 - ${stepTitles[state.wizardStep]}`;
            
            // Update progress bar
            const progress = (state.wizardStep / 4) * 100;
            document.getElementById('stepProgress').style.width = `${progress}%`;
            
            // Update buttons
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');
            
            btnBack.classList.toggle('hidden', state.wizardStep === 1);
            btnNext.innerHTML = state.wizardStep === 4 ? 
                'Submit Report <i class="fas fa-paper-plane ml-2"></i>' : 
                'Continue <i class="fas fa-arrow-right ml-2"></i>';
        }

        function updateReviewSummary() {
            const category = document.getElementById('selectedCategory').value;
            const priority = document.getElementById('selectedPriority').value;
            const description = document.getElementById('inpDesc').value;
            const location = document.getElementById('inpLoc').value;
            
            // Count images
            const imageCount = ['inpImg1', 'inpImg2', 'inpImg3'].filter(id => {
                return document.getElementById(id).files.length > 0;
            }).length;
            
            // Update review fields
            document.getElementById('reviewCategory').innerText = category || '-';
            
            document.getElementById('reviewPriority').innerText = priority || '-';
            const priorityColor = priority === 'Critical' ? 'text-red-600' : 
                               priority === 'High' ? 'text-orange-600' : 
                               priority === 'Normal' ? 'text-blue-600' : 'text-green-600';
            document.getElementById('reviewPriority').className = `font-bold ${priorityColor}`;
            
            document.getElementById('reviewImage').innerText = imageCount > 0 ? `${imageCount} image(s) uploaded` : 'No images';
            document.getElementById('reviewLocation').innerText = location ? 'Location selected' : 'Not selected';
            document.getElementById('reviewDescription').innerText = description || 'No description provided';
        }

        // IMAGE HANDLING
        window.previewImage = (input, imgId, phId) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (file.size > maxSize) {
                    showToast('File Too Large', 'Please select an image under 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById(phId).classList.add('hidden');
                    
                    // Simulate AI analysis for main image
                    if(imgId === 'imgPreview1') {
                        simulateAIAnalysis();
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        function simulateAIAnalysis() {
            showToast('AI Analysis', 'Analyzing image content...', 'info');
            
            setTimeout(() => {
                // Simulate AI detection
                const categories = ['Infrastructure', 'Sanitation', 'Safety', 'Transport', 'Utilities'];
                const detectedCat = categories[Math.floor(Math.random() * categories.length)];
                
                // Auto-select detected category
                if(!document.getElementById('selectedCategory').value) {
                    selectCategory(detectedCat);
                }
                
                showToast('AI Analysis Complete', `Detected: ${detectedCat} issue`, 'success');
            }, 1500);
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }

        // SUBMIT REPORT
        window.submitReport = async () => {
            // Gather form data
            const desc = document.getElementById('inpDesc').value.trim();
            const cat = document.getElementById('selectedCategory').value;
            const prio = document.getElementById('selectedPriority').value;
            const locStr = document.getElementById('inpLoc').value;
            const address = document.getElementById('inpAddress').value;
            const landmark = document.getElementById('inpLandmark').value;
            const locationName = document.getElementById('inpLocationName').value;
            const city = document.getElementById('inpCity').value;
            const zipCode = document.getElementById('inpZipCode').value;
            
            // Validation
            if(!locStr) {
                showToast('Location Missing', 'Please select a location on the map', 'error');
                return;
            }
            
            // Update button state
            const submitBtn = document.getElementById('btnNext');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            submitBtn.disabled = true;
            
            // Parse coordinates
            let coords = [40.7128, -74.0060]; // Default NYC
            if(locStr.includes(',')) {
                const parts = locStr.split(',').map(p => parseFloat(p.trim()));
                if(parts.length >= 2) coords = [parts[0], parts[1]];
            }
            
            try {
                // Compress and upload images
                const imagePromises = [];
                const fileInputs = ['inpImg1', 'inpImg2', 'inpImg3'];
                
                for(const inputId of fileInputs) {
                    const input = document.getElementById(inputId);
                    if(input.files.length > 0) {
                        imagePromises.push(compressImage(input.files[0]));
                    }
                }
                
                const images = await Promise.all(imagePromises);
                
                // Prepare report data
                const reportData = {
                    description: desc,
                    category: cat,
                    priority: prio,
                    coords: coords,
                    images: images,
                    address: address || null,
                    landmark: landmark || null,
                    locationName: locationName || null,
                    city: city || 'New York',
                    zipCode: zipCode || null,
                    status: 'Pending',
                    timestamp: Date.now(),
                    createdAt: serverTimestamp(),
                    user: state.name,
                    uid: state.user?.uid || 'anon',
                    upvotes: 0,
                    comments: [],
                    voters: [],
                    department: state.role === 'authority' ? state.department : null,
                    assignedTo: null,
                    resolution: null
                };
                
                // Add to Firestore
                await addDoc(collection(db, `artifacts/${appId}/public/data/reports`), reportData);
                
                showToast('Success', 'Report submitted successfully!', 'success');
                closeModal('reportModal');
                
                // Reset form
                state.wizardStep = 1;
                updateWizardUI();
                
            } catch(e) { 
                console.error('Submit error:', e); 
                showToast('Error', 'Failed to submit report. Please try again.', 'error'); 
            }
            
            // Reset button
            submitBtn.innerHTML = 'Submit Report <i class="fas fa-paper-plane ml-2"></i>';
            submitBtn.disabled = false;
        };

        // COMMENTS SYSTEM
        window.openComments = async (reportId) => {
            document.getElementById('currentReportId').value = reportId;
            document.getElementById('newComment').value = '';
            
            // Load comments
            const report = state.reports.find(r => r.id === reportId);
            if(report && report.comments) {
                displayComments(report.comments);
            } else {
                document.getElementById('commentsList').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-comments text-3xl text-slate-300 mb-3"></i>
                        <p class="text-slate-500">No comments yet</p>
                        <p class="text-sm text-slate-400 mt-1">Be the first to comment</p>
                    </div>
                `;
            }
            
            document.getElementById('commentsModal').classList.remove('hidden');
        };

        window.postComment = async () => {
            const reportId = document.getElementById('currentReportId').value;
            const commentText = document.getElementById('newComment').value.trim();
            
            if(!commentText) return;
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/reports`, reportId), {
                    comments: arrayUnion({
                        user: state.name,
                        text: commentText,
                        timestamp: Date.now(),
                        userRole: state.role,
                        department: state.department || null
                    })
                });
                
                document.getElementById('newComment').value = '';
                showToast('Success', 'Comment added', 'success');
                
                // Refresh comments
                const report = state.reports.find(r => r.id === reportId);
                if(report) {
                    if(!report.comments) report.comments = [];
                    report.comments.push({
                        user: state.name,
                        text: commentText,
                        timestamp: Date.now(),
                        userRole: state.role,
                        department: state.department || null
                    });
                    displayComments(report.comments);
                }
            } catch(e) {
                console.error(e);
                showToast('Error', 'Failed to post comment', 'error');
            }
        };

        function displayComments(comments) {
            if(!comments || comments.length === 0) {
                document.getElementById('commentsList').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-comments text-3xl text-slate-300 mb-3"></i>
                        <p class="text-slate-500">No comments yet</p>
                    </div>
                `;
                return;
            }
            
            const sortedComments = comments.sort((a, b) => b.timestamp - a.timestamp);
            document.getElementById('commentsList').innerHTML = sortedComments.map(comment => `
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-xl ${
                        comment.userRole === 'authority' ? 
                        'bg-gradient-to-r from-purple-500 to-pink-500' : 
                        'bg-gradient-to-r from-blue-500 to-indigo-500'
                    } flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                        ${comment.user[0]}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm text-slate-900">${comment.user}</span>
                                ${comment.userRole === 'authority' ? 
                                    `<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Authority</span>` : 
                                    `<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">Citizen</span>`
                                }
                                ${comment.department ? 
                                    `<span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">${comment.department}</span>` : 
                                    ''
                                }
                            </div>
                            <span class="text-xs text-slate-400">${new Date(comment.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <p class="text-sm text-slate-700 bg-slate-50 rounded-lg p-3">${comment.text}</p>
                    </div>
                </div>
            `).join('');
        }

        // UPVOTE SYSTEM
        window.upvote = async (reportId) => {
            const report = state.reports.find(r => r.id === reportId);
            if(!report) return;
            
            // Check if user already voted
            if(report.voters && report.voters.includes(state.user?.uid)) {
                showToast('Already Voted', 'You can only vote once per report', 'info');
                return;
            }
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/reports`, reportId), {
                    upvotes: increment(1),
                    voters: arrayUnion(state.user?.uid || 'anon')
                });
                showToast('Upvoted!', 'Thanks for your feedback', 'success');
            } catch(e) {
                console.error(e);
                showToast('Error', 'Failed to upvote', 'error');
            }
        };

        // RESOLUTION FLOW
        window.openResolveModal = (reportId) => {
            const report = state.reports.find(r => r.id === reportId);
            if(!report) return;
            
            document.getElementById('resolveId').value = reportId;
            document.getElementById('resNote').value = '';
            document.getElementById('statusSelect').value = report.status === 'Pending' ? 'In Progress' : report.status;
            document.getElementById('resolveDepartment').value = report.department || '';
            document.getElementById('assignedOfficial').value = report.assignedTo || '';
            document.getElementById('resImg').value = '';
            document.getElementById('resImgPreview').classList.add('hidden');
            document.getElementById('resPlaceholder').classList.remove('hidden');
            document.getElementById('resolveModal').classList.remove('hidden');
        };

        window.confirmResolve = async () => {
            const reportId = document.getElementById('resolveId').value;
            const status = document.getElementById('statusSelect').value;
            const note = document.getElementById('resNote').value.trim();
            const department = document.getElementById('resolveDepartment').value;
            const assignedTo = document.getElementById('assignedOfficial').value;
            const fileInput = document.getElementById('resImg');
            const btn = document.getElementById('btnConfirmResolve');
            
            // Validation
            if(status === 'Resolved' && !note) {
                showToast('Required', 'Please add resolution notes', 'error');
                return;
            }
            
            if(status === 'Resolved' && fileInput.files.length === 0) {
                showToast('Proof Required', 'Please upload proof photo for resolution', 'error');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
            btn.disabled = true;
            
            try {
                let proofImage = null;
                if(fileInput.files.length > 0) {
                    proofImage = await compressImage(fileInput.files[0]);
                }
                
                // Prepare update data
                const updateData = {
                    status: status,
                    department: department || null,
                    assignedTo: assignedTo || null,
                    resolution: status === 'Resolved' ? {
                        by: state.name,
                        byDepartment: state.department,
                        note: note,
                        proof: proofImage,
                        at: Date.now(),
                        assignedOfficial: assignedTo
                    } : null
                };
                
                // Update in Firestore
                await updateDoc(doc(db, `artifacts/${appId}/public/data/reports`, reportId), updateData);
                
                // Award XP to reporter if resolved
                if(status === 'Resolved') {
                    const report = state.reports.find(r => r.id === reportId);
                    if(report) {
                        showToast('Issue Resolved!', 'XP awarded to reporter and citizens notified', 'success');
                    }
                } else {
                    showToast('Status Updated', `Issue marked as ${status}`, 'success');
                }
                
                closeModal('resolveModal');
            } catch(e) { 
                console.error(e); 
                showToast('Error', 'Failed to update status', 'error');
            }
            
            btn.innerHTML = 'Update Status & Notify Citizen';
            btn.disabled = false;
        };

        // FEED FUNCTIONS
        window.filterFeed = (filter) => {
            state.currentFilter = filter;
            state.feedPage = 1;
            updateUI();
        };

        window.sortFeed = (sortBy) => {
            let sortedReports = [...state.reports];
            if(sortBy === 'newest') {
                sortedReports.sort((a, b) => b.timestamp - a.timestamp);
            } else if(sortBy === 'oldest') {
                sortedReports.sort((a, b) => a.timestamp - b.timestamp);
            } else if(sortBy === 'votes') {
                sortedReports.sort((a, b) => (b.upvotes || 0) - (a.upvotes || 0));
            } else if(sortBy === 'comments') {
                sortedReports.sort((a, b) => ((b.comments || []).length) - ((a.comments || []).length));
            }
            state.reports = sortedReports;
            state.feedPage = 1;
            updateUI();
        };

        window.loadMoreFeed = () => {
            state.feedPage++;
            updateUI();
        };

        // DATA LISTENER
        function startListener() {
            const q = query(collection(db, `artifacts/${appId}/public/data/reports`), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                state.reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateUI();
            });
        }

        function updateUI() {
            // Calculate stats
            const total = state.reports.length;
            const pending = state.reports.filter(r => r.status === 'Pending').length;
            const resolved = state.reports.filter(r => r.status === 'Resolved').length;
            const inProgress = state.reports.filter(r => r.status === 'In Progress').length;
            const critical = state.reports.filter(r => r.priority === 'Critical').length;
            const assigned = state.reports.filter(r => r.assignedTo).length;
            
            // Update dashboard stats
            document.getElementById('statTotal').innerText = total;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statResolved').innerText = resolved;
            
            // Update quick stats for authorities
            document.getElementById('quickCritical').innerText = critical;
            document.getElementById('quickProgress').innerText = inProgress;
            document.getElementById('quickAssigned').innerText = assigned;
            
            // Update sidebar stats
            document.getElementById('sidebarActive').innerText = pending + inProgress;
            document.getElementById('sidebarResolved').innerText = resolved;
            
            // Calculate user contributions
            const userReports = state.reports.filter(r => r.user === state.name);
            document.getElementById('sidebarContributions').innerText = userReports.length;
            document.getElementById('profileReports').innerText = userReports.length;
            document.getElementById('profileResolved').innerText = userReports.filter(r => r.status === 'Resolved').length;
            
            // Calculate XP and leaderboard
            const users = {};
            state.reports.forEach(r => {
                if(!users[r.user]) {
                    users[r.user] = { 
                        xp: 0, 
                        reports: 0, 
                        resolved: 0,
                        upvotes: 0
                    };
                }
                
                users[r.user].reports += 1;
                users[r.user].xp += 50; // Base XP for report
                
                if(r.status === 'Resolved') {
                    users[r.user].xp += 100;
                    users[r.user].resolved += 1;
                }
                
                if(r.upvotes) {
                    users[r.user].xp += r.upvotes * 10;
                    users[r.user].upvotes += r.upvotes;
                }
                
                if(r.priority === 'Critical') users[r.user].xp += 50;
                if(r.priority === 'High') users[r.user].xp += 25;
            });
            
            // User's XP
            const myXP = users[state.name] ? users[state.name].xp : 0;
            const myLevel = Math.floor(myXP / 500) + 1;
            const xpProgress = ((myXP % 500) / 500) * 100;
            
            document.getElementById('statXP').innerText = myXP;
            document.getElementById('statLevel').innerText = myLevel;
            document.getElementById('xpProgress').style.width = `${xpProgress}%`;
            
            document.getElementById('userXP').innerText = myXP;
            document.getElementById('userLevel').innerText = myLevel;
            document.getElementById('profileXP').innerText = myXP;
            document.getElementById('profileLevel').innerText = myLevel;
            
            // Leaderboard
            const sortedUsers = Object.entries(users)
                .sort((a,b) => b[1].xp - a[1].xp)
                .slice(0, 20);
            
            // Find user's rank
            const userRank = sortedUsers.findIndex(([name]) => name === state.name) + 1;
            document.getElementById('yourRank').innerText = userRank ? `#${userRank}` : '#-';
            document.getElementById('yourPoints').innerText = `${myXP} XP`;
            document.getElementById('profileRank').innerText = userRank ? `#${userRank}` : '#-';
            
            // Update leaderboard list
            document.getElementById('leaderboardList').innerHTML = sortedUsers.map(([name, data], i) => `
                <div class="flex items-center justify-between p-4 hover:bg-slate-50 transition-all ${name === state.name ? 'bg-blue-50' : ''}">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold text-white ${
                            i === 0 ? 'bg-gradient-to-r from-yellow-500 to-orange-500' :
                            i === 1 ? 'bg-gradient-to-r from-slate-400 to-slate-500' :
                            i === 2 ? 'bg-gradient-to-r from-amber-600 to-amber-700' :
                            'bg-gradient-to-r from-blue-500 to-indigo-500'
                        }">
                            ${i < 3 ? ['🥇', '🥈', '🥉'][i] : i + 1}
                        </div>
                        <div class="min-w-0">
                            <div class="font-bold text-slate-900 truncate flex items-center gap-2">
                                ${name} 
                                ${name === state.name ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">You</span>' : ''}
                                ${data.reports > 20 ? '<i class="fas fa-crown text-yellow-500 text-xs"></i>' : ''}
                            </div>
                            <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
                                <span>${data.reports} reports</span>
                                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                                <span>${data.resolved} resolved</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">${data.xp} XP</div>
                        <div class="text-xs text-slate-500">Level ${Math.floor(data.xp / 500) + 1}</div>
                    </div>
                </div>
            `).join('');
            
            // Filter reports for feed
            let filteredReports = [...state.reports];
            if(state.currentFilter !== 'all') {
                filteredReports = filteredReports.filter(r => r.status === state.currentFilter);
            }
            
            // Paginate feed
            const startIdx = (state.feedPage - 1) * state.feedPerPage;
            const endIdx = startIdx + state.feedPerPage;
            const paginatedReports = filteredReports.slice(0, endIdx);
            
            // Update feed
            const feed = document.getElementById('feedContainer');
            feed.innerHTML = paginatedReports.map(r => {
                const isResolved = r.status === 'Resolved';
                const isInProgress = r.status === 'In Progress';
                const commentCount = r.comments ? r.comments.length : 0;
                const upvoteCount = r.upvotes || 0;
                const hasVoted = r.voters && r.voters.includes(state.user?.uid);
                const imageCount = r.images ? r.images.length : 0;
                const timeAgo = getTimeAgo(r.timestamp);
                
                return `
                <div class="feed-card bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden hover:shadow-xl transition-all duration-300">
                    ${isResolved ? `
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span class="text-sm font-bold">RESOLVED</span>
                            <span class="text-xs opacity-90 ml-auto">${r.resolution ? 'by ' + r.resolution.by : ''}</span>
                        </div>
                    ` : ''}
                    ${isInProgress ? `
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-2 flex items-center gap-2">
                            <i class="fas fa-tasks"></i>
                            <span class="text-sm font-bold">IN PROGRESS</span>
                            ${r.assignedTo ? `<span class="text-xs opacity-90 ml-auto">Assigned to ${r.assignedTo}</span>` : ''}
                        </div>
                    ` : ''}
                    
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-lg font-bold">
                                    ${r.user[0]}
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-bold text-slate-900">${r.user}</h4>
                                        ${r.department ? `
                                            <span class="department-badge text-xs">
                                                <i class="fas fa-building"></i> ${r.department}
                                            </span>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-xs font-bold px-2 py-1 rounded ${getPriorityClass(r.priority)}">${r.priority}</span>
                                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">${r.category}</span>
                                        <span class="text-xs text-slate-400">${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                ${state.role === 'authority' ? `
                                    <button onclick="openResolveModal('${r.id}')" class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-bold text-sm hover:opacity-90 transition-opacity">
                                        ${r.status === 'Pending' ? 'Take Action' : 'Update'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <p class="text-slate-700 mb-4 leading-relaxed">${r.description}</p>
                        
                        ${r.images && r.images.length > 0 ? `
                            <div class="mb-4 rounded-xl overflow-hidden grid grid-cols-${Math.min(r.images.length, 3)} gap-2">
                                ${r.images.map((img, idx) => `
                                    <img src="${img}" class="w-full h-48 object-cover cursor-zoom-in hover:scale-105 transition-transform duration-300" 
                                         onclick="window.open('${img}', '_blank')" 
                                         alt="Evidence ${idx + 1}">
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${r.address || r.locationName ? `
                            <div class="mb-4 p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-2 text-sm text-slate-600 mb-1">
                                    <i class="fas fa-map-marker-alt text-blue-500"></i>
                                    <span class="font-semibold">Location:</span>
                                </div>
                                <p class="text-sm text-slate-700">${r.locationName || ''} ${r.address ? `(${r.address})` : ''}</p>
                            </div>
                        ` : ''}
                        
                        ${isResolved && r.resolution ? `
                            <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                    <span class="text-sm font-bold text-green-700">RESOLUTION DETAILS</span>
                                    ${r.resolution.assignedOfficial ? `
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full ml-auto">
                                            Official: ${r.resolution.assignedOfficial}
                                        </span>
                                    ` : ''}
                                </div>
                                <p class="text-sm text-green-800 mb-3">${r.resolution.note}</p>
                                ${r.resolution.proof ? `
                                    <div class="rounded-lg overflow-hidden h-48 border border-green-200">
                                        <img src="${r.resolution.proof}" class="w-full h-full object-cover cursor-zoom-in hover:scale-105 transition-transform" 
                                             onclick="window.open('${r.resolution.proof}', '_blank')">
                                    </div>
                                ` : ''}
                                <div class="text-xs text-green-600 mt-2 flex items-center gap-2">
                                    <span>Resolved by ${r.resolution.by}</span>
                                    <span class="w-1 h-1 bg-green-400 rounded-full"></span>
                                    <span>${new Date(r.resolution.at).toLocaleDateString()}</span>
                                    ${r.resolution.byDepartment ? `
                                        <span class="w-1 h-1 bg-green-400 rounded-full"></span>
                                        <span>${r.resolution.byDepartment}</span>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center border-t border-slate-100 pt-4">
                            <div class="flex items-center gap-4">
                                <button onclick="upvote('${r.id}')" class="flex items-center gap-2 text-sm ${hasVoted ? 'text-blue-600 font-bold' : 'text-slate-500'} hover:text-blue-600 transition-colors group">
                                    <div class="w-8 h-8 rounded-full ${hasVoted ? 'bg-blue-100' : 'bg-slate-100'} group-hover:bg-blue-100 flex items-center justify-center transition-colors">
                                        <i class="fas fa-thumbs-up ${hasVoted ? 'text-blue-600' : ''}"></i>
                                    </div>
                                    <span>${upvoteCount}</span>
                                </button>
                                <button onclick="openComments('${r.id}')" class="flex items-center gap-2 text-sm text-slate-500 hover:text-blue-600 transition-colors group">
                                    <div class="w-8 h-8 rounded-full bg-slate-100 group-hover:bg-blue-100 flex items-center justify-center transition-colors">
                                        <i class="fas fa-comment"></i>
                                    </div>
                                    <span>${commentCount}</span>
                                </button>
                                <button class="flex items-center gap-2 text-sm text-slate-500 hover:text-blue-600 transition-colors group">
                                    <div class="w-8 h-8 rounded-full bg-slate-100 group-hover:bg-blue-100 flex items-center justify-center transition-colors">
                                        <i class="fas fa-share"></i>
                                    </div>
                                    <span>Share</span>
                                </button>
                            </div>
                            <div class="text-xs text-slate-400 flex items-center gap-2">
                                ${r.coords ? `
                                    <i class="fas fa-map-pin"></i>
                                    <span>${r.coords[0].toFixed(4)}, ${r.coords[1].toFixed(4)}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Show load more button if there are more reports
            if(endIdx < filteredReports.length) {
                feed.innerHTML += `
                    <div class="text-center pt-6">
                        <button onclick="loadMoreFeed()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:scale-[1.02] transition-all">
                            <i class="fas fa-sync-alt mr-2"></i> Load More Reports
                        </button>
                    </div>
                `;
            }
            
            // Update mini feed (recent activity)
            const recentReports = state.reports.slice(0, 5);
            document.getElementById('miniFeed').innerHTML = recentReports.map(r => `
                <div class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-xl transition-all cursor-pointer" onclick="switchView('feed')">
                    <div class="w-10 h-10 rounded-lg ${
                        r.priority === 'Critical' ? 'bg-gradient-to-r from-red-500 to-pink-500' :
                        r.priority === 'High' ? 'bg-gradient-to-r from-orange-500 to-red-500' :
                        'bg-gradient-to-r from-blue-500 to-indigo-500'
                    } flex items-center justify-center text-white text-sm font-bold">
                        ${r.user[0]}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-semibold text-slate-900 truncate">${r.description.substring(0, 60)}${r.description.length > 60 ? '...' : ''}</div>
                        <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
                            <span>${r.category}</span>
                            <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                            <span class="${
                                r.status === 'Resolved' ? 'text-green-500' : 
                                r.status === 'In Progress' ? 'text-yellow-500' : 
                                'text-red-500'
                            } font-semibold">${r.status}</span>
                            <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                            <span>${getTimeAgo(r.timestamp)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update user activity
            const userActivities = state.reports.filter(r => r.user === state.name);
            document.getElementById('userActivity').innerHTML = userActivities.slice(0, 5).map(r => `
                <div class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg transition-all">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm ${
                        r.status === 'Resolved' ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 
                        r.status === 'In Progress' ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : 
                        'bg-gradient-to-r from-blue-500 to-indigo-500'
                    }">
                        <i class="fas ${
                            r.category === 'Infrastructure' ? 'fa-road' :
                            r.category === 'Sanitation' ? 'fa-trash' :
                            r.category === 'Safety' ? 'fa-shield-alt' :
                            r.category === 'Transport' ? 'fa-bus' :
                            r.category === 'Utilities' ? 'fa-bolt' : 'fa-ellipsis-h'
                        }"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-slate-900 truncate">${r.description.substring(0, 70)}${r.description.length > 70 ? '...' : ''}</div>
                        <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
                            <span>${getTimeAgo(r.timestamp)}</span>
                            <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                            <span class="${
                                r.status === 'Resolved' ? 'text-green-500' : 
                                r.status === 'In Progress' ? 'text-yellow-500' : 
                                'text-slate-500'
                            } font-semibold">${r.status}</span>
                        </div>
                    </div>
                    <div class="text-xs font-bold ${
                        r.priority === 'Critical' ? 'text-red-600' : 
                        r.priority === 'High' ? 'text-orange-600' : 
                        'text-blue-600'
                    }">
                        ${r.priority}
                    </div>
                </div>
            `).join('');
            
            // Update assignments table for authorities
            if(state.role === 'authority') {
                const departmentReports = state.reports.filter(r => r.department === state.department);
                const pendingAssignments = departmentReports.filter(r => r.status === 'Pending').length;
                const inProgressAssignments = departmentReports.filter(r => r.status === 'In Progress').length;
                const completedAssignments = departmentReports.filter(r => r.status === 'Resolved').length;
                
                document.getElementById('assignPending').innerText = pendingAssignments;
                document.getElementById('assignProgress').innerText = inProgressAssignments;
                document.getElementById('assignCompleted').innerText = completedAssignments;
                
                // Update assignments table
                const assignmentsTable = document.getElementById('assignmentsTable');
                if(assignmentsTable) {
                    assignmentsTable.innerHTML = departmentReports.slice(0, 10).map(r => `
                        <tr class="hover:bg-slate-50">
                            <td class="p-4">
                                <div class="font-medium text-slate-900">${r.category}</div>
                                <div class="text-xs text-slate-500 truncate max-w-xs">${r.description.substring(0, 50)}...</div>
                            </td>
                            <td class="p-4">
                                <span class="text-xs font-bold px-2 py-1 rounded ${getPriorityClass(r.priority)}">${r.priority}</span>
                            </td>
                            <td class="p-4 text-sm text-slate-700">${r.department || 'Unassigned'}</td>
                            <td class="p-4 text-sm text-slate-700">${r.assignedTo || '-'}</td>
                            <td class="p-4">
                                <span class="text-xs font-bold px-2 py-1 rounded ${
                                    r.status === 'Resolved' ? 'bg-green-100 text-green-800' :
                                    r.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                                }">${r.status}</span>
                            </td>
                            <td class="p-4">
                                <button onclick="openResolveModal('${r.id}')" class="text-xs bg-blue-500 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-blue-600 transition-colors">
                                    ${r.status === 'Pending' ? 'Assign' : 'Update'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
            
            // Update markers on map
            updateMarkers();
            
            // Update charts
            updateCharts();
        }

        // CHARTS
        let lineChart, pieChart;
        function updateCharts() {
            // Line Chart - Weekly Activity
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const data1 = new Array(7).fill(0);
            
            // Get reports from last 7 days
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentReports = state.reports.filter(r => r.timestamp > oneWeekAgo);
            
            recentReports.forEach(r => {
                const day = new Date(r.timestamp).getDay();
                // Adjust for Monday start (getDay() returns 0 for Sunday)
                const adjustedDay = day === 0 ? 6 : day - 1;
                data1[adjustedDay] += 1;
            });
            
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx1, {
                type: 'line',
                data: { 
                    labels: days, 
                    datasets: [{ 
                        label: 'Reports Submitted', 
                        data: data1, 
                        borderColor: '#3b82f6', 
                        backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#475569',
                            borderWidth: 1,
                            cornerRadius: 8
                        }
                    }, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { 
                                color: 'rgba(226, 232, 240, 0.5)',
                                borderDash: [4, 4]
                            },
                            ticks: { 
                                stepSize: 1,
                                color: '#64748b'
                            }
                        }, 
                        x: { 
                            grid: { 
                                display: false 
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        } 
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                } 
            });

            // Pie Chart - Categories
            const ctx2 = document.getElementById('pieChart').getContext('2d');
            const cats = {};
            state.reports.forEach(r => { 
                cats[r.category] = (cats[r.category] || 0) + 1; 
            });
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
            
            if(pieChart) pieChart.destroy();
            pieChart = new Chart(ctx2, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(cats), 
                    datasets: [{ 
                        data: Object.values(cats),
                        backgroundColor: colors.slice(0, Object.keys(cats).length),
                        borderWidth: 0,
                        hoverOffset: 15,
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#ffffff'
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'right',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                color: '#64748b',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%'
                } 
            });
        }

        // UTILITY FUNCTIONS
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minute = 60 * 1000;
            const hour = 60 * minute;
            const day = 24 * hour;
            const week = 7 * day;
            const month = 30 * day;
            
            if (diff < minute) {
                return 'Just now';
            } else if (diff < hour) {
                const minutes = Math.floor(diff / minute);
                return `${minutes}m ago`;
            } else if (diff < day) {
                const hours = Math.floor(diff / hour);
                return `${hours}h ago`;
            } else if (diff < week) {
                const days = Math.floor(diff / day);
                return `${days}d ago`;
            } else if (diff < month) {
                const weeks = Math.floor(diff / week);
                return `${weeks}w ago`;
            } else {
                return new Date(timestamp).toLocaleDateString();
            }
        }

        // TOAST NOTIFICATION
        function showToast(title, msg, type='info') {
            const t = document.getElementById('toast');
            document.getElementById('toastTitle').innerText = title;
            document.getElementById('toastMsg').innerText = msg;
            
            const icon = document.getElementById('toastIcon');
            const colors = {
                'success': {bg: 'from-green-500 to-emerald-500', icon: 'fa-check-circle'},
                'error': {bg: 'from-red-500 to-pink-500', icon: 'fa-exclamation-circle'},
                'warning': {bg: 'from-yellow-500 to-orange-500', icon: 'fa-exclamation-triangle'},
                'info': {bg: 'from-blue-500 to-purple-500', icon: 'fa-info-circle'}
            };
            
            const config = colors[type] || colors.info;
            icon.className = `w-10 h-10 rounded-full bg-gradient-to-r ${config.bg} flex items-center justify-center text-white`;
            icon.innerHTML = `<i class="fas ${config.icon}"></i>`;
            
            t.style.borderLeftColor = type === 'success' ? '#10b981' : 
                                     type === 'error' ? '#ef4444' : 
                                     type === 'warning' ? '#f59e0b' : '#3b82f6';
            
            t.classList.remove('translate-x-[200%]');
            
            // Auto hide after 4 seconds
            setTimeout(hideToast, 4000);
        }

        function hideToast() {
            document.getElementById('toast').classList.add('translate-x-[200%]');
        }

        // INITIALIZE
        initAuth();
        
        // Auto demo login (remove in production)
        setTimeout(() => {
            if(document.getElementById('entryScreen').classList.contains('fixed')) {
                // Auto-select citizen for demo
                selectUserType('citizen');
                setTimeout(() => {
                    document.getElementById('loginName').value = 'Demo User';
                    setRole('citizen');
                    handleLogin();
                }, 500);
            }
        }, 500);
        
        // Character count for description
        document.getElementById('inpDesc').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('charCount').innerText = `${count}/500`;
        });
    </script>
</body>
</html>

//9781258745
//93665-41044

